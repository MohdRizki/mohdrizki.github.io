<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sinesia Pro - Sistem Evaluasi Siswa</title>
    
    <!-- Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Tinos:wght@400;700&display=swap" rel="stylesheet"> 
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { 
                        sans: ['"Plus Jakarta Sans"', 'sans-serif'],
                        serif: ['"Tinos"', 'serif']
                    },
                    colors: {
                        slate: { 50: '#f8fafc', 100: '#f1f5f9', 200: '#e2e8f0', 300: '#cbd5e1', 400: '#94a3b8', 500: '#64748b', 600: '#475569', 800: '#1e293b', 900: '#0f172a' },
                        // Brand MERAH (Red)
                        brand: { 50: '#fef2f2', 100: '#fee2e2', 500: '#ef4444', 600: '#dc2626', 700: '#b91c1c' },
                    }
                }
            }
        }
    </script>
    
    <style>
        body { background-color: #f8fafc; color: #1e293b; overflow: hidden; font-family: 'Plus Jakarta Sans', sans-serif; font-size: 13px; line-height: 1.5; }
        
        /* Components */
        .card-super { background: white; border-radius: 2rem; border: 1px solid #f1f5f9; box-shadow: 0 20px 25px -5px rgba(226, 232, 240, 0.5); }
        .card-sm { background: white; border-radius: 1rem; border: 1px solid #f1f5f9; transition: all 0.2s; cursor: pointer; }
        .card-sm:hover { border-color: #fee2e2; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.05); transform: translateY(-2px); }
        
        .btn-sijuru { 
            background-color: #dc2626; color: white; 
            padding: 0.75rem 1.5rem; border-radius: 0.75rem; 
            font-weight: 800; text-transform: uppercase; font-size: 11px; letter-spacing: 0.05em;
            box-shadow: 0 4px 6px -1px rgba(220, 38, 38, 0.2);
            transition: all 0.2s; display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem;
            border: none; cursor: pointer;
        }
        .btn-sijuru:hover { transform: scale(1.02); background-color: #b91c1c; }
        .btn-sijuru:active { transform: scale(0.98); }

        .btn-icon {
            width: 2.5rem; height: 2.5rem; border-radius: 0.75rem;
            display: flex; align-items: center; justify-content: center;
            background-color: white; color: #64748b; border: 1px solid #f1f5f9;
            transition: all 0.2s; cursor: pointer;
        }
        .btn-icon:hover { background-color: #fef2f2; color: #dc2626; border-color: #fee2e2; }

        .input-sijuru {
            width: 100%; background-color: #f8fafc; border-radius: 0.75rem;
            padding: 0.75rem 1rem; font-weight: 700; outline: none; border: 2px solid transparent;
            font-size: 13px; color: #1e293b; transition: all 0.2s; 
        }
        .input-sijuru:focus { background-color: white; border-color: #fee2e2; box-shadow: 0 0 0 4px rgba(254, 226, 226, 0.3); }
        .input-sijuru:disabled { background-color: #f1f5f9; color: #94a3b8; }

        /* Typography */
        .h-big { font-size: 2rem; font-weight: 900; letter-spacing: -0.05em; line-height: 1.1; color: #1e293b; }
        .h-card { font-size: 1.1rem; font-weight: 800; text-transform: uppercase; color: #1e293b; letter-spacing: -0.02em; }
        .label-xs { font-size: 10px; font-weight: 800; text-transform: uppercase; letter-spacing: 0.1em; color: #94a3b8; } 

        /* Tables */
        .table-sijuru { width: 100%; border-collapse: separate; border-spacing: 0; }
        .table-sijuru th { background: #f8fafc; color: #64748b; font-weight: 800; font-size: 10px; text-transform: uppercase; letter-spacing: 0.05em; padding: 1rem; text-align: center; border: 1px solid #f1f5f9; position: sticky; top: 0; z-index: 10; }
        .table-sijuru td { border: 1px solid #f1f5f9; font-size: 13px; font-weight: 600; color: #1e293b; padding: 0; height: 3rem; } 
        .table-sijuru tr:hover td { background-color: #fef2f2; }
        
        .cell-input { width: 100%; height: 100%; text-align: center; background: transparent; outline: none; font-weight: 700; }
        .cell-input:focus { background: white; box-shadow: inset 0 0 0 2px #dc2626; }

        /* Utils */
        .fade-in { animation: fadeIn 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .custom-scroll::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: transparent; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        .custom-scroll::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        .loader { width: 24px; height: 24px; border: 3px solid rgba(220, 38, 38, 0.2); border-radius: 50%; border-top-color: #dc2626; animation: spin 0.8s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
    
    <!-- GLOBAL UI HELPERS -->
    <script>
        window.showView = function(id) { 
            document.querySelectorAll('[id^="view-"]').forEach(el => el.classList.add('hidden')); 
            const target = document.getElementById(`view-${id}`);
            if(target) target.classList.remove('hidden'); 
            if(window.lucide) window.lucide.createIcons(); 
        };

        window.toast = function(msg, type='success') {
            const el = document.getElementById('toast');
            if(!el) return;
            document.getElementById('toast-msg').textContent = msg;
            const icon = el.querySelector('i');
            if(icon && window.lucide) icon.setAttribute('data-lucide', type === 'error' ? 'alert-triangle' : 'check');
            if(window.lucide) window.lucide.createIcons();
            el.classList.remove('opacity-0', '-translate-y-4');
            el.classList.add('opacity-100', 'translate-y-0');
            setTimeout(() => { el.classList.add('opacity-0', '-translate-y-4'); el.classList.remove('opacity-100', 'translate-y-0'); }, 3000);
        };

        window.openConfirm = function(msg, onYes) {
            const overlay = document.getElementById('modal-overlay');
            overlay.innerHTML = `<div class="bg-white rounded-[1.5rem] w-full max-w-sm p-8 text-center shadow-2xl fade-in mx-4"><div class="w-14 h-14 bg-rose-50 rounded-full flex items-center justify-center mx-auto mb-4 text-rose-600"><i data-lucide="alert-circle" class="w-6 h-6"></i></div><h3 class="text-lg font-black text-slate-800 mb-2">Konfirmasi</h3><p class="text-xs font-bold text-slate-400 mb-8 leading-relaxed">${msg}</p><div class="grid grid-cols-2 gap-3"><button onclick="document.getElementById('modal-overlay').classList.add('hidden')" class="py-3 rounded-xl font-black text-[10px] uppercase tracking-widest bg-slate-50 text-slate-500 hover:bg-slate-100">Batal</button><button id="btn-confirm-yes" class="py-3 rounded-xl font-black text-[10px] uppercase tracking-widest bg-brand-600 text-white shadow-lg shadow-brand-200 hover:bg-brand-700">Ya, Proses</button></div></div>`;
            const yesBtn = document.getElementById('btn-confirm-yes');
            if(yesBtn) yesBtn.onclick = () => { onYes(); document.getElementById('modal-overlay').classList.add('hidden'); };
            overlay.classList.remove('hidden'); 
            if(window.lucide) window.lucide.createIcons();
        };

        window.handleKey = function(e, idx, col) {
            if(e.key === 'Enter' || e.key === 'ArrowDown') {
                e.preventDefault();
                const next = document.getElementById(`cell-${idx+1}-${col}`);
                if(next) { next.focus(); next.select(); }
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                const prev = document.getElementById(`cell-${idx-1}-${col}`);
                if(prev) { prev.focus(); prev.select(); }
            }
        };

        window.logout = function() { window.location.reload(); }
    </script>
</head>
<body class="h-screen w-screen flex flex-col bg-slate-50 font-sans text-[13px]">

    <!-- Toast -->
    <div id="toast" class="fixed top-6 left-1/2 -translate-x-1/2 z-[9999] opacity-0 pointer-events-none transition-all duration-300 transform -translate-y-4">
        <div class="bg-slate-800 text-white px-6 py-3 rounded-2xl shadow-2xl flex items-center gap-4 min-w-[300px]">
            <div class="w-8 h-8 bg-slate-700 rounded-full flex items-center justify-center text-emerald-400 shrink-0"><i id="toast-icon" data-lucide="check" class="w-4 h-4"></i></div>
            <div><p class="text-[9px] font-black uppercase tracking-widest text-slate-400 mb-0.5">Sinesia Pro</p><span id="toast-msg" class="font-bold text-xs">Notification</span></div>
        </div>
    </div>

    <!-- Modal Overlay -->
    <div id="modal-overlay" class="hidden fixed inset-0 z-[5000] bg-slate-900/40 backdrop-blur-md flex items-center justify-center p-4 fade-in"></div>

    <!-- 1. LOGIN (REVERTED TO ROUNDED-[3rem], BORDER, OVERFLOW-HIDDEN) -->
    <div id="view-login" class="fixed inset-0 z-[100] bg-slate-50 flex flex-col items-center justify-center p-6">
        <!-- Container Utama -->
        <div class="w-full max-w-sm">
            
            <!-- Kartu Login -->
            <div class="bg-white p-8 md:p-12 rounded-[2.5rem] md:rounded-[3rem] shadow-2xl text-center border fade-in relative overflow-hidden mb-6">
                
                <!-- Aksen Garis Merah -->
                <div class="absolute top-0 left-0 w-full h-2 bg-brand-600"></div>

                <!-- Ikon Kunci -->
                <div class="w-20 h-20 bg-brand-50 text-brand-600 rounded-3xl flex items-center justify-center text-3xl mx-auto mb-8 shadow-inner text-center">
                    <i data-lucide="key"></i>
                </div>

                <!-- Judul -->
                <h2 class="text-2xl font-black mb-1 uppercase tracking-tighter leading-none text-center text-slate-800">
                    Login <span class="text-brand-600">SINESIA</span>
                </h2>
                <p class="text-[9px] text-slate-400 font-bold uppercase tracking-widest mb-10 text-center">
                    MASUKKAN KODE AKSES ANDA!
                </p>

                <!-- Form -->
                <form id="login-form" class="space-y-6">
                    <!-- Input Dots (Left Aligned with Indent) -->
                    <input 
                        type="password" 
                        id="login-code" 
                        maxlength="6" 
                        inputmode="numeric" 
                        placeholder="••••••" 
                        autocomplete="new-password" 
                        autofocus 
                        class="w-full bg-slate-50 rounded-xl py-6 text-left text-4xl font-black tracking-[0.5em] indent-[0.5em] border-2 border-transparent focus:border-brand-100 outline-none transition-all placeholder:tracking-[0.5em] placeholder:indent-[0.5em] text-slate-800"
                    >
                    
                    <button type="submit" class="w-full bg-brand-600 text-white py-5 rounded-2xl font-black uppercase text-[11px] tracking-widest shadow-xl text-center hover:bg-brand-700 transition-all flex items-center justify-center gap-2">
                        Buka Sistem <i data-lucide="arrow-right" class="w-3 h-3"></i>
                    </button>
                </form>
            </div>

            <!-- Footer Kredit -->
            <div class="text-center opacity-60 fade-in" style="animation-delay: 0.2s">
                <p class="text-[10px] font-bold text-slate-400 mb-1">Powered by ReezApps</p>
                <p class="text-[10px] font-bold text-slate-400">Mohamad Rizki, S.Pd., Gr.</p>
            </div>

        </div>
    </div>

    <!-- 2. CLASSES -->
    <div id="view-classes" class="hidden fixed inset-0 z-[90] bg-slate-50 flex flex-col items-center justify-center p-6 overflow-y-auto">
        <div class="w-full max-w-5xl space-y-8 fade-in py-10">
            <div class="flex justify-between items-center px-2">
                <div class="flex items-center gap-4 bg-white px-5 py-2.5 rounded-2xl shadow-sm border border-slate-100">
                    <div class="w-10 h-10 rounded-xl bg-brand-50 text-brand-600 flex items-center justify-center"><i data-lucide="user" class="w-5 h-5"></i></div>
                    <div><p class="label-xs mb-0.5">Pengajar</p><h4 class="font-black text-slate-800 text-sm" id="teacher-name-display">Guru</h4></div>
                </div>
                <button onclick="window.logout()" class="btn-icon text-rose-500 hover:bg-rose-50 hover:text-rose-600 hover:border-rose-100"><i data-lucide="log-out" class="w-5 h-5"></i></button>
            </div>
            <div class="text-center py-6"><h2 class="h-big mb-2">Pilih Kelas</h2><p class="text-slate-500 font-bold">Silahkan pilih kelas untuk memulai sesi penilaian</p></div>
            <div id="class-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
        </div>
    </div>

    <!-- 3. MAIN MENU (Dashboard) -->
    <div id="view-main-menu" class="hidden fixed inset-0 z-[80] bg-slate-50 flex flex-col p-4 md:p-8 overflow-y-auto">
        <div class="max-w-5xl mx-auto w-full space-y-8 fade-in py-4">
            <div class="flex items-center justify-between">
                <button onclick="window.showView('classes')" class="text-slate-400 hover:text-slate-800 font-bold text-xs uppercase tracking-widest flex items-center gap-2 group"><i data-lucide="arrow-left" class="w-4 h-4 group-hover:-translate-x-1 transition-transform"></i> Kembali</button>
                <button onclick="window.openSettings()" class="btn-sijuru bg-slate-800 hover:bg-slate-700 shadow-slate-300/50"><i data-lucide="settings" class="w-4 h-4"></i> Pengaturan</button>
            </div>
            
            <div class="flex items-center gap-4">
                <div class="w-14 h-14 bg-white rounded-2xl flex items-center justify-center shadow-sm border border-slate-100 text-brand-600"><i data-lucide="grid" class="w-6 h-6"></i></div>
                <div><h2 class="text-3xl font-black text-slate-900 uppercase tracking-tight">Menu Utama</h2><p class="text-brand-600 font-black text-sm uppercase tracking-widest mt-1" id="main-menu-class-label">Kelas -</p></div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <!-- Semester -->
                <div class="card-super p-8 space-y-6">
                    <div class="flex items-center justify-between"><h3 class="h-card">Semester</h3><span class="bg-brand-50 text-brand-600 px-3 py-1 rounded-lg text-[9px] font-black uppercase">Sumatif</span></div>
                    <div class="space-y-3">
                        <button onclick="window.selectAssessment('asts')" class="w-full bg-slate-50 p-5 rounded-2xl flex items-center gap-5 hover:bg-white hover:shadow-lg hover:shadow-slate-200/50 hover:scale-[1.01] transition-all group border border-transparent hover:border-slate-100">
                            <div class="w-12 h-12 bg-white rounded-xl flex items-center justify-center text-brand-600 shadow-sm"><i data-lucide="bar-chart-2" class="w-5 h-5"></i></div>
                            <div class="text-left"><h4 class="font-black text-slate-800">ASTS</h4><p class="label-xs">Tengah Semester</p></div>
                        </button>
                        <button onclick="window.selectAssessment('asas')" class="w-full bg-slate-50 p-5 rounded-2xl flex items-center gap-5 hover:bg-white hover:shadow-lg hover:shadow-slate-200/50 hover:scale-[1.01] transition-all group border border-transparent hover:border-slate-100">
                            <div class="w-12 h-12 bg-white rounded-xl flex items-center justify-center text-slate-600 shadow-sm"><i data-lucide="layers" class="w-5 h-5"></i></div>
                            <div class="text-left"><h4 class="font-black text-slate-800">ASAS</h4><p class="label-xs">Akhir Semester</p></div>
                        </button>
                    </div>
                </div>
                <!-- Harian -->
                <div class="card-super p-8 space-y-6">
                    <div class="flex items-center justify-between"><h3 class="h-card">Harian</h3><span class="bg-emerald-50 text-emerald-600 px-3 py-1 rounded-lg text-[9px] font-black uppercase">Formatif</span></div>
                    <div class="space-y-3">
                        <button onclick="window.startDailyFlow('harian')" class="w-full bg-slate-50 p-5 rounded-2xl flex items-center gap-5 hover:bg-white hover:shadow-lg hover:shadow-slate-200/50 hover:scale-[1.01] transition-all group border border-transparent hover:border-slate-100">
                            <div class="w-12 h-12 bg-white rounded-xl flex items-center justify-center text-emerald-600 shadow-sm"><i data-lucide="pen-tool" class="w-5 h-5"></i></div>
                            <div class="text-left"><h4 class="font-black text-slate-800">Input Nilai</h4><p class="label-xs">Jurnal Harian</p></div>
                        </button>
                        <button onclick="window.showArchives()" class="w-full bg-slate-50 p-5 rounded-2xl flex items-center gap-5 hover:bg-white hover:shadow-lg hover:shadow-slate-200/50 hover:scale-[1.01] transition-all group border border-transparent hover:border-slate-100">
                            <div class="w-12 h-12 bg-white rounded-xl flex items-center justify-center text-slate-400 shadow-sm"><i data-lucide="archive" class="w-5 h-5"></i></div>
                            <div class="text-left"><h4 class="font-black text-slate-800">Arsip Data</h4><p class="label-xs">Riwayat Tersimpan</p></div>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 4. SEMESTER APP UI -->
    <div id="view-app-semester" class="hidden h-full flex flex-col md:flex-row bg-slate-50">
        <aside class="w-72 bg-white border-r border-slate-100 flex flex-col z-20 shadow-xl shadow-slate-200/50 shrink-0 m-4 rounded-[2rem] overflow-hidden">
            <div class="p-8 pb-6 flex items-center gap-4 border-b border-slate-50">
                <div class="w-10 h-10 bg-brand-600 rounded-xl flex items-center justify-center text-white shadow-lg shadow-brand-200"><i data-lucide="grid" class="w-5 h-5"></i></div>
                <div><h1 class="font-black text-slate-800 text-lg tracking-tight">Sinesia</h1><p class="label-xs">Semester App</p></div>
            </div>
            <nav class="flex-1 px-4 py-4 space-y-2 overflow-y-auto custom-scroll" id="semester-nav"></nav>
            <div class="p-6 mt-auto border-t border-slate-50">
                <button onclick="window.showView('main-menu')" class="w-full bg-slate-50 text-slate-500 py-4 rounded-xl font-black uppercase text-[10px] tracking-widest hover:bg-slate-100 transition-colors flex items-center justify-center gap-2"><i data-lucide="arrow-left" class="w-3 h-3"></i> Menu Utama</button>
            </div>
        </aside>
        <main class="flex-1 flex flex-col h-full min-w-0 relative p-4 pl-0">
            <header class="h-24 px-8 flex items-center justify-between shrink-0 bg-transparent">
                <div><h2 id="page-title" class="h-big">Dashboard</h2><p id="page-subtitle" class="label-xs text-brand-600 mt-1"></p></div>
                <div class="flex items-center gap-3">
                     <button onclick="window.openMapelConfig()" class="btn-icon bg-white shadow-sm" title="Config"><i data-lucide="sliders-horizontal" class="w-5 h-5"></i></button>
                </div>
            </header>
            <div id="content-area" class="flex-1 overflow-auto px-4 pb-4 custom-scroll"></div>
        </main>
    </div>

    <!-- 5. DAILY MAPEL -->
    <div id="view-daily-mapel" class="hidden fixed inset-0 z-[70] bg-slate-50 flex flex-col items-center justify-center p-6">
        <div class="w-full max-w-5xl fade-in h-full flex flex-col">
            <div class="shrink-0 py-8 flex items-center justify-between">
                <button onclick="window.showView('main-menu')" class="btn-icon"><i data-lucide="arrow-left" class="w-4 h-4"></i></button>
                <div class="text-center"><h2 class="h-big">Pilih Mapel</h2><p class="label-xs mt-1">Penilaian Harian</p></div>
                <div class="w-10"></div>
            </div>
            <div id="daily-mapel-grid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6 overflow-y-auto pb-10 custom-scroll px-2"></div>
        </div>
    </div>

    <!-- 6. DAILY CONFIG -->
    <div id="view-daily-setup" class="hidden fixed inset-0 z-[75] bg-slate-900/40 backdrop-blur-md flex items-center justify-center p-4">
        <div class="card-super w-full max-w-lg p-8 fade-in relative">
            <button onclick="window.showView('daily-mapel')" class="absolute top-6 right-6 text-slate-300 hover:text-slate-600"><i data-lucide="x"></i></button>
            <div class="mb-8"><label class="label-xs text-brand-500 mb-1 block">Konfigurasi</label><h3 class="h-big" id="daily-setup-title">Mapel</h3></div>
            <div class="space-y-6">
                <div>
                    <label class="label-xs mb-3 block">Jenis Penilaian</label>
                    <div class="grid grid-cols-2 gap-4">
                        <label class="cursor-pointer group"><input type="radio" name="jenis" value="sumatif_harian" class="peer sr-only" checked onchange="window.setDailyType(this.value)"><div class="p-4 rounded-2xl bg-slate-50 border-2 border-transparent text-center group-hover:bg-slate-100 peer-checked:bg-white peer-checked:border-brand-500 peer-checked:shadow-xl peer-checked:text-brand-600 transition-all"><span class="font-black text-xs uppercase">Sumatif</span></div></label>
                        <label class="cursor-pointer group"><input type="radio" name="jenis" value="formatif_harian" class="peer sr-only" onchange="window.setDailyType(this.value)"><div class="p-4 rounded-2xl bg-slate-50 border-2 border-transparent text-center group-hover:bg-slate-100 peer-checked:bg-white peer-checked:border-emerald-500 peer-checked:shadow-xl peer-checked:text-emerald-600 transition-all"><span class="font-black text-xs uppercase">Formatif</span></div></label>
                    </div>
                </div>
                <div id="tp-info" class="hidden p-4 bg-brand-50 text-brand-700 rounded-2xl text-xs font-medium border border-brand-100 flex flex-col gap-4">
                    <div class="flex items-start gap-4">
                        <i data-lucide="info" class="w-5 h-5 shrink-0 mt-0.5"></i>
                        <p>Mode Formatif menggunakan matriks: Lingkup Materi (LM) dan Tujuan Pembelajaran (TP).</p>
                    </div>
                    <button onclick="window.openTPReference()" class="w-full py-2.5 bg-white border border-brand-200 text-brand-600 rounded-xl text-[10px] font-black uppercase tracking-widest hover:bg-brand-50 transition-colors flex items-center justify-center gap-2"><i data-lucide="book-open" class="w-4 h-4"></i> Lihat Referensi TP (Sijuru)</button>
                </div>
                <div>
                    <label class="label-xs mb-3 block">Teknik</label>
                    <div class="flex gap-3">
                        <label class="flex-1 cursor-pointer"><input type="radio" name="teknik" value="Tertulis" class="peer sr-only" checked><div class="py-3 rounded-xl bg-slate-50 text-center font-bold text-[10px] uppercase text-slate-400 peer-checked:bg-slate-800 peer-checked:text-white transition-all">Tertulis</div></label>
                        <label class="flex-1 cursor-pointer"><input type="radio" name="teknik" value="Praktek" class="peer sr-only"><div class="py-3 rounded-xl bg-slate-50 text-center font-bold text-[10px] uppercase text-slate-400 peer-checked:bg-slate-800 peer-checked:text-white transition-all">Praktek</div></label>
                        <label class="flex-1 cursor-pointer"><input type="radio" name="teknik" value="Proyek" class="peer sr-only"><div class="py-3 rounded-xl bg-slate-50 text-center font-bold text-[10px] uppercase text-slate-400 peer-checked:bg-slate-800 peer-checked:text-white transition-all">Proyek</div></label>
                    </div>
                </div>
                <div class="pt-6 flex gap-4">
                     <button onclick="window.resetDraft()" class="w-1/3 py-4 rounded-2xl font-black uppercase text-[10px] tracking-widest bg-slate-50 text-slate-400 hover:bg-slate-100">Reset</button>
                     <button onclick="window.startDailyInput()" class="btn-sijuru flex-1 text-sm shadow-brand-300/50">Mulai Input</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 7. DAILY INPUT -->
    <div id="view-daily-input" class="hidden fixed inset-0 z-[80] bg-slate-50 flex flex-col fade-in">
        <header class="bg-white/80 backdrop-blur-md p-4 md:p-6 shrink-0 z-30 m-4 mb-0 rounded-[2rem] border border-white shadow-sm">
            <div class="flex flex-col md:flex-row justify-between items-center gap-4">
                <div class="flex items-center gap-6 w-full md:w-auto">
                    <button onclick="window.showView('daily-setup')" class="btn-icon bg-white border border-slate-100"><i data-lucide="arrow-left" class="w-5 h-5 text-slate-800"></i></button>
                    <div><h2 class="text-xl font-black text-slate-900 uppercase leading-none" id="daily-input-title">Mapel</h2><div class="flex items-center gap-3 mt-1.5"><span id="daily-input-meta" class="label-xs text-brand-600 bg-brand-50 px-2 py-0.5 rounded-md">Sumatif</span><span id="daily-input-tech" class="label-xs text-slate-400">Tertulis</span></div></div>
                </div>
                <div class="flex gap-3 items-center w-full md:w-auto justify-end">
                    <div class="relative group mr-2 flex-1 md:flex-none">
                        <i data-lucide="search" class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400"></i>
                        <input type="text" id="student-search" placeholder="Cari Siswa..." oninput="window.handleSearch(this.value)" class="pl-9 pr-4 py-3 rounded-xl bg-slate-50 border border-transparent focus:bg-white focus:border-brand-200 outline-none text-xs font-bold w-full md:w-48 transition-all">
                    </div>
                    
                    <!-- DOWNLOAD GROUP -->
                    <div class="flex bg-slate-100 rounded-xl p-1 gap-1">
                        <!-- PDF DOWNLOAD -->
                        <button onclick="window.printDailyReport()" class="w-9 h-9 flex items-center justify-center rounded-lg hover:bg-white hover:shadow-sm text-slate-500 hover:text-rose-600 transition-all" title="Download PDF Laporan"><i data-lucide="file-text" class="w-4 h-4"></i></button>
                        <!-- CSV DOWNLOAD -->
                        <button onclick="window.downloadDaily('csv')" class="w-9 h-9 flex items-center justify-center rounded-lg hover:bg-white hover:shadow-sm text-slate-500 hover:text-emerald-600 transition-all" title="Excel/CSV"><i data-lucide="sheet" class="w-4 h-4"></i></button>
                        <!-- TEMPLATE DOWNLOAD (NOW PDF) -->
                        <button onclick="window.downloadDaily('template_pdf')" class="w-9 h-9 flex items-center justify-center rounded-lg hover:bg-white hover:shadow-sm text-slate-500 hover:text-blue-600 transition-all" title="Download Template Kosong (PDF)"><i data-lucide="table" class="w-4 h-4"></i></button>
                    </div>
                    
                    <div class="h-8 w-px bg-slate-200 mx-2"></div>
                    
                    <button onclick="window.addLM()" id="btn-add-lm" class="hidden btn-icon bg-emerald-50 text-emerald-600 border-emerald-100 hover:bg-emerald-100"><i data-lucide="plus" class="w-5 h-5"></i></button>
                    <button onclick="window.saveDraft()" class="btn-icon bg-white text-slate-500 hover:text-brand-600" title="Simpan Draft"><i data-lucide="save" class="w-5 h-5"></i></button>
                    <button onclick="window.saveToArchive()" class="btn-sijuru px-6 py-3 shadow-brand-300/50 flex items-center gap-2"><i data-lucide="check" class="w-4 h-4"></i> Selesai</button>
                </div>
            </div>
        </header>
        <main class="flex-1 overflow-hidden relative p-4">
            <div class="card-super h-full flex flex-col overflow-hidden shadow-xl shadow-slate-200/40 border-0">
                <div class="overflow-auto custom-scroll flex-1 p-1" id="daily-table-container">
                    <table class="table-sijuru w-full whitespace-nowrap" id="daily-table">
                        <thead class="sticky top-0 z-20 shadow-sm bg-slate-50" id="daily-table-head"></thead>
                        <tbody id="daily-table-body" class="bg-white divide-y divide-slate-50"></tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <!-- 8. ARCHIVES -->
    <div id="view-archives" class="hidden fixed inset-0 z-[80] bg-slate-50 flex flex-col p-4">
        <header class="bg-transparent px-4 py-6 flex items-center justify-between shrink-0 max-w-5xl mx-auto w-full">
             <div class="flex items-center gap-4"><button onclick="window.showView('main-menu')" class="btn-icon bg-white shadow-sm"><i data-lucide="arrow-left" class="w-5 h-5"></i></button><h2 class="h-big">Arsip Penilaian</h2></div>
        </header>
        <main class="flex-1 overflow-y-auto px-4 pb-10 custom-scroll"><div class="max-w-5xl mx-auto space-y-4" id="archive-list"></div></main>
    </div>

    <!-- HIDDEN PDF CONTAINER FOR DAILY REPORT -->
    <div id="daily-pdf-container" class="hidden"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, collection, doc, getDocs, getDoc, setDoc, onSnapshot, query, where, addDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyDU04V8KpMbBc28-bpP9PM_LQP06Kx9Cwk", authDomain: "remedial-tracker.firebaseapp.com", projectId: "remedial-tracker", storageBucket: "remedial-tracker.firebasestorage.app", messagingSenderId: "720679266176", appId: "1:720679266176:web:95b19d6eb06cf6cd9c4365" };
        const rootAppId = 'jurnal-guru-pro'; 
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const store = { teacherId: null, profile: {}, classes: [], activeClass: null, activeAssessment: null, activeSubject: null, students: [], grades: {}, subjects: [], config: { skor_ideal: {}, kktp: {} }, listeners: [], daily: { type: 'sumatif_harian', teknik: 'Tertulis', config: { lms: [] }, scores: {} }, archives: [], searchQuery: '' };
        const genId = () => Math.random().toString(36).substr(2, 9);

        // --- CORE FUNCTIONS ---
        window.handleSearch = function(val) { store.searchQuery = val.toLowerCase(); renderDailyTable(); }
        
        window.addLM = function() { 
            const newIndex = store.daily.config.lms.length + 1;
            store.daily.config.lms.push({
                id: `lm_${genId()}`, 
                name: `LM ${newIndex}`, 
                tps: [{id: `tp_${genId()}`, name: 'TP 1'}]
            }); 
            renderDailyTable(); 
        };
        
        window.delLM = function(i) { window.openConfirm('Hapus Lingkup Materi ini beserta nilainya?', () => { store.daily.config.lms.splice(i,1); renderDailyTable(); }); };
        window.addTP = function(i) { store.daily.config.lms[i].tps.push({id:`tp_${genId()}`, name:`TP ${store.daily.config.lms[i].tps.length+1}`}); renderDailyTable(); };
        window.delTP = function(i,j) { window.openConfirm('Hapus Tujuan Pembelajaran ini?', () => { store.daily.config.lms[i].tps.splice(j,1); renderDailyTable(); }); };
        window.updLMName = function(i,v) { store.daily.config.lms[i].name = v; };
        window.updTPName = function(i,j,v) { store.daily.config.lms[i].tps[j].name = v; };
        window.updScore = function(sid,k,v) { if(!store.daily.scores[sid]) store.daily.scores[sid]={}; store.daily.scores[sid][k]=v; };
        
        // --- NEW FEATURES: TP REFERENCE (READ ONLY) ---
        window.openTPReference = async function() {
            if (!auth.currentUser) return;
            const overlay = document.getElementById('modal-overlay');
            // Show Loader
            overlay.innerHTML = `<div class="card-super w-full max-w-md p-8 text-center"><div class="loader mx-auto mb-4 border-t-brand-600"></div><p class="font-bold text-slate-500">Mengambil Data Referensi Sijuru...</p></div>`;
            overlay.classList.remove('hidden');

            try {
                // Gunakan data dari store.subjects yang sudah tersinkron dengan 'mapels' di DB
                const subjects = store.subjects || [];
                
                let htmlContent = '';
                
                if (subjects.length === 0) {
                    htmlContent = `<div class="text-center py-10 text-slate-400"><p>Belum ada data Mapel/TP di database Sijuru Utama.</p></div>`;
                } else {
                    htmlContent = subjects.map(sub => {
                        let tpList = '';
                        // Logika pencarian field TP yang lebih robust (menghandle berbagai format field)
                        let foundTPs = [];
                        
                        if (sub.tps && Array.isArray(sub.tps) && sub.tps.length > 0) foundTPs = sub.tps;
                        else if (sub.tujuan_pembelajaran && Array.isArray(sub.tujuan_pembelajaran) && sub.tujuan_pembelajaran.length > 0) foundTPs = sub.tujuan_pembelajaran;
                        else if (sub.lingkup_materi && Array.isArray(sub.lingkup_materi)) {
                            // Extract TPs from Lingkup Materi structure
                            sub.lingkup_materi.forEach(lm => {
                                if (lm.tps) foundTPs = [...foundTPs, ...lm.tps];
                                else if (lm.tujuan_pembelajaran) foundTPs = [...foundTPs, ...lm.tujuan_pembelajaran];
                            });
                        }

                        if (foundTPs.length > 0) {
                            tpList = `<ul class="list-disc pl-4 space-y-1 text-xs text-slate-600 font-medium">
                                ${foundTPs.map(tp => `<li>${(typeof tp === 'object' && tp !== null) ? (tp.deskripsi || tp.name || tp.text || JSON.stringify(tp)) : tp}</li>`).join('')}
                            </ul>`;
                        } else {
                            tpList = `<p class="text-xs text-slate-400 italic">Tidak ada detail TP tersimpan.</p>`;
                        }

                        return `
                        <div class="mb-6 last:mb-0">
                            <h4 class="font-black text-slate-800 text-sm uppercase mb-3 border-b border-slate-100 pb-2">${sub.nama}</h4>
                            <div class="bg-slate-50 p-4 rounded-xl">
                                ${tpList}
                            </div>
                        </div>`;
                    }).join('');
                }

                setTimeout(() => {
                    overlay.innerHTML = `
                        <div class="card-super w-full max-w-3xl p-8 fade-in max-h-[85vh] flex flex-col">
                            <div class="flex justify-between items-center mb-6 shrink-0">
                                <div>
                                    <h3 class="h-card">Referensi TP (Bank Sijuru)</h3>
                                    <p class="label-xs text-brand-600 mt-1">Data Live dari Database Utama</p>
                                </div>
                                <button onclick="document.getElementById('modal-overlay').classList.add('hidden')" class="btn-icon"><i data-lucide="x"></i></button>
                            </div>
                            <div class="overflow-y-auto space-y-6 flex-1 custom-scroll p-2">
                                ${htmlContent}
                            </div>
                            <div class="mt-6 pt-4 border-t border-slate-50 text-center">
                                <button onclick="document.getElementById('modal-overlay').classList.add('hidden')" class="btn-sijuru bg-slate-800 w-full md:w-auto px-8">Tutup Referensi</button>
                            </div>
                        </div>
                    `;
                    if(window.lucide) window.lucide.createIcons();
                }, 500);

            } catch (e) {
                overlay.classList.add('hidden');
                window.toast('Gagal mengambil data', 'error');
            }
        };

        // --- NEW PRINT FUNCTION (FORMAL PDF) ---
        window.printDailyReport = function(isEmptyTemplate = false) {
            const container = document.getElementById('daily-pdf-container');
            const sub = store.subjects.find(s=>s.id===store.activeSubject);
            const mapelName = sub ? sub.nama : 'Mata Pelajaran';
            const dateStr = new Date().toLocaleDateString('id-ID', {day: 'numeric', month: 'long', year: 'numeric'});
            
            // Build the table header HTML manually to ensure style match
            let tableHeader = '';
            let tableBody = '';
            
            // Replicate header logic
            if (store.daily.type === 'formatif_harian') {
                let r1 = `<tr><th rowspan="2" style="border:1px solid #000; padding:5px; text-align:center; background:#eee;">No</th><th rowspan="2" style="border:1px solid #000; padding:5px; text-align:left; background:#eee;">Nama Siswa</th>`;
                let r2 = `<tr>`;
                store.daily.config.lms.forEach(lm => {
                    r1 += `<th colspan="${lm.tps.length}" style="border:1px solid #000; padding:5px; text-align:center; background:#eee;">${lm.name}</th>`;
                    lm.tps.forEach(tp => {
                        r2 += `<th style="border:1px solid #000; padding:5px; text-align:center; background:#fff; font-size:10px;">${tp.name}</th>`;
                    });
                });
                tableHeader = `<thead>${r1}</tr>${r2}</tr></thead>`;
                
                tableBody = `<tbody>${store.students.map((s,i) => {
                    let r = `<tr><td style="border:1px solid #000; padding:5px; text-align:center;">${i+1}</td><td style="border:1px solid #000; padding:5px; text-align:left;">${s.nama_siswa}</td>`;
                    store.daily.config.lms.forEach(lm => lm.tps.forEach(tp => {
                        const val = isEmptyTemplate ? '' : ((store.daily.scores[s.id] && store.daily.scores[s.id][`${lm.id}_${tp.id}`]) || '');
                        r += `<td style="border:1px solid #000; padding:5px; text-align:center;">${val}</td>`;
                    }));
                    return r + '</tr>';
                }).join('')}</tbody>`;
            } else {
                let r1 = `<tr><th style="border:1px solid #000; padding:5px; text-align:center; background:#eee;">No</th><th style="border:1px solid #000; padding:5px; text-align:left; background:#eee;">Nama Siswa</th>`;
                store.daily.config.lms.forEach(lm => {
                    r1 += `<th style="border:1px solid #000; padding:5px; text-align:center; background:#eee;">${lm.name}</th>`;
                });
                tableHeader = `<thead>${r1}</tr></thead>`;
                
                tableBody = `<tbody>${store.students.map((s,i) => {
                    let r = `<tr><td style="border:1px solid #000; padding:5px; text-align:center;">${i+1}</td><td style="border:1px solid #000; padding:5px; text-align:left;">${s.nama_siswa}</td>`;
                    store.daily.config.lms.forEach(lm => {
                        const val = isEmptyTemplate ? '' : ((store.daily.scores[s.id] && store.daily.scores[s.id][`lm_${lm.id}`]) || '');
                        r += `<td style="border:1px solid #000; padding:5px; text-align:center;">${val}</td>`;
                    });
                    return r + '</tr>';
                }).join('')}</tbody>`;
            }

            container.innerHTML = `
                <div style="font-family: 'Times New Roman', serif; color: #000; padding: 20px; width: 100%;">
                    <div style="text-align: center; border-bottom: 3px double #000; padding-bottom: 10px; margin-bottom: 20px;">
                        <h3 style="margin:0; font-size:14pt; font-weight:bold; text-transform:uppercase;">PEMERINTAH KABUPATEN ${store.profile.kabupaten || '...'}</h3>
                        <h2 style="margin:0; font-size:16pt; font-weight:bold; text-transform:uppercase;">${store.profile.nama_sekolah || 'NAMA SEKOLAH'}</h2>
                        <p style="margin:0; font-size:11pt; font-style:italic;">${store.profile.alamat_sekolah || 'Alamat Sekolah'}</p>
                    </div>
                    
                    <div style="text-align:center; margin-bottom: 20px;">
                        <h3 style="margin:0; font-size:12pt; font-weight:bold; text-transform:uppercase; text-decoration: underline;">JURNAL PENILAIAN HARIAN</h3>
                        <p style="margin:5px 0; font-size:11pt;">${store.daily.type.replace('_',' ').toUpperCase()} - ${store.daily.teknik}</p>
                    </div>

                    <table style="width:100%; border-collapse:collapse; margin-bottom:10px; font-size:11pt;">
                        <tr><td style="width:100px;">Mata Pelajaran</td><td>: ${mapelName}</td><td style="width:100px;">Kelas</td><td>: ${store.activeClass}</td></tr>
                        <tr><td>Semester</td><td>: ${store.activeAssessment === 'asts' || store.activeAssessment.includes('ganjil') ? 'Ganjil' : 'Genap'}</td><td>Tahun Ajaran</td><td>: ${new Date().getFullYear()}/${new Date().getFullYear()+1}</td></tr>
                    </table>

                    <table style="width:100%; border-collapse:collapse; font-size:10pt; margin-bottom:30px;">
                        ${tableHeader}
                        ${tableBody}
                    </table>

                    <div style="width: 100%; display: flex; justify-content: flex-end;">
                        <div style="text-align:center; width: 250px;">
                            <p style="margin:0;">${store.profile.kabupaten || 'Tempat'}, ${dateStr}</p>
                            <p style="margin:0;">Guru Mata Pelajaran</p>
                            <br><br><br>
                            <p style="margin:0; font-weight:bold; text-decoration:underline;">${store.profile.nama_guru || '....................'}</p>
                            <p style="margin:0;">NIP. ${store.profile.nip_guru || '-'}</p>
                        </div>
                    </div>
                </div>
            `;

            const filename = isEmptyTemplate ? `Template_Nilai_${mapelName}_${store.activeClass}.pdf` : `Jurnal_Harian_${mapelName}_${store.activeClass}.pdf`;

            const opt = {
                margin: 10,
                filename: filename,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2 },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'landscape' }
            };
            html2pdf().set(opt).from(container).save();
        };

        // 2. CSV & TEMPLATE DOWNLOAD (Combined logic)
        window.downloadDaily = function(type) {
            if (type === 'template_pdf') {
                window.printDailyReport(true); // Generate empty PDF
                return;
            }

            // CSV Logic
            let csv = [];
            let h1 = ['No', 'Nama Siswa'];
            
            if (store.daily.type === 'formatif_harian') {
                store.daily.config.lms.forEach(lm => {
                    lm.tps.forEach(tp => h1.push(`${lm.name} - ${tp.name}`));
                });
            } else {
                store.daily.config.lms.forEach(lm => h1.push(lm.name));
            }
            csv.push(h1.join(','));

            store.students.forEach((s, i) => {
                let row = [i+1, `"${s.nama_siswa}"`];
                if (store.daily.type === 'formatif_harian') {
                    store.daily.config.lms.forEach(lm => {
                        lm.tps.forEach(tp => {
                            const val = (type === 'csv') ? ((store.daily.scores[s.id] && store.daily.scores[s.id][`${lm.id}_${tp.id}`]) || '') : '';
                            row.push(val);
                        });
                    });
                } else {
                    store.daily.config.lms.forEach(lm => {
                        const val = (type === 'csv') ? ((store.daily.scores[s.id] && store.daily.scores[s.id][`lm_${lm.id}`]) || '') : '';
                        row.push(val);
                    });
                }
                csv.push(row.join(','));
            });

            const csvContent = "data:text/csv;charset=utf-8," + csv.join("\n");
            const link = document.createElement("a");
            const sub = store.subjects.find(s=>s.id===store.activeSubject);
            const title = `Nilai_Harian_${sub ? sub.nama : ''}_${store.activeClass}`;
            link.setAttribute("href", encodeURI(csvContent));
            link.setAttribute("download", `${title}${type==='template' ? '_TEMPLATE' : ''}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        };

        window.resetDraft = async function() {
            window.openConfirm('Reset konfigurasi ke default? Semua data nilai di draft ini akan hilang.', () => {
                store.daily.config = { 
                    lms: Array(3).fill().map((_,i)=>({
                        id:`lm_${genId()}`, name:`LM ${i+1}`, 
                        tps: Array(3).fill().map((_,j)=>({id:`tp_${genId()}`, name:`TP ${j+1}`})) 
                    })) 
                };
                store.daily.scores = {};
                renderDailyTable();
            });
        };

        window.saveDraft = async function() {
            if (!auth.currentUser) { window.toast('Tidak terhubung', 'error'); return; }
            const d = {...store.daily, mapelId: store.activeSubject, lastUpdated: new Date().toISOString() };
            try { await setDoc(doc(db, 'artifacts', rootAppId, 'public', 'data', `drafts_${store.activeClass}`, `${store.activeSubject}_${store.activeAssessment}`), d); window.toast('Draft Disimpan'); } catch(e){ window.toast('Gagal menyimpan','error'); console.error(e); }
        }

        window.saveToArchive = async function() {
            if (!auth.currentUser) return;
            window.openConfirm('Simpan Permanen ke Arsip?\n\nData akan disimpan sebagai riwayat dan tidak dapat diubah lagi. Pastikan semua nilai sudah benar.', async () => {
                const d = {...store.daily, timestamp: new Date().toISOString(), mapelName: store.subjects.find(s=>s.id===store.activeSubject)?.nama, kelas: store.activeClass, configSnapshot: store.daily.config };
                try { 
                    await addDoc(collection(db, 'artifacts', rootAppId, 'public', 'data', `archives_${store.activeClass}`), d); 
                    window.toast('Berhasil Diarsipkan'); showArchives(); 
                } catch(e){ window.toast('Error arsip','error'); }
            });
        }

        window.archiveSemester = function() {
            if (!auth.currentUser) return;
            window.openConfirm("Arsipkan data semester (Leger) ini?", async () => {
                const data = {
                    type: 'semester_archive',
                    kelas: store.activeClass,
                    assessment: store.activeAssessment,
                    timestamp: new Date().toISOString(),
                    mapelName: 'ALL SUBJECTS (LEGER)',
                    grades: store.grades,
                    students: store.students,
                    subjects: store.subjects 
                };
                try {
                    await addDoc(collection(db, 'artifacts', rootAppId, 'public', 'data', `archives_${store.activeClass}`), data);
                    window.toast("Leger Diarsipkan");
                } catch(e) { window.toast("Gagal Arsip", "error"); }
            });
        };

        window.showArchives = function() {
            const l = document.getElementById('archive-list');
            l.innerHTML = store.archives.length===0 ? '<div class="text-center py-20"><div class="w-20 h-20 bg-slate-100 rounded-full flex items-center justify-center mx-auto mb-4 text-slate-300"><i data-lucide="archive-x" class="w-10 h-10"></i></div><p class="text-slate-400 font-bold uppercase text-xs">Belum ada arsip</p></div>' : store.archives.map(a => `
                <div onclick="window.viewArchive('${a.id}')" class="card-sm p-6 flex items-center justify-between shadow-sm hover:shadow-md transition-shadow cursor-pointer relative group">
                    <div class="flex items-center gap-6">
                        <div class="w-12 h-12 bg-blue-50 text-blue-600 rounded-xl flex items-center justify-center font-black text-sm uppercase">${a.mapelName.substring(0,2)}</div>
                        <div><h4 class="font-black text-slate-800 uppercase text-sm">${a.mapelName}</h4><p class="label-xs mt-1 text-slate-400">${new Date(a.timestamp).toLocaleDateString()} • ${a.type ? a.type.replace('_',' ') : 'Arsip'}</p></div>
                    </div>
                    <div class="flex gap-2 relative z-20">
                         <button onclick="event.stopPropagation(); window.delArch(event, '${a.id}')" class="w-10 h-10 rounded-xl bg-rose-50 text-rose-500 flex items-center justify-center hover:bg-rose-100 transition-colors border border-transparent hover:border-rose-200"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                    </div>
                </div>
            `).join('');
            window.showView('archives');
            lucide.createIcons();
        }

        window.viewArchive = function(id) {
            const arch = store.archives.find(a => a.id === id);
            if(!arch) return;

            let content = '';
            
            if(arch.type === 'semester_archive') {
                 const subjects = arch.subjects || store.subjects; 
                 const students = arch.students;
                 const grades = arch.grades;
                 
                 content = `
                    <div class="overflow-auto custom-scroll"><table class="table-sijuru whitespace-nowrap">
                        <thead><tr><th class="w-12 text-center bg-slate-50 sticky left-0 z-20">No</th><th class="text-left bg-slate-50 sticky left-12 z-20">Nama</th>${subjects.map(s=>`<th class="text-center">${s.nama}</th>`).join('')}</tr></thead>
                        <tbody>
                            ${students.map((s,i) => `<tr>
                                <td class="text-center text-slate-300 font-bold sticky left-0 bg-white z-10">${i+1}</td>
                                <td class="font-bold text-xs uppercase text-slate-700 sticky left-12 bg-white z-10 border-r border-slate-50">${s.nama_siswa}</td>
                                ${subjects.map(sub => `<td class="text-center font-black">${(grades[s.id] && grades[s.id][sub.id]) || 0}</td>`).join('')}
                            </tr>`).join('')}
                        </tbody>
                    </table></div>
                 `;
            } else {
                const config = arch.configSnapshot || arch.config; 
                const scores = arch.scores || {};
                const isFormatif = arch.type === 'formatif_harian';
                const lms = config.lms || [];
                
                if (isFormatif) {
                     let r1 = `<tr><th rowspan="2" class="w-12 text-center">No</th><th rowspan="2" class="text-left">Nama Siswa</th>`;
                     let r2 = `<tr>`;
                     lms.forEach(lm => {
                         r1 += `<th colspan="${lm.tps.length}" class="text-center p-2 text-[10px] uppercase tracking-widest border border-slate-100 bg-slate-50">${lm.name}</th>`;
                         lm.tps.forEach(tp => {
                             r2 += `<th class="text-center p-2 text-[9px] font-bold text-slate-400 border border-slate-100 bg-white">${tp.name}</th>`;
                         });
                     });
                     const thead = `<thead class="sticky top-0 z-10 shadow-sm">${r1}</tr>${r2}</tr></thead>`;
                     const tbody = `<tbody>${store.students.map((s,i) => {
                         let r = `<tr><td class="text-center font-bold text-slate-300">${i+1}</td><td class="font-bold text-xs uppercase text-slate-700">${s.nama_siswa}</td>`;
                         lms.forEach(lm => lm.tps.forEach(tp => {
                             const v = (scores[s.id] && scores[s.id][`${lm.id}_${tp.id}`]) || '-';
                             r += `<td class="text-center font-bold text-slate-600">${v}</td>`;
                         }));
                         return r + '</tr>';
                     }).join('')}</tbody>`;
                     content = `<div class="overflow-auto custom-scroll"><table class="table-sijuru w-full whitespace-nowrap">${thead}${tbody}</table></div>`;
                } else {
                     const thead = `<thead><tr><th class="w-12 text-center">No</th><th class="text-left">Nama Siswa</th>${lms.map(lm=>`<th class="text-center">${lm.name}</th>`).join('')}</tr></thead>`;
                     const tbody = `<tbody>${store.students.map((s,i) => {
                         let r = `<tr><td class="text-center font-bold text-slate-300">${i+1}</td><td class="font-bold text-xs uppercase text-slate-700">${s.nama_siswa}</td>`;
                         lms.forEach(lm => {
                             const v = (scores[s.id] && scores[s.id][`lm_${lm.id}`]) || '-';
                             r += `<td class="text-center font-bold text-slate-600">${v}</td>`;
                         });
                         return r + '</tr>';
                     }).join('')}</tbody>`;
                     content = `<div class="overflow-auto custom-scroll"><table class="table-sijuru w-full whitespace-nowrap">${thead}${tbody}</table></div>`;
                }
            }
            
            const overlay = document.getElementById('modal-overlay');
            overlay.innerHTML = `
                <div class="card-super w-full max-w-4xl p-6 fade-in max-h-[90vh] flex flex-col">
                    <div class="flex justify-between items-center mb-6 shrink-0">
                        <div><h3 class="h-card">${arch.mapelName}</h3><p class="label-xs">${new Date(arch.timestamp).toLocaleString()} • ${arch.type.replace('_',' ')}</p></div>
                        <button onclick="document.getElementById('modal-overlay').classList.add('hidden')" class="btn-icon"><i data-lucide="x"></i></button>
                    </div>
                    <div class="flex-1 overflow-hidden relative rounded-xl border border-slate-100 bg-slate-50/50">
                        ${content}
                    </div>
                    <div class="mt-6 flex justify-end gap-3 shrink-0">
                         <button onclick="document.getElementById('modal-overlay').classList.add('hidden')" class="btn-sijuru bg-slate-800">Tutup</button>
                    </div>
                </div>
            `;
            overlay.classList.remove('hidden');
            lucide.createIcons();
        }

        // Updated DelArch to accept event
        window.delArch = async function(event, id) { 
            if(event) event.stopPropagation();
            if (!auth.currentUser) return;
            window.openConfirm('Hapus Arsip Permanen?', async () => {
                try {
                    await deleteDoc(doc(db,'artifacts',rootAppId,'public','data',`archives_${store.activeClass}`, id)); 
                    window.toast('Dihapus'); 
                } catch(e) {
                    console.error(e);
                    window.toast('Gagal hapus', 'error');
                }
            });
        };

        window.saveGrade = async function(sid, sub, val) { 
            if (!auth.currentUser) return;
            const v = parseFloat(val); 
            if(isNaN(v) && val !== '') return; // Allow empty string
            await setDoc(doc(db, 'artifacts', rootAppId, 'public', 'data', `grades_${store.activeClass}_${store.activeAssessment}`, sid), {[sub]: isNaN(v) ? 0 : v}, {merge:true}); 
        }
        
        window.setRem = async function(sid, k, s) { 
            if (!auth.currentUser) return;
            await setDoc(doc(db, 'artifacts', rootAppId, 'public', 'data', `grades_${store.activeClass}_${store.activeAssessment}`, sid), {[k]:s}, {merge:true}); 
        }

        window.downloadReportPDF = function() { 
            const element = document.getElementById('report-paper');
            const opt = {
                margin: 10,
                filename: `Laporan_${store.activeClass}.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2 },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
            };
            html2pdf().set(opt).from(element).save();
        }
        
        window.downloadLegerPDF = function() {
            const el = document.getElementById('leger-table').cloneNode(true); 
            const wrapper = document.createElement('div'); 
            wrapper.innerHTML = `<h2 style="text-align:center; font-family:sans-serif; margin-bottom:20px;">Leger Nilai Kelas ${store.activeClass}</h2>`; 
            el.style.width = '100%'; el.setAttribute('border', '1'); el.style.borderCollapse = 'collapse'; wrapper.appendChild(el); 
            html2pdf().from(wrapper).save(`Leger_${store.activeClass}.pdf`);
        };
        
        window.downloadLegerCSV = function() {
            const rows = [["No", "Nama Siswa", ...store.subjects.map(s => s.nama)]];
            store.students.forEach((s, i) => { const row = [i + 1, s.nama_siswa]; store.subjects.forEach(sub => row.push((store.grades[s.id] && store.grades[s.id][sub.id]) || 0)); rows.push(row); });
            let csvContent = "data:text/csv;charset=utf-8," + rows.map(e => e.join(",")).join("\n");
            const link = document.createElement("a"); link.setAttribute("href", encodeURI(csvContent)); link.setAttribute("download", `Leger_Kelas_${store.activeClass}.csv`); document.body.appendChild(link); link.click(); document.body.removeChild(link);
        };
        
        window.openModal = function(type) {
            const overlay = document.getElementById('modal-overlay');
            if(type==='mapel_config') { renderSubjectSettings(); overlay.innerHTML = `<div class="card-super w-full max-w-2xl p-8 fade-in max-h-[80vh] flex flex-col"><div class="flex justify-between items-center mb-8 shrink-0"><h3 class="h-card">Konfigurasi Mapel</h3><button onclick="document.getElementById('modal-overlay').classList.add('hidden')" class="btn-icon"><i data-lucide="x"></i></button></div><div class="overflow-y-auto p-1 space-y-4 flex-1 custom-scroll" id="subjects-list"></div><button onclick="window.saveSettings()" class="mt-8 btn-sijuru w-full">Simpan Perubahan</button></div>`; renderSubjectSettings(); }
            else if(type==='settings') { overlay.innerHTML = `<div class="card-super w-full max-w-lg p-8 fade-in"><h3 class="h-card mb-6">Pengaturan Umum</h3><div class="space-y-6"><div><label class="label-xs mb-2 block">Judul Laporan</label><input type="text" class="input-sijuru" value="${store.config.judul || ''}" onchange="window.updateMetaConfig('judul', this.value)"></div><div><label class="label-xs mb-2 block">Instansi</label><input type="text" class="input-sijuru bg-slate-100 text-slate-500" value="${store.profile.nama_sekolah || ''}" disabled></div></div><button onclick="document.getElementById('modal-overlay').classList.add('hidden')" class="mt-8 btn-sijuru w-full">Selesai</button></div>`; }
            else if(type==='siswa') { overlay.innerHTML = `<div class="card-super w-full max-w-lg p-8 fade-in max-h-[80vh] flex flex-col"><h3 class="h-card mb-6 shrink-0">Daftar Siswa</h3><div class="overflow-y-auto space-y-3 p-1 flex-1 custom-scroll">${store.students.map((s, i) => `<div class="p-4 bg-slate-50 rounded-2xl flex items-center gap-4"><span class="font-black text-slate-300 w-8 text-center">${i+1}</span><span class="font-bold text-slate-700 uppercase text-xs">${s.nama_siswa}</span><i data-lucide="lock" class="ml-auto w-4 h-4 text-slate-300"></i></div>`).join('')}</div><button onclick="document.getElementById('modal-overlay').classList.add('hidden')" class="mt-8 w-full bg-slate-100 text-slate-400 py-4 rounded-2xl font-black uppercase text-[10px] tracking-widest hover:bg-slate-200">Tutup</button></div>`; }
            // NEW GLOBAL SETTINGS MODAL
            else if(type==='global_settings') {
                overlay.innerHTML = `
                <div class="card-super w-full max-w-lg p-8 fade-in max-h-[85vh] flex flex-col">
                    <div class="flex justify-between items-center mb-6 shrink-0">
                        <h3 class="h-card">Pengaturan Global</h3>
                        <button onclick="document.getElementById('modal-overlay').classList.add('hidden')" class="btn-icon"><i data-lucide="x"></i></button>
                    </div>
                    <div class="overflow-y-auto space-y-4 p-1 custom-scroll flex-1">
                        <div><label class="label-xs mb-1 block">Nama Sekolah</label><input type="text" class="input-sijuru" value="${store.profile.nama_sekolah || ''}" onchange="window.updateProfile('nama_sekolah', this.value)"></div>
                        <div><label class="label-xs mb-1 block">Alamat Sekolah</label><input type="text" class="input-sijuru" value="${store.profile.alamat_sekolah || ''}" onchange="window.updateProfile('alamat_sekolah', this.value)"></div>
                        <div><label class="label-xs mb-1 block">Kabupaten/Kota</label><input type="text" class="input-sijuru" value="${store.profile.kabupaten || ''}" onchange="window.updateProfile('kabupaten', this.value)"></div>
                        <div class="grid grid-cols-2 gap-4">
                            <div><label class="label-xs mb-1 block">Kepala Sekolah</label><input type="text" class="input-sijuru" value="${store.profile.nama_kepsek || ''}" onchange="window.updateProfile('nama_kepsek', this.value)"></div>
                            <div><label class="label-xs mb-1 block">NIP Kepsek</label><input type="text" class="input-sijuru" value="${store.profile.nip_kepsek || ''}" onchange="window.updateProfile('nip_kepsek', this.value)"></div>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div><label class="label-xs mb-1 block">Nama Guru</label><input type="text" class="input-sijuru" value="${store.profile.nama_guru || ''}" onchange="window.updateProfile('nama_guru', this.value)"></div>
                            <div><label class="label-xs mb-1 block">NIP Guru</label><input type="text" class="input-sijuru" value="${store.profile.nip_guru || ''}" onchange="window.updateProfile('nip_guru', this.value)"></div>
                        </div>
                    </div>
                    <button onclick="window.saveGlobalSettings()" class="mt-6 btn-sijuru w-full">Simpan Data</button>
                </div>`;
            }
            overlay.classList.remove('hidden'); lucide.createIcons();
        }
        
        window.updateProfile = function(key, val) { store.profile[key] = val; };
        window.saveGlobalSettings = async function() {
            if (!auth.currentUser) return;
            await setDoc(doc(db, 'artifacts', rootAppId, 'users', store.teacherId, 'settings', 'profile'), store.profile, { merge: true });
            document.getElementById('modal-overlay').classList.add('hidden');
            window.toast("Data Sekolah Disimpan");
        };
        window.renderSubjectSettings = function() {
            const list = document.getElementById('subjects-list');
            if(!list) return;
            list.innerHTML = store.subjects.map(sub => `<div class="p-5 bg-slate-50 rounded-2xl border border-transparent hover:border-blue-200 transition-colors flex items-center justify-between"><div><span class="font-black text-xs uppercase text-slate-700">${sub.nama}</span></div><div class="flex gap-4"><div><label class="label-xs mb-1 block text-center">KKTP</label><input type="number" onchange="window.updateSubjectParam('${sub.id}', 'kktp', this.value)" class="w-16 p-2 rounded-xl bg-white text-center text-xs font-black text-slate-800 outline-none shadow-sm" value="${(store.config.kktp && store.config.kktp[sub.id]) || 70}"></div></div></div>`).join('');
        };
        
        window.updateSubjectParam = function(id, type, val) { if (!store.config[type]) store.config[type] = {}; store.config[type][id] = parseFloat(val); };
        window.updateMetaConfig = function(key, val) { store.config[key] = val; };
        window.saveSettings = async function() { await setDoc(doc(db, 'artifacts', rootAppId, 'public', 'data', `config_${store.activeClass}_${store.activeAssessment}`, 'main'), store.config, { merge: true }); document.getElementById('modal-overlay').classList.add('hidden'); window.toast("Pengaturan Disimpan"); };

        window.initApp = async function() { 
            try { 
                await signInAnonymously(auth); 
                lucide.createIcons(); 
                if(document.getElementById('login-form')) document.getElementById('login-form').onsubmit = window.login; 
                console.log("App Initialized & Connected");
            } 
            catch(e){ console.error("Init Error", e); }
        };

        window.login = async function(e) {
            e.preventDefault();
            if (!auth.currentUser) await signInAnonymously(auth); // Double check
            
            const btn = e.target.querySelector('button'); const oldHTML = btn.innerHTML;
            btn.innerHTML = `<div class="loader border-white/30 border-t-white w-4 h-4"></div>`;
            try {
                const code = document.getElementById('login-code').value.trim();
                const q = query(collection(db, 'artifacts', rootAppId, 'public', 'data', 'security'));
                const snap = await getDocs(q); let foundId = null;
                snap.forEach(d => { if(String(d.data().pin) === code) foundId = d.id; });
                if(foundId) { store.teacherId = foundId; await loadTeacherData(); window.showView('classes'); window.toast('Selamat Datang!'); } 
                else { window.toast('Kode Akses Salah', 'error'); }
            } catch(err) { console.error(err); window.toast('Error Koneksi', 'error'); } finally { btn.innerHTML = oldHTML; }
        };

        window.loadTeacherData = async function() {
            if (!auth.currentUser) return;
            onSnapshot(doc(db, 'artifacts', rootAppId, 'users', store.teacherId, 'settings', 'profile'), (s) => {
                if(s.exists()) { store.profile = s.data(); document.getElementById('teacher-name-display').textContent = store.profile.nama_guru || "Guru"; if(store.profile.kelas_diampu) renderClasses(); }
            });
            onSnapshot(collection(db, 'artifacts', rootAppId, 'users', store.teacherId, 'mapels'), (s) => { store.subjects = s.docs.map(d => ({id:d.id, ...d.data()})).sort((a,b) => a.nama.localeCompare(b.nama)); });
        }

        window.renderClasses = function() {
            const grid = document.getElementById('class-grid');
            if(store.profile.kelas_diampu) {
                store.classes = store.profile.kelas_diampu.sort();
                grid.innerHTML = store.classes.map(k => `<button onclick="window.selectClass('${k}')" class="card-super p-8 text-left hover:scale-[1.02] transition-transform group relative overflow-hidden border-2 border-transparent hover:border-brand-100"><div class="absolute -right-4 -top-4 w-32 h-32 bg-brand-50 rounded-full opacity-50 group-hover:scale-150 transition-transform duration-500"></div><div class="relative z-10"><div class="w-12 h-12 bg-brand-600 rounded-2xl flex items-center justify-center text-white shadow-lg shadow-brand-200 mb-6"><i data-lucide="book-open" class="w-6 h-6"></i></div><h3 class="text-4xl font-black text-slate-800 mb-1">${k}</h3><div class="flex items-center gap-2 text-brand-600 font-bold text-xs uppercase tracking-widest"><span>Masuk Kelas</span> <i data-lucide="arrow-right" class="w-3 h-3 group-hover:translate-x-1 transition-transform"></i></div></div></button>`).join('');
                lucide.createIcons();
            }
        }

        window.selectClass = function(k) {
            store.activeClass = k; document.getElementById('main-menu-class-label').textContent = `KELAS ${k}`;
            const qStud = query(collection(db, 'artifacts', rootAppId, 'users', store.teacherId, 'students'), where('kelas', '==', k));
            onSnapshot(qStud, (s) => store.students = s.docs.map(d => ({id:d.id, ...d.data()})).sort((a,b)=>a.nama_siswa.localeCompare(b.nama_siswa)));
            onSnapshot(collection(db, 'artifacts', rootAppId, 'public', 'data', `archives_${k}`), (s) => { 
                store.archives = s.docs.map(d => ({id:d.id, ...d.data()})).sort((a,b)=>new Date(b.timestamp)-new Date(a.timestamp));
                // Auto refresh if view is active
                const archiveView = document.getElementById('view-archives');
                if (archiveView && !archiveView.classList.contains('hidden')) {
                    window.showArchives();
                }
            });
            window.showView('main-menu');
        };

        window.selectAssessment = function(type) { store.activeAssessment = type; if(['asts','asas'].includes(type)) { store.activeSubject = store.subjects[0]?.id; startSemesterSession(); } };

        window.startSemesterSession = function() {
            store.listeners.forEach(u => u()); store.listeners = [];
            store.listeners.push(onSnapshot(collection(db, 'artifacts', rootAppId, 'public', 'data', `grades_${store.activeClass}_${store.activeAssessment}`), (s) => { store.grades = {}; s.forEach(d => store.grades[d.id] = d.data()); renderSemesterContent(); }));
            store.listeners.push(onSnapshot(doc(db, 'artifacts', rootAppId, 'public', 'data', `config_${store.activeClass}_${store.activeAssessment}`, 'main'), (s) => { store.config = s.exists() ? s.data() : { skor_ideal:{}, kktp:{} }; renderSemesterContent(); }));
            
            const nav = document.getElementById('semester-nav');
            nav.innerHTML = [{id:'dashboard', l:'Dashboard', i:'layout-dashboard'}, {id:'input', l:'Input Nilai', i:'pen-tool'}, {id:'remedial', l:'Remedial', i:'refresh-ccw'}, {id:'matriks', l:'Leger', i:'table-2'}, {id:'print', l:'Laporan', i:'printer'}].map(x => `<button onclick="window.nav('${x.id}')" id="nav-${x.id}" class="w-full flex items-center gap-4 px-4 py-4 rounded-2xl font-black text-[11px] uppercase tracking-widest text-slate-400 hover:bg-slate-50 hover:text-slate-800 transition-colors"><i data-lucide="${x.i}" class="w-5 h-5"></i> ${x.l}</button>`).join('') + `<div class="my-4 border-t border-slate-50"></div><button onclick="window.openSettings('siswa')" class="w-full flex items-center gap-4 px-4 py-4 rounded-2xl font-black text-[11px] uppercase tracking-widest text-slate-400 hover:text-slate-800"><i data-lucide="users" class="w-5 h-5"></i> Data Siswa</button>`;
            
            window.showView('app-semester'); window.nav('dashboard');
        }

        window.nav = function(page) {
            store.currentPage = page;
            document.querySelectorAll('#semester-nav button').forEach(b => { if(b.id) b.className = b.id === `nav-${page}` ? "w-full flex items-center gap-4 px-4 py-4 rounded-2xl font-black text-[11px] uppercase tracking-widest bg-brand-600 text-white shadow-lg shadow-brand-200 transition-all transform scale-105" : "w-full flex items-center gap-4 px-4 py-4 rounded-2xl font-black text-[11px] uppercase tracking-widest text-slate-400 hover:bg-slate-50 hover:text-slate-800 transition-colors"; });
            document.getElementById('page-title').textContent = {dashboard:'Ringkasan', input:'Input Nilai', remedial:'Status', matriks:'Leger Nilai', print:'Cetak Rapor'}[page];
            document.getElementById('page-subtitle').textContent = `${store.activeAssessment.toUpperCase()} • ${store.activeClass}`;
            renderSemesterContent();
        }

        window.renderSemesterContent = function() {
            const container = document.getElementById('content-area');
            const students = store.students.map(s => ({...s, ...(store.grades[s.id]||{})}));
            const subId = store.activeSubject;
            
            const SubjectTabs = `<div class="flex gap-2 overflow-x-auto pb-4 mb-2 custom-scroll no-scrollbar">${store.subjects.map(s => `<button onclick="store.activeSubject='${s.id}'; window.renderSemesterContent()" class="px-6 py-3 rounded-2xl text-[10px] font-black uppercase tracking-widest whitespace-nowrap transition-all ${store.activeSubject===s.id ? 'bg-slate-800 text-white shadow-lg' : 'bg-white border border-slate-100 text-slate-400 hover:bg-slate-50'}">${s.nama}</button>`).join('')}</div>`;

            if(store.currentPage === 'dashboard') {
                const completed = students.filter(s => store.subjects.every(sub => (s[sub.id]||0) >= ((store.config.kktp && store.config.kktp[sub.id])||70))).length;
                container.innerHTML = `<div class="grid grid-cols-1 md:grid-cols-3 gap-6 fade-in"><div class="card-super p-8 flex items-center gap-6"><div class="w-16 h-16 rounded-[1.5rem] bg-brand-50 text-brand-600 flex items-center justify-center"><i data-lucide="users" class="w-8 h-8"></i></div><div><h3 class="text-3xl font-black text-slate-800">${students.length}</h3><p class="label-xs">Total Siswa</p></div></div><div class="card-super p-8 flex items-center gap-6"><div class="w-16 h-16 rounded-[1.5rem] bg-emerald-50 text-emerald-600 flex items-center justify-center"><i data-lucide="check-circle" class="w-8 h-8"></i></div><div><h3 class="text-3xl font-black text-slate-800">${completed}</h3><p class="label-xs">Tuntas Semua</p></div></div><div class="card-super p-8 flex items-center gap-6"><div class="w-16 h-16 rounded-[1.5rem] bg-violet-50 text-violet-600 flex items-center justify-center"><i data-lucide="book" class="w-8 h-8"></i></div><div><h3 class="text-3xl font-black text-slate-800">${store.subjects.length}</h3><p class="label-xs">Mata Pelajaran</p></div></div></div>`;
            } else if (store.currentPage === 'input') {
                container.innerHTML = `<div class="fade-in h-full flex flex-col">${SubjectTabs}<div class="flex-1 card-super border-0 shadow-lg overflow-hidden flex flex-col"><div class="overflow-auto custom-scroll flex-1 p-2"><table class="table-sijuru w-full relative"><thead class="sticky top-0 z-10 shadow-sm"><tr><th class="w-16 text-center bg-slate-50 rounded-l-xl">No</th><th class="bg-slate-50">Nama Siswa</th><th class="w-40 text-center bg-slate-50 rounded-r-xl">Nilai</th></tr></thead><tbody class="divide-y divide-slate-50">${students.map((s,i) => `<tr class="hover:bg-slate-50 transition-colors"><td class="text-center font-bold text-slate-300 py-4">${i+1}</td><td class="font-bold text-slate-700 uppercase text-xs py-4">${s.nama_siswa}</td><td class="p-2"><input type="number" value="${s[subId]||''}" onchange="window.saveGrade('${s.id}','${subId}',this.value)" onkeydown="window.handleKey(event, ${i}, '${subId}')" id="cell-${i}-${subId}" class="input-sijuru text-center text-lg bg-slate-50 focus:bg-white" placeholder="0"></td></tr>`).join('')}</tbody></table></div></div></div>`;
            } else if (store.currentPage === 'remedial') {
                // BUG FIX: Define KKTP here
                const currentKktp = (store.config.kktp && store.config.kktp[subId]) || 70;
                container.innerHTML = `<div class="fade-in h-full flex flex-col">${SubjectTabs}<div class="flex-1 card-super border-0 shadow-lg overflow-auto custom-scroll p-2"><table class="table-sijuru w-full"><thead class="sticky top-0 z-10 bg-white"><tr><th class="w-16 text-center">No</th><th>Nama</th><th class="w-24 text-center">Nilai</th><th class="w-40 text-center">Status</th></tr></thead><tbody>${students.map((s,i) => { const val = s[subId]||0; const passed = val >= currentKktp; const remKey = `rem_${subId}`; const status = s[remKey] || (passed ? 'pass' : 'fail'); return `<tr><td class="text-center text-slate-300 font-bold">${i+1}</td><td class="font-bold text-xs uppercase text-slate-700">${s.nama_siswa}</td><td class="text-center font-black ${passed?'text-emerald-600':'text-rose-500'} text-lg">${val}</td><td class="text-center">${passed ? '<span class="px-3 py-1.5 bg-emerald-50 text-emerald-600 rounded-lg text-[9px] font-black uppercase">TUNTAS</span>' : (status==='done' ? '<button onclick="window.setRem(\''+s.id+'\',\''+remKey+'\',\'fail\')" class="px-3 py-1.5 bg-blue-50 text-blue-600 rounded-lg text-[9px] font-black uppercase hover:bg-blue-100">SUDAH REMIDI</button>' : '<button onclick="window.setRem(\''+s.id+'\',\''+remKey+'\',\'done\')" class="px-3 py-1.5 bg-rose-50 text-rose-600 rounded-lg text-[9px] font-black uppercase hover:bg-rose-100">PERLU REMIDI</button>')}</td></tr>` }).join('')}</tbody></table></div></div>`;
            } else if (store.currentPage === 'matriks') {
                container.innerHTML = `<div class="flex flex-col h-full fade-in gap-4"><div class="flex justify-between items-center bg-white p-4 rounded-2xl shadow-sm border border-slate-100"><h3 class="font-black text-slate-800 uppercase text-sm">Leger Nilai Lengkap</h3><div class="flex gap-2"><button onclick="window.downloadLegerCSV()" class="bg-emerald-50 text-emerald-600 px-4 py-2 rounded-xl text-[10px] font-black uppercase tracking-widest hover:bg-emerald-100 flex items-center gap-2"><i data-lucide="sheet" class="w-3 h-3"></i> CSV</button><button onclick="window.downloadLegerPDF()" class="bg-blue-50 text-blue-600 px-4 py-2 rounded-xl text-[10px] font-black uppercase tracking-widest hover:bg-blue-100 flex items-center gap-2"><i data-lucide="file-text" class="w-3 h-3"></i> PDF</button><button onclick="window.archiveSemester()" class="bg-slate-100 text-slate-600 px-4 py-2 rounded-xl text-[10px] font-black uppercase tracking-widest hover:bg-slate-200 flex items-center gap-2"><i data-lucide="archive" class="w-3 h-3"></i> Arsip</button></div></div><div class="card-super border-0 shadow-lg overflow-auto custom-scroll p-2 flex-1"><table class="table-sijuru whitespace-nowrap" id="leger-table"><thead class="sticky top-0 z-10"><tr><th class="sticky left-0 bg-slate-50 z-20 w-12 text-center rounded-l-xl">No</th><th class="sticky left-12 bg-slate-50 z-20 w-64">Nama Siswa</th>${store.subjects.map(s => `<th class="text-center w-24">${s.nama}</th>`).join('')}</tr></thead><tbody>${students.map((s,i) => `<tr><td class="sticky left-0 bg-white text-center font-bold text-slate-300">${i+1}</td><td class="sticky left-12 bg-white font-bold text-xs uppercase text-slate-700 border-r border-slate-50">${s.nama_siswa}</td>${store.subjects.map(sub => { const v=s[sub.id]||0; const k=(store.config.kktp&&store.config.kktp[sub.id])||70; return `<td class="text-center font-black ${v<k?'text-rose-500 bg-rose-50/20':''}">${v}</td>` }).join('')}</tr>`).join('')}</tbody></table></div></div>`;
            } else if (store.currentPage === 'print') {
                container.innerHTML = `
                 <div class="flex flex-col h-full fade-in gap-4">
                    <div class="flex justify-between items-center bg-white p-4 rounded-2xl shadow-sm border border-slate-100 shrink-0">
                        <div><h3 class="font-black text-slate-800 uppercase text-sm">Cetak Laporan</h3><p class="text-[10px] text-slate-400 font-bold uppercase tracking-wide">Pratinjau Dokumen Resmi</p></div>
                        <button onclick="window.downloadReportPDF()" class="btn-sijuru px-6 py-2 text-[10px] flex items-center gap-2"><i data-lucide="download" class="w-4 h-4"></i> Download PDF</button>
                    </div>
                    <div class="flex-1 overflow-auto custom-scroll bg-slate-200/50 rounded-2xl p-4 md:p-8 flex justify-center">
                        <div id="report-paper" class="bg-white shadow-xl p-10 md:p-14 w-full max-w-[210mm] min-h-[297mm] text-black font-serif text-sm leading-normal origin-top scale-95 md:scale-100 transition-transform">
                            <div class="text-center border-b-[3px] border-double border-black pb-4 mb-6"><h3 class="font-bold text-base uppercase">PEMERINTAH KABUPATEN ${store.profile.kabupaten || '...'}</h3><h2 class="font-bold text-xl uppercase mb-1">${store.profile.nama_sekolah || 'NAMA SEKOLAH'}</h2><p class="text-xs italic">${store.profile.alamat_sekolah || 'Alamat Sekolah'}</p></div>
                            <div class="mb-6 text-center uppercase font-bold"><h3 class="text-lg underline decoration-1 underline-offset-4 mb-2">LAPORAN PENILAIAN ${store.activeAssessment === 'asts' ? 'TENGAH SEMESTER' : 'AKHIR SEMESTER'}</h3><p class="text-sm">Tahun Pelajaran 20../20..</p></div>
                            <div class="flex justify-between mb-4 text-sm font-sans"><div><span class="font-bold">Kelas:</span> ${store.activeClass}</div><div><span class="font-bold">Semester:</span> ${store.activeAssessment === 'asts' ? 'Ganjil' : 'Genap'}</div></div>
                            <table class="w-full border-collapse border border-black text-sm">
                                <thead><tr class="bg-gray-100"><th class="border border-black p-2 text-center w-10">No</th><th class="border border-black p-2 text-left">Nama Siswa</th>${store.subjects.map(s => `<th class="border border-black p-2 text-center w-16">${s.nama}</th>`).join('')}</tr></thead>
                                <tbody>${students.map((s, i) => `<tr><td class="border border-black p-2 text-center">${i+1}</td><td class="border border-black p-2 uppercase">${s.nama_siswa}</td>${store.subjects.map(sub => { const v = (store.grades[s.id] && store.grades[s.id][sub.id]) || 0; const k = (store.config.kktp && store.config.kktp[sub.id]) || 70; return `<td class="border border-black p-2 text-center font-mono" style="${v >= k ? 'background-color: #d1fae5;' : ''}">${v}</td>`; }).join('')}</tr>`).join('')}</tbody>
                            </table>
                            <div class="mt-12 flex justify-end text-sm break-inside-avoid"><div class="text-center w-64"><p>${store.profile.kabupaten || 'Tempat'}, ${new Date().toLocaleDateString('id-ID', {day: 'numeric', month: 'long', year: 'numeric'})}</p><p>Guru Kelas</p><br><br><br><p class="font-bold underline uppercase">${store.profile.nama_guru || '....................'}</p><p>NIP. ${store.profile.nip_guru || '-'}</p></div></div>
                        </div>
                    </div>
                 </div>`;
            }
            lucide.createIcons();
        }

        window.startDailyFlow = function(type) {
            store.activeAssessment = type;
            const grid = document.getElementById('daily-mapel-grid');
            grid.innerHTML = store.subjects.map(s => `<button onclick="window.selectDailySubject('${s.id}')" class="card-sm p-6 flex flex-col items-center text-center gap-4 hover:border-brand-500 hover:shadow-xl transition-all group"><div class="w-16 h-16 rounded-[1.5rem] bg-brand-50 text-brand-600 flex items-center justify-center font-black text-xl group-hover:bg-brand-600 group-hover:text-white transition-colors shadow-inner">${s.nama.substring(0,2).toUpperCase()}</div><div><h4 class="font-black text-slate-800 text-sm uppercase">${s.nama}</h4><p class="label-xs mt-1 text-slate-400 group-hover:text-brand-500">Pilih Mapel</p></div></button>`).join('');
            window.showView('daily-mapel');
        }

        window.selectDailySubject = async function(subId) {
            store.activeSubject = subId; const sub = store.subjects.find(s=>s.id===subId); document.getElementById('daily-setup-title').textContent = sub.nama;
            const ref = doc(db, 'artifacts', rootAppId, 'public', 'data', `drafts_${store.activeClass}`, `${subId}_${store.activeAssessment}`);
            const snap = await getDoc(ref);
            if(snap.exists()) { const d = snap.data(); store.daily.config = d.config; store.daily.scores = d.scores; setDailyType(d.type); window.toast('Draft dimuat'); } 
            else { store.daily.config = { lms: Array(3).fill().map((_,i)=>({ id:`lm_${genId()}`, name:`LM ${i+1}`, tps: Array(3).fill().map((_,j)=>({id:`tp_${genId()}`, name:`TP ${j+1}`})) })) }; store.daily.scores = {}; setDailyType('sumatif_harian'); }
            window.showView('daily-setup');
        }

        window.setDailyType = function(t) { store.daily.type = t; const info = document.getElementById('tp-info'); if(t==='formatif_harian') info.classList.remove('hidden'); else info.classList.add('hidden'); }

        window.startDailyInput = function() {
             const rad = document.querySelector('input[name="teknik"]:checked');
             store.daily.teknik = rad ? rad.value : 'Tertulis';
             store.searchQuery = ''; document.getElementById('student-search').value = '';
             renderDailyTable(); window.showView('daily-input');
        }

        window.renderDailyTable = function() {
            const head = document.getElementById('daily-table-head');
            const body = document.getElementById('daily-table-body');
            const sub = store.subjects.find(s=>s.id===store.activeSubject);
            const lms = store.daily.config.lms;
            
            document.getElementById('daily-input-title').textContent = sub.nama;
            document.getElementById('daily-input-meta').textContent = store.daily.type.replace('_',' ');
            document.getElementById('daily-input-tech').textContent = store.daily.teknik;
            
            const btnAdd = document.getElementById('btn-add-lm');
            if(store.daily.type === 'formatif_harian') btnAdd.classList.remove('hidden'); else btnAdd.classList.add('hidden');

            const filteredStudents = store.students.filter(s => s.nama_siswa.toLowerCase().includes(store.searchQuery));

            if (store.daily.type === 'formatif_harian') {
                let r1 = `<tr><th rowspan="2" class="w-12 text-center bg-slate-50 border-r border-white rounded-tl-xl">No</th><th rowspan="2" class="text-left bg-slate-50 border-r border-white w-64 min-w-[200px]">Nama Siswa</th>`;
                let r2 = `<tr>`;
                
                lms.forEach((lm, i) => {
                    r1 += `<th colspan="${lm.tps.length}" class="bg-slate-50 border-r border-white p-2 min-w-[160px] align-top"><div class="flex flex-col h-full gap-2"><input value="${lm.name}" onchange="window.updLMName(${i},this.value)" class="bg-white border border-slate-200 rounded-lg text-center w-full font-black text-[10px] uppercase outline-none text-brand-600 tracking-wider py-1.5 shadow-sm"><div class="flex justify-center gap-2 mt-auto pt-2"><button onclick="window.addTP(${i})" class="flex-1 bg-emerald-100 text-emerald-700 py-1.5 rounded-lg text-[9px] font-bold hover:bg-emerald-200 border border-emerald-300 shadow-sm flex items-center justify-center gap-1"><i data-lucide="plus" class="w-3 h-3"></i> TP</button><button onclick="window.delLM(${i})" class="bg-rose-100 text-rose-700 px-3 py-1.5 rounded-lg hover:bg-rose-200 border border-rose-300 shadow-sm"><i data-lucide="trash-2" class="w-3 h-3"></i></button></div></div></th>`;
                    lm.tps.forEach((tp, j) => {
                           r2 += `<th class="bg-white border-b border-slate-100 p-2 align-top w-24 min-w-[80px]"><div class="flex flex-col gap-2 items-center h-full justify-between"><input value="${tp.name || 'TP '+(j+1)}" onchange="window.updTPName(${i},${j},this.value)" class="bg-slate-50 border border-transparent focus:bg-white focus:border-slate-200 rounded text-center w-full outline-none text-[9px] font-bold uppercase text-slate-400 py-1"><button onclick="window.delTP(${i},${j})" class="text-rose-300 hover:text-rose-600 p-1 hover:bg-rose-50 rounded-full transition-colors"><i data-lucide="x-circle" class="w-4 h-4"></i></button></div></th>`;
                    });
                });
                head.innerHTML = r1 + '</tr>' + r2 + '</tr>';
                
                body.innerHTML = filteredStudents.map((s,i) => {
                    let r = `<tr class="hover:bg-slate-50 transition-colors"><td class="text-center py-3 text-slate-300 font-bold text-xs border-r border-slate-50">${i+1}</td><td class="px-3 py-3 border-r border-slate-50 font-bold text-slate-700 text-xs uppercase">${s.nama_siswa}</td>`;
                    lms.forEach(lm => lm.tps.forEach(tp => {
                        const v = (store.daily.scores[s.id] && store.daily.scores[s.id][`${lm.id}_${tp.id}`]) || ''; const colKey = `${lm.id}_${tp.id}`;
                        r += `<td class="border-r border-slate-50 p-1 h-12 w-16"><input id="cell-${i}-${colKey}" class="w-full h-full text-center bg-transparent font-bold text-sm outline-none focus:bg-white focus:shadow-inner rounded-lg" value="${v}" onchange="window.updScore('${s.id}','${colKey}',this.value)" onkeydown="window.handleKey(event, ${i}, '${colKey}')" autocomplete="off"></td>`;
                    }));
                    return r + '</tr>';
                }).join('');
            } else {
                let r1 = `<tr><th class="w-12 text-center bg-slate-50 rounded-l-xl">No</th><th class="text-left bg-slate-50">Nama Siswa</th>`;
                lms.forEach((lm,i) => { r1 += `<th class="bg-slate-50 text-center w-32 relative group p-2"><input value="${lm.name}" onchange="window.updLMName(${i},this.value)" class="bg-white border border-slate-200 rounded-lg py-1.5 shadow-sm text-center w-full font-black outline-none text-slate-600 text-[10px] uppercase tracking-widest"></th>`; });
                head.innerHTML = r1 + '</tr>';
                body.innerHTML = filteredStudents.map((s,i) => {
                    let r = `<tr class="hover:bg-slate-50"><td class="text-center py-4 text-slate-300 font-bold">${i+1}</td><td class="px-4 py-4 font-bold text-slate-700 uppercase text-xs">${s.nama_siswa}</td>`;
                    lms.forEach(lm => { const v = (store.daily.scores[s.id] && store.daily.scores[s.id][`lm_${lm.id}`]) || ''; const colKey = `lm_${lm.id}`; r += `<td class="p-2"><input id="cell-${i}-${colKey}" type="number" class="input-sijuru text-center bg-slate-50 focus:bg-white text-lg" value="${v}" onchange="window.updScore('${s.id}','${colKey}',this.value)" onkeydown="window.handleKey(event, ${i}, '${colKey}')"></td>`; });
                    return r + '</tr>';
                }).join('');
            }
            lucide.createIcons();
        }

        window.openSettings = (t) => window.openModal(t || 'global_settings');
        window.openMapelConfig = () => window.openModal('mapel_config');

        // Initial Start
        initApp();
    </script>
</body>
</html>