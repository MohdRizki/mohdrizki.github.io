<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SIJURU - Aplikasi Jurnal Guru</title>
    <link rel="icon" type="image/x-icon" href="reezapps.ico">
    
    <!-- CSS & Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
    
    <!-- Libraries -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { initializeFirestore, collection, doc, setDoc, getDocs, addDoc, updateDoc, deleteDoc, onSnapshot, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- 1. FIREBASE CONFIG ---
        const firebaseConfig = {
            apiKey: "AIzaSyDU04V8KpMbBc28-bpP9PM_LQP06Kx9Cwk",
            authDomain: "remedial-tracker.firebaseapp.com",
            projectId: "remedial-tracker",
            storageBucket: "remedial-tracker.firebasestorage.app",
            messagingSenderId: "720679266176",
            appId: "1:720679266176:web:95b19d6eb06cf6cd9c4365"
        };
        
        const appId = 'jurnal-guru-pro'; 
        const hubUrl = "https://mohdrizki.github.io/";
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = initializeFirestore(app, { experimentalForceLongPolling: true });

        // --- GLOBAL HELPER ---
        window.getDayName = (dateStr) => {
            if (!dateStr) return '';
            const date = new Date(dateStr);
            return date.toLocaleDateString('id-ID', { weekday: 'long' });
        };

        window.isHoliday = (dateStr) => {
            if (!dateStr) return false;
            const date = new Date(dateStr);
            const isSunday = date.getDay() === 0;
            const isNationalHoliday = window.appState.holidays.some(h => h.tanggal === dateStr);
            return isSunday || isNationalHoliday;
        };

        window.getHolidayDescription = (dateStr) => {
            if (!dateStr) return '';
            const date = new Date(dateStr);
            const holiday = window.appState.holidays.find(h => h.tanggal === dateStr);
            if (holiday) return holiday.keterangan;
            if (date.getDay() === 0) return 'Libur Akhir Pekan';
            return '';
        };

        // --- AUDIO HELPERS ---
        window.playBeep = () => {
            const ctx = new (window.AudioContext || window.webkitAudioContext)();
            const osc = ctx.createOscillator();
            const gain = ctx.createGain();
            osc.connect(gain);
            gain.connect(ctx.destination);
            osc.type = 'sine';
            osc.frequency.value = 880; // Nada A5
            gain.gain.value = 0.1;
            osc.start();
            setTimeout(() => osc.stop(), 150);
        };

        window.speakText = (text) => {
            if (!('speechSynthesis' in window)) return;
            window.speechSynthesis.cancel();
            const utterance = new SpeechSynthesisUtterance(text.toLowerCase());
            utterance.lang = 'id-ID';
            utterance.rate = 1.0;
            utterance.pitch = 0.8; 
            window.speechSynthesis.speak(utterance);
        };

        // --- 2. GLOBAL STATE ---
        window.appState = {
            currentView: 'dashboard',
            user: null,
            teacherId: null, 
            loading: true,
            isAuthenticated: false,
            isLoggingIn: false,
            isScannerStarting: false,
            loginError: '',
            settings: { 
                nama_guru: '', nip_guru: '', nama_sekolah: '', nama_kepsek: '', nip_kepsek: '', lokasi: '', semester: '1', tahun_ajaran: '2024/2025', kelas_diampu: [], 
                voiceMode: 'mute' 
            },
            students: [],
            journals: [],
            attendance: [], 
            mapels: [],
            holidays: [],
            selectedKelas: '', 
            selectedMapel: '',
            selectedDate: new Date().toISOString().split('T')[0],
            reportMonth: new Date().toISOString().slice(0, 7),
            historyMonth: new Date().toISOString().slice(0, 7),
            reportSearch: '',
            attendanceSearch: '',
            reportViewType: 'rekap', 
            lastFocusedId: null,
            lastCaretPos: 0,
            mobileMenuOpen: false,
            sidebarCollapsed: false, 
            populationExpanded: false,
            scannerActive: false,
            html5QrCode: null,
            cameraFacingMode: "user", 
            modal: { show: false, title: '', message: '', onConfirm: null },
            qrModal: { show: false, student: null },
            editModal: { show: false, id: null, name: '' },
            // NEW: MODAL UNTUK EDIT IZIN BERJANGKA
            longTermEditModal: { show: false, studentId: null, date: null, type: '' },
            scannerLock: false,
            scanSuccessPopup: { show: false, studentName: '' },
            lastScans: {},
            
            // --- STATE PRESENSI MANUAL ---
            finishStep: 0, 
            missingStudentsCache: []
        };

        // UPDATED: Menu Names V2
        const viewTitles = {
            'dashboard': 'Beranda',
            'scanner': 'Scan QR Presensi',
            'input': 'Isi Jurnal Harian',
            'mapel': 'Mata Pelajaran',
            'history': 'Riwayat Jurnal',  // Changed from Riwayat
            'reports': 'Laporan Presensi', // Changed from Laporan
            'students': 'Pengelolaan Siswa',
            'holidays': 'Izin & Hari Libur',
            'settings': 'Pengaturan Sistem',
            'info': 'Tentang Aplikasi'
        };

        // --- 3. UI HELPERS ---
        window.showNotif = (msg, tipe = 'success') => {
            const wadah = document.getElementById('notif-anchor');
            if (!wadah) return;
            const kotak = document.createElement('div');
            kotak.className = `bg-white border-l-4 ${tipe === 'error' ? 'border-rose-500 text-rose-600' : 'border-blue-600 text-blue-600'} shadow-xl rounded-2xl p-4 animate-slideDown flex items-center gap-3 pointer-events-auto mb-2 w-72 z-[99999] text-left transition-all`;
            kotak.innerHTML = `<i class="fa-solid fa-circle-info"></i> <span class="text-[10px] font-black uppercase tracking-tight">${msg}</span>`;
            wadah.appendChild(kotak);
            setTimeout(() => { kotak.style.opacity='0'; setTimeout(()=>kotak.remove(), 400); }, 3000);
        };

        window.confirmAction = (title, message, onConfirm) => {
            window.appState.modal = { show: true, title, message, onConfirm };
            window.renderOverlays();
        };

        // --- NEW: LOGIKA ALUR SELESAIKAN PRESENSI ---
        window.initFinishAttendance = async () => {
            await window.stopScanner();
            const allStudents = window.appState.students.filter(s => String(s.kelas) === String(window.appState.selectedKelas));
            const presentIds = window.appState.attendance
                .filter(a => a.date === window.appState.selectedDate && String(a.studentClass) === String(window.appState.selectedKelas))
                .map(a => a.studentId);
            window.appState.missingStudentsCache = allStudents
                .filter(s => !presentIds.includes(s.id))
                .sort((a, b) => a.nama_siswa.localeCompare(b.nama_siswa)); 
            window.appState.finishStep = 1; 
            window.renderOverlays(); 
        };

        window.goToFinishList = () => { window.appState.finishStep = 2; window.renderOverlays(); };

        window.markManualQuick = async (id, status) => {
            const rowEl = document.getElementById(`manual-row-${id}`);
            if (rowEl) { rowEl.style.transition = "all 0.3s ease"; rowEl.style.opacity = "0"; rowEl.style.transform = "translateX(50px)"; setTimeout(() => rowEl.remove(), 300); }
            await window.markAttendance(id, status);
            window.appState.missingStudentsCache = window.appState.missingStudentsCache.filter(s => s.id !== id);
            const countEl = document.getElementById('manual-remaining-count');
            if (countEl) countEl.textContent = `${window.appState.missingStudentsCache.length} Sisa`;
            if (window.appState.missingStudentsCache.length === 0) {
                const listContainer = document.getElementById('manual-confirm-list');
                if (listContainer) setTimeout(() => { listContainer.innerHTML = '<p class="text-center text-xs text-slate-400 font-bold py-10 animate-fadeIn">Semua siswa sudah diabsen!</p>'; }, 300);
            }
        };

        window.finishAttendanceProcess = () => { window.appState.finishStep = 3; window.renderOverlays(); };

        window.confirmJournal = (yes) => {
            if (yes) { window.appState.finishStep = 0; window.renderOverlays(); window.setView('input'); } 
            else { window.appState.finishStep = 4; window.renderOverlays(); }
        };

        window.closeFinishAttendance = () => { window.appState.finishStep = 0; window.renderOverlays(); window.setView('dashboard'); };

        // --- NEW: HANDLING IZIN JANGKA PANJANG & EDIT ---
        window.handleSaveLongTerm = async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const studentId = formData.get('studentId');
            const startDate = new Date(formData.get('startDate'));
            const endDate = new Date(formData.get('endDate'));
            const status = formData.get('status');
            const note = formData.get('note');

            if (!studentId || !startDate || !endDate) return window.showNotif("Mohon lengkapi data", "error");
            if (startDate > endDate) return window.showNotif("Tanggal akhir harus setelah tanggal awal", "error");

            const student = window.appState.students.find(s => s.id === studentId);
            if(!student) return;

            window.showNotif("Menyimpan data...");
            const batch = writeBatch(db);
            let loopDate = new Date(startDate);

            while(loopDate <= endDate) {
                const dateStr = loopDate.toISOString().split('T')[0];
                if (loopDate.getDay() !== 0) { // Skip Minggu
                     const existing = window.appState.attendance.find(a => a.studentId === studentId && a.date === dateStr);
                     const attRef = existing 
                        ? doc(db, 'artifacts', appId, 'users', window.appState.teacherId, 'attendance', existing.id)
                        : doc(collection(db, 'artifacts', appId, 'users', window.appState.teacherId, 'attendance'));
                     
                     batch.set(attRef, {
                        studentId: studentId,
                        studentName: student.nama_siswa,
                        studentClass: student.kelas,
                        date: dateStr,
                        status: status,
                        note: note || '',
                        timestamp: new Date().toISOString(),
                        semester: window.appState.settings.semester
                     }, { merge: true });
                }
                loopDate.setDate(loopDate.getDate() + 1);
            }
            
            await batch.commit();
            window.showNotif("Izin/Sakit Berhasil Disimpan");
            e.target.reset();
            window.renderApp(); // Refresh view to show updated data
        };

        // Fungsi Hapus Izin Per Tanggal (bukan range, karena di DB disimpan per hari)
        window.deleteAttendanceDay = (attId) => {
            window.confirmAction("Hapus Izin", "Yakin ingin menghapus status izin/sakit siswa pada tanggal ini?", async () => {
                await deleteDoc(doc(db, 'artifacts', appId, 'users', window.appState.teacherId, 'attendance', attId));
                window.showNotif("Status Dihapus");
                window.appState.modal.show = false;
                window.renderOverlays();
                window.renderApp();
            });
        };

        // --- 4. FIREBASE LISTENERS ---
        window.initDataListeners = () => {
            if (!auth.currentUser || !window.appState.teacherId) return;
            const tId = window.appState.teacherId;
            const userRef = (col) => collection(db, 'artifacts', appId, 'users', tId, col);
            const profileRef = doc(db, 'artifacts', appId, 'users', tId, 'settings', 'profile');
            
            onSnapshot(profileRef, (snap) => { 
                if (snap.exists()) { 
                    window.appState.settings = { ...window.appState.settings, ...snap.data() }; 
                    if (!window.appState.selectedKelas && window.appState.settings.kelas_diampu?.length > 0) {
                        window.appState.selectedKelas = window.appState.settings.kelas_diampu[0];
                    } else if (!window.appState.selectedKelas) {
                        window.appState.selectedKelas = '1';
                    }
                    window.renderApp(); 
                } 
            });
            onSnapshot(userRef('students'), (snap) => { window.appState.students = snap.docs.map(d => ({ id: d.id, ...d.data() })); window.renderApp(); });
            onSnapshot(userRef('journals'), (snap) => { window.appState.journals = snap.docs.map(d => ({ id: d.id, ...d.data() })); window.renderApp(); });
            onSnapshot(userRef('attendance'), (snap) => { 
                window.appState.attendance = snap.docs.map(d => ({ id: d.id, ...d.data() })); 
                if (window.appState.finishStep !== 2) { window.renderApp(); }
            });
            onSnapshot(userRef('mapels'), (snap) => { window.appState.mapels = snap.docs.map(d => ({ id: d.id, ...d.data() })); window.renderApp(); });
            onSnapshot(userRef('holidays'), (snap) => { window.appState.holidays = snap.docs.map(d => ({ id: d.id, ...d.data() })); window.renderApp(); });
        };

        // --- 5. AUTH ---
        window.handlePinLogin = async (e) => {
            e.preventDefault();
            const pinValue = e.target.pin.value;
            window.appState.isLoggingIn = true;
            const btn = e.target.querySelector('button');
            if(btn) { btn.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin mr-2"></i> Memeriksa...'; btn.classList.add('opacity-75', 'cursor-wait'); }
            try {
                const securityRef = collection(db, 'artifacts', appId, 'public', 'data', 'security');
                const snapshot = await getDocs(securityRef);
                let foundTeacherId = null;
                snapshot.forEach(doc => { if (doc.data().pin?.toString() === pinValue) foundTeacherId = doc.id; });
                if (foundTeacherId) {
                    window.appState.teacherId = foundTeacherId; window.appState.isAuthenticated = true; window.initDataListeners(); window.setView('dashboard');
                } else { window.showNotif("Kode PIN Tidak Terdaftar!", "error"); window.appState.isLoggingIn = false; window.renderApp(); }
            } catch (err) { window.appState.loginError = "Gagal Verifikasi"; window.appState.isLoggingIn = false; window.renderApp(); }
        };

        window.handleLogout = async () => {
            await window.stopScanner();
            window.appState.isAuthenticated = false; window.appState.teacherId = null; window.appState.selectedKelas = '';
            window.renderApp(); setTimeout(() => { const pinInput = document.querySelector('input[name="pin"]'); if (pinInput) pinInput.value = ''; }, 100);
            window.open(hubUrl, '_blank');
        };

        window.toggleSemester = async () => {
            const newSem = window.appState.settings.semester === '1' ? '2' : '1';
            await setDoc(doc(db, 'artifacts', appId, 'users', window.appState.teacherId, 'settings', 'profile'), { semester: newSem }, { merge: true });
            window.appState.settings.semester = newSem; window.renderApp(); window.showNotif(`Semester diubah ke ${newSem}`);
        };

        // --- 6. DATA ACTIONS ---
        const getColRef = (col) => collection(db, 'artifacts', appId, 'users', window.appState.teacherId, col);

        window.deleteDocData = (col, id) => {
            window.confirmAction("Hapus Data", "Data akan dihapus permanen. Lanjutkan?", async () => {
                await deleteDoc(doc(db, 'artifacts', appId, 'users', window.appState.teacherId, col, id));
                window.showNotif("Terhapus"); window.appState.modal.show = false; window.renderOverlays(); window.renderApp();
            });
        };

        window.deleteTP = (mapelId, tpIdx) => {
            window.confirmAction("Hapus TP", "TP ini akan dihapus. Lanjutkan?", async () => {
                const mapel = window.appState.mapels.find(m => m.id === mapelId);
                if (!mapel) return;
                const newTP = [...mapel.tp]; newTP.splice(tpIdx, 1);
                await updateDoc(doc(db, 'artifacts', appId, 'users', window.appState.teacherId, 'mapels', mapelId), { tp: newTP });
                window.showNotif("TP Terhapus"); window.appState.modal.show = false; window.renderOverlays(); window.renderApp();
            });
        };

        window.addTPToExisting = async (mapelId) => {
            const input = document.getElementById(`new-tp-${mapelId}`);
            const val = input.value.trim(); if (!val) return;
            const mapel = window.appState.mapels.find(m => m.id === mapelId); if (!mapel) return;
            const newTP = Array.isArray(mapel.tp) ? [...mapel.tp, val] : [val];
            await updateDoc(doc(db, 'artifacts', appId, 'users', window.appState.teacherId, 'mapels', mapelId), { tp: newTP });
            input.value = ''; window.showNotif("TP Berhasil Ditambahkan"); window.renderApp();
        };

        window.handleEditStudent = (id) => {
            const student = window.appState.students.find(s => s.id === id); if (!student) return;
            window.appState.editModal = { show: true, id, name: student.nama_siswa }; window.renderOverlays();
            setTimeout(() => { const inp = document.getElementById('edit-student-input'); if(inp) { inp.focus(); inp.select(); } }, 50);
        };

        window.saveStudentName = async () => {
            const { id } = window.appState.editModal; const newName = document.getElementById('edit-student-input').value;
            if (newName && newName.trim() !== "") {
                await updateDoc(doc(db, 'artifacts', appId, 'users', window.appState.teacherId, 'students', id), { nama_siswa: newName.trim() });
                window.showNotif("Nama berhasil diubah"); window.appState.editModal.show = false; window.renderOverlays(); window.renderApp();
            }
        };

        window.handleResetAttendance = async () => {
            const month = document.getElementById('reset-month-picker').value; if (!month) return window.showNotif("Pilih bulan terlebih dahulu!", "error");
            window.confirmAction("Reset Presensi", `Hapus seluruh data presensi di bulan ${month}? Tindakan ini tidak dapat dibatalkan.`, async () => {
                const toDelete = window.appState.attendance.filter(a => a.date.startsWith(month));
                if (toDelete.length === 0) { window.showNotif("Tidak ada data presensi", "error"); window.appState.modal.show = false; window.renderOverlays(); return; }
                window.showNotif("Sedang menghapus...");
                const batchSize = 400; 
                for (let i = 0; i < toDelete.length; i += batchSize) {
                    const batch = writeBatch(db); const chunk = toDelete.slice(i, i + batchSize);
                    chunk.forEach(a => { batch.delete(doc(db, 'artifacts', appId, 'users', window.appState.teacherId, 'attendance', a.id)); });
                    await batch.commit();
                }
                window.showNotif(`Sukses mereset ${toDelete.length} data`); window.appState.modal.show = false; window.renderOverlays(); window.renderApp();
            });
        };

        window.handleBulkStudents = async (e) => {
            e.preventDefault(); const formData = new FormData(e.target);
            const grade = formData.get('grade'); const namesText = formData.get('names');
            let names = [...new Set(namesText.split('\n').map(n => n.trim()).filter(n => n.length > 0))];
            const existing = window.appState.students.filter(s => s.kelas === grade).map(s => s.nama_siswa.toLowerCase());
            const newNames = names.filter(n => !existing.includes(n.toLowerCase()));
            if (newNames.length === 0) { window.showNotif("Nama sudah ada", "error"); return; }
            const batch = writeBatch(db);
            newNames.forEach(nama => { const newDoc = doc(getColRef('students')); batch.set(newDoc, { nama_siswa: nama, kelas: grade, createdAt: new Date().toISOString() }); });
            await batch.commit(); e.target.reset(); window.showNotif(`${newNames.length} Siswa Tersimpan`);
        };

        window.handleSaveMapel = async (e) => {
            e.preventDefault(); const data = Object.fromEntries(new FormData(e.target).entries());
            const isDup = window.appState.mapels.some(m => m.kelas === data.kelas && m.nama.toLowerCase() === data.nama_mapel.toLowerCase());
            if (isDup) { window.showNotif("Mapel sudah ada", "error"); return; }
            await addDoc(getColRef('mapels'), { kelas: data.kelas, nama: data.nama_mapel, tp: data.tujuan_pembelajaran.split('\n').filter(t => t.trim().length > 0) });
            e.target.reset(); window.showNotif("Mapel Tersimpan");
        };

        window.handleSaveJournal = async (e) => {
            e.preventDefault(); const data = Object.fromEntries(new FormData(e.target).entries());
            const isDup = window.appState.journals.some(j => j.tanggal === data.tanggal && j.kelas_mengajar === data.kelas_mengajar && j.jam_ke === data.jam_ke);
            if (isDup) { window.showNotif("Jurnal jam ini sudah ada!", "error"); return; }
            const isHoliday = window.appState.holidays.find(h => h.tanggal === data.tanggal);
            if (isHoliday && !data.is_kerja_khusus) { window.showNotif("Hari Libur!", "error"); return; }
            data.createdAt = new Date().toISOString(); data.semester = window.appState.settings.semester;
            const classStudents = window.appState.students.filter(s => String(s.kelas) === String(data.kelas_mengajar));
            const attToday = window.appState.attendance.filter(a => a.date === data.tanggal && String(a.studentClass) === String(data.kelas_mengajar));
            data.hadir = attToday.filter(a => a.status === 'Hadir').length; data.izin = attToday.filter(a => a.status === 'Izin').length;
            data.sakit = attToday.filter(a => a.status === 'Sakit').length; data.alpa = classStudents.length - (data.hadir + data.izin + data.sakit);
            await addDoc(getColRef('journals'), data); window.showNotif("Jurnal Tersimpan"); window.setView('history');
        };

        window.handleSaveHoliday = async (e) => {
            e.preventDefault(); const data = Object.fromEntries(new FormData(e.target).entries());
            if (window.appState.holidays.some(h => h.tanggal === data.tanggal)) { window.showNotif("Tanggal sudah ada", "error"); return; }
            await addDoc(getColRef('holidays'), data); e.target.reset(); window.showNotif("Libur Ditambahkan");
        };

        window.handleSaveSettings = async (e) => { 
            e.preventDefault(); const formData = new FormData(e.target); const data = Object.fromEntries(formData.entries()); 
            data.kelas_diampu = formData.getAll('kelas_diampu');
            await setDoc(doc(db, 'artifacts', appId, 'users', window.appState.teacherId, 'settings', 'profile'), data); 
            window.showNotif("Profil Disimpan"); 
        };

        window.handlePromotion = () => {
            window.confirmAction("Naik Kelas", "Siswa akan naik tingkat.", async () => {
                const class6 = window.appState.students.filter(s => s.kelas === "6");
                if (class6.length > 0) {
                    let csv = "Nama,Kelas,H,I,S,A\n";
                    class6.forEach(s => { const att = window.appState.attendance.filter(a => a.studentId === s.id); csv += `${s.nama_siswa},6,${att.filter(x=>x.status==='Hadir').length},${att.filter(x=>x.status==='Izin').length},${att.filter(x=>x.status==='Sakit').length},${att.filter(x=>x.status==='Alpa').length}\n`; });
                    saveAs(new Blob([csv], { type: 'text/csv;charset=utf-8;' }), `Arsip_Lulusan_Kelas6.csv`);
                }
                const batch = writeBatch(db);
                window.appState.students.forEach(s => { const sRef = doc(db, 'artifacts', appId, 'users', window.appState.teacherId, 'students', s.id); if (s.kelas === "6") batch.delete(sRef); else batch.update(sRef, { kelas: String(Number(s.kelas) + 1) }); });
                await batch.commit(); window.showNotif("Kenaikan Kelas Berhasil"); window.appState.modal.show = false; window.renderOverlays(); window.renderApp();
            });
        };

        window.handleClearData = () => {
            window.confirmAction("BERSIHKAN DATABASE", "Seluruh data akun Anda akan dihapus permanen! Lanjutkan?", async () => {
                const collections = ['students', 'journals', 'attendance', 'mapels', 'holidays'];
                for (const colName of collections) { const snap = await getDocs(getColRef(colName)); const batch = writeBatch(db); snap.forEach(d => batch.delete(d.ref)); await batch.commit(); }
                window.showNotif("Database Bersih"); window.appState.modal.show = false; window.renderOverlays(); window.renderApp();
            });
        };

        // --- 8. QR CODE VIEW ---
        window.viewQR = (student) => { window.appState.qrModal = { show: true, student }; window.renderOverlays(); };
        window.downloadQR = (name) => { const container = document.getElementById('qr-canvas-render'); const canvas = container.querySelector('canvas'); const img = container.querySelector('img'); let src = canvas ? canvas.toDataURL("image/png") : (img ? img.src : ""); if (src) { const link = document.createElement('a'); link.href = src; link.download = `QR_${name.replace(/\s+/g, '_')}.png`; link.click(); } else window.showNotif("Gagal unduh QR", "error"); };
        window.downloadBulkQR = async () => { const zip = new JSZip(); const folder = zip.folder("QR_Siswa_Database"); window.showNotif("Memproses ZIP...", "warning"); const tempDiv = document.createElement('div'); tempDiv.style.position = "absolute"; tempDiv.style.left = "-9999px"; document.body.appendChild(tempDiv); for (const s of window.appState.students) { tempDiv.innerHTML = ""; new QRCode(tempDiv, { text: s.nama_siswa, width: 300, height: 300 }); await new Promise(r => setTimeout(r, 200)); const canvas = tempDiv.querySelector('canvas'); let src = canvas ? canvas.toDataURL("image/png") : null; if (src) folder.file(`KLS${s.kelas}_${s.nama_siswa.replace(/\s+/g, '_')}.png`, src.split(',')[1], {base64: true}); } document.body.removeChild(tempDiv); const content = await zip.generateAsync({type:"blob"}); saveAs(content, "Database_QR_Siswa.zip"); window.showNotif("Selesai"); };

        // --- 9. SCANNER ---
        window.switchCamera = async () => { window.appState.cameraFacingMode = window.appState.cameraFacingMode === "environment" ? "user" : "environment"; const readerEl = document.getElementById('reader'); if (readerEl) { if (window.appState.cameraFacingMode === 'user') { readerEl.classList.add('mirror-mode'); } else { readerEl.classList.remove('mirror-mode'); } } await window.stopScanner(); setTimeout(window.startScanner, 200); };
        window.restartScanner = async () => { await window.stopScanner(); setTimeout(window.startScanner, 200); };
        window.startScanner = async () => {
            const container = document.getElementById('reader'); if (!container || window.appState.isScannerStarting) return;
            if (window.appState.cameraFacingMode === 'user') container.classList.add('mirror-mode'); else container.classList.remove('mirror-mode');
            if (location.protocol !== 'https:' && location.hostname !== 'localhost') { window.showNotif("HTTPS diperlukan untuk akses kamera.", "error"); return; }
            window.appState.isScannerStarting = true;
            try {
                await window.stopScanner(); window.appState.html5QrCode = new window.Html5Qrcode("reader");
                window.appState.scannerActive = true; 
                await window.appState.html5QrCode.start({ facingMode: window.appState.cameraFacingMode }, { fps: 20, qrbox: (viewfinderWidth, viewfinderHeight) => { const minEdge = Math.min(viewfinderWidth, viewfinderHeight); const qrboxSize = Math.floor(minEdge * 0.85); return { width: qrboxSize, height: qrboxSize }; }, aspectRatio: 1.0 }, async (text) => {
                        if (window.appState.scannerLock) return;
                        const student = window.appState.students.find(s => (s.kode_qr && s.kode_qr === text) || s.nama_siswa.toLowerCase() === text.trim().toLowerCase());
                        if (student) {
                            const isAlreadyPresent = window.appState.attendance.some(a => a.studentId === student.id && a.date === window.appState.selectedDate && a.status === 'Hadir');
                            if (!isAlreadyPresent) {
                                window.appState.scannerLock = true; await window.markAttendance(student.id, 'Hadir');
                                window.appState.scanSuccessPopup = { show: true, studentName: student.nama_siswa }; window.renderApp();
                                const mode = window.appState.settings.voiceMode || 'mute';
                                if (mode === 'tts') window.speakText(`${student.nama_siswa} Hadir`); else if (mode === 'beep') window.playBeep();
                                if (navigator.vibrate) navigator.vibrate([100, 50, 100]);
                                await window.appState.html5QrCode.stop();
                                setTimeout(async () => { window.appState.scanSuccessPopup.show = false; window.appState.scannerLock = false; window.renderApp(); await window.startScanner(); }, 2000);
                            } else { window.appState.scannerLock = true; window.showNotif(`${student.nama_siswa} sudah presensi hari ini`, "warning"); setTimeout(() => { window.appState.scannerLock = false; }, 3000); }
                        } else { window.appState.scannerLock = true; window.showNotif("QR Code tidak dikenal", "error"); setTimeout(() => { window.appState.scannerLock = false; }, 2000); }
                    }, () => {});
            } catch (err) { window.showNotif("Gagal akses kamera.", "error"); window.appState.scannerActive = false; } finally { window.appState.isScannerStarting = false; }
        };
        window.stopScanner = async () => { if (window.appState.html5QrCode) { try { if (window.appState.html5QrCode.isScanning) await window.appState.html5QrCode.stop(); await window.appState.html5QrCode.clear(); } catch(e) {} finally { window.appState.html5QrCode = null; window.appState.scannerActive = false; } } };

        window.markAttendance = async (id, status = 'Hadir') => {
            const today = window.appState.selectedDate;
            const existing = window.appState.attendance.find(a => a.studentId === id && a.date === today);
            const student = window.appState.students.find(s => s.id === id); if (!student) return;
            const data = { studentId: id, studentName: student.nama_siswa, studentClass: student.kelas, date: today, status, timestamp: new Date().toISOString(), semester: window.appState.settings.semester };
            if (existing) await updateDoc(doc(db, 'artifacts', appId, 'users', window.appState.teacherId, 'attendance', existing.id), data); else await addDoc(getColRef('attendance'), data);
        };

        window.markAllPresent = async (kelas) => {
            const students = window.appState.students.filter(s => String(s.kelas) === String(kelas));
            if (students.length === 0) return; window.showNotif("Memproses Presensi Bulk..."); const batch = writeBatch(db); const today = window.appState.selectedDate;
            for (const s of students) {
                const existing = window.appState.attendance.find(a => a.studentId === s.id && a.date === today);
                const data = { studentId: s.id, studentName: s.nama_siswa, studentClass: s.kelas, date: today, status: 'Hadir', timestamp: new Date().toISOString(), semester: window.appState.settings.semester };
                if (existing) batch.update(doc(db, 'artifacts', appId, 'users', window.appState.teacherId, 'attendance', existing.id), data); else batch.set(doc(getColRef('attendance')), data);
            }
            await batch.commit(); window.showNotif("Semua Siswa Hadir");
        };

        // --- 10. EXPORTS (UPDATED V2) ---
        window.exportFormal = (type, format) => {
            const curSem = window.appState.settings.semester; const sets = window.appState.settings;
            const targetMonth = type === 'reports' ? window.appState.reportMonth : window.appState.historyMonth;
            const viewType = window.appState.reportViewType;
            
            if (format === 'csv') {
                let csvContent = "\uFEFF"; // BOM for Excel
                if (type === 'journals') {
                    csvContent += "No,Hari,Tanggal,Jam Ke,Kelas,Mata Pelajaran,Materi/TP,Hadir,Izin,Sakit,Alpa,Catatan\n";
                    window.appState.journals
                        .filter(j => j.semester === curSem && j.tanggal.startsWith(targetMonth))
                        .sort((a,b) => { if (a.tanggal !== b.tanggal) return b.tanggal.localeCompare(a.tanggal); return a.jam_ke - b.jam_ke; })
                        .forEach((j, i) => {
                            const tp = `"${(j.tujuan_pembelajaran || '').replace(/"/g, '""')}"`;
                            const cat = `"${(j.catatan || '').replace(/"/g, '""')}"`;
                            csvContent += `${i+1},${window.getDayName(j.tanggal)},${j.tanggal},${j.jam_ke},${j.kelas_mengajar},${j.mata_pelajaran},${tp},${j.hadir},${j.izin||0},${j.sakit||0},${j.alpa},${cat}\n`;
                        });
                } else if (type === 'reports') {
                    if (viewType === 'rinci') {
                        const year = parseInt(targetMonth.split('-')[0]);
                        const month = parseInt(targetMonth.split('-')[1]);
                        const daysInMonth = new Date(year, month, 0).getDate();
                        let header = "No,Nama Siswa"; for (let i = 1; i <= daysInMonth; i++) { header += `,${i}`; } header += ",H,I,S,A\n";
                        csvContent += header;
                        window.appState.students
                            .filter(s => String(s.kelas) === String(window.appState.selectedKelas))
                            .sort((a,b)=>a.nama_siswa.localeCompare(b.nama_siswa))
                            .forEach((s, idx) => {
                                let row = `${idx+1},"${s.nama_siswa}"`;
                                const attMonth = window.appState.attendance.filter(a => a.studentId === s.id && a.date.startsWith(targetMonth));
                                for (let i = 1; i <= daysInMonth; i++) {
                                    const dayStr = `${targetMonth}-${String(i).padStart(2, '0')}`;
                                    const attDay = attMonth.find(a => a.date === dayStr);
                                    let statusChar = '-';
                                    if (attDay?.status === 'Hadir') statusChar = 'H';
                                    else if (attDay?.status === 'Izin') statusChar = 'I';
                                    else if (attDay?.status === 'Sakit') statusChar = 'S';
                                    else if (attDay?.status === 'Alpa') statusChar = 'A';
                                    row += `,${statusChar}`;
                                }
                                row += `,${attMonth.filter(x=>x.status==='Hadir').length},${attMonth.filter(x=>x.status==='Izin').length},${attMonth.filter(x=>x.status==='Sakit').length},${attMonth.filter(x=>x.status==='Alpa').length}\n`;
                                csvContent += row;
                            });
                    } else {
                        csvContent += "No,Nama Siswa,Hadir,Izin,Sakit,Alpa\n";
                        window.appState.students
                            .filter(s => String(s.kelas) === String(window.appState.selectedKelas))
                            .sort((a,b)=>a.nama_siswa.localeCompare(b.nama_siswa))
                            .forEach((s, i) => { 
                                const att = window.appState.attendance.filter(a => a.studentId === s.id && a.semester === curSem && a.date.startsWith(targetMonth)); 
                                csvContent += `${i+1},"${s.nama_siswa}",${att.filter(x=>x.status==='Hadir').length},${att.filter(x=>x.status==='Izin').length},${att.filter(x=>x.status==='Sakit').length},${att.filter(x=>x.status==='Alpa').length}\n`; 
                            });
                    }
                }
                saveAs(new Blob([csvContent], { type: 'text/csv;charset=utf-8;' }), `Laporan_${targetMonth}_${type}_${viewType}.csv`);
            } else {
                const isLandscape = type === 'journals' || (type === 'reports' && viewType === 'rinci');
                const { jsPDF } = window.jspdf; 
                const docPdf = new jsPDF(isLandscape ? 'l' : 'p', 'mm', 'a4');
                const pageWidth = docPdf.internal.pageSize.getWidth();
                const pageHeight = docPdf.internal.pageSize.getHeight();

                docPdf.setFont("helvetica", "bold"); docPdf.setFontSize(14); docPdf.text((sets.nama_sekolah || "SEKOLAH DASAR NEGERI CONTOH").toUpperCase(), pageWidth / 2, 15, { align: 'center' });
                docPdf.setFontSize(10); docPdf.setFont("helvetica", "normal"); docPdf.text(`Tahun Pelajaran: ${sets.tahun_ajaran || '-'}`, pageWidth / 2, 20, { align: 'center' });
                docPdf.setLineWidth(0.5); docPdf.line(10, 24, pageWidth - 10, 24);
                
                docPdf.setFont("helvetica", "bold"); docPdf.setFontSize(12);
                let title = type === 'journals' ? "JURNAL KEGIATAN PEMBELAJARAN" : `LAPORAN ABSENSI SISWA (${viewType.toUpperCase()})`;
                docPdf.text(title, pageWidth / 2, 32, { align: 'center' });
                
                docPdf.setFontSize(10); docPdf.setFont("helvetica", "normal");
                docPdf.text(`Kelas: ${window.appState.selectedKelas || '-'}`, 14, 40); docPdf.text(`Bulan: ${targetMonth}`, 14, 45);
                docPdf.text(`Semester: ${curSem}`, pageWidth - 14, 40, { align: 'right' }); docPdf.text(`Guru: ${sets.nama_guru || '-'}`, pageWidth - 14, 45, { align: 'right' });

                const startY = 50;
                const commonStyles = { fontSize: 8, cellPadding: 2, lineWidth: 0.1, lineColor: [200, 200, 200] };
                const headStyles = { fillColor: [37, 99, 235], textColor: 255, fontStyle: 'bold', halign: 'center', valign: 'middle' };

                if (type === 'journals') {
                    let lastDate = '';
                    const body = window.appState.journals.filter(j => j.semester === curSem && j.tanggal.startsWith(targetMonth)).sort((a,b) => { if (a.tanggal !== b.tanggal) return b.tanggal.localeCompare(a.tanggal); return a.jam_ke - b.jam_ke; }).map((j, i) => { let displayDate = j.tanggal; let displayDay = window.getDayName(j.tanggal); if (displayDate === lastDate) { displayDate = ''; displayDay = ''; } else { lastDate = j.tanggal; } return [i+1, displayDay, displayDate, j.jam_ke, j.kelas_mengajar, j.mata_pelajaran, j.tujuan_pembelajaran, j.hadir, j.izin||0, j.sakit||0, j.alpa, j.catatan||'-']; });
                    docPdf.autoTable({ theme: 'grid', head: [['No', 'Hari', 'Tgl', 'Jam', 'Kls', 'Mapel', 'Materi/TP', 'H', 'I', 'S', 'A', 'Catatan']], body, startY, styles: commonStyles, headStyles, columnStyles: { 0: { cellWidth: 8, halign: 'center' }, 1: { cellWidth: 15 }, 2: { cellWidth: 18 }, 3: { cellWidth: 10, halign: 'center' }, 4: { cellWidth: 10, halign: 'center' }, 5: { cellWidth: 30 }, 6: { cellWidth: 'auto' }, 7: { cellWidth: 7, halign: 'center' }, 8: { cellWidth: 7, halign: 'center' }, 9: { cellWidth: 7, halign: 'center' }, 10: { cellWidth: 7, halign: 'center' }, 11: { cellWidth: 40 } } });
                } else if (type === 'reports') {
                    if (viewType === 'rinci') {
                        const year = parseInt(targetMonth.split('-')[0]); const month = parseInt(targetMonth.split('-')[1]); const daysInMonth = new Date(year, month, 0).getDate();
                        const dayHeaders = Array.from({length: daysInMonth}, (_, i) => { const dStr = `${targetMonth}-${String(i+1).padStart(2, '0')}`; const dateObj = new Date(dStr); const dayIndex = dateObj.getDay(); const dayInitials = ['M', 'S', 'S', 'R', 'K', 'J', 'S']; return `${i+1}\n${dayInitials[dayIndex]}`; });
                        const head = [['No', 'Nama', ...dayHeaders, 'H', 'I', 'S', 'A']];
                        const body = window.appState.students.filter(s => String(s.kelas) === String(window.appState.selectedKelas)).sort((a,b)=>a.nama_siswa.localeCompare(b.nama_siswa)).map((s, i) => { const attMonth = window.appState.attendance.filter(a => a.studentId === s.id && a.date.startsWith(targetMonth)); const dayCells = Array.from({length: daysInMonth}, (_, d) => { const dayStr = `${targetMonth}-${String(d+1).padStart(2, '0')}`; const attDay = attMonth.find(a => a.date === dayStr); if (attDay?.status === 'Hadir') return 'H'; if (attDay?.status === 'Izin') return 'I'; if (attDay?.status === 'Sakit') return 'S'; if (attDay?.status === 'Alpa') return 'A'; return ''; }); return [i+1, s.nama_siswa, ...dayCells, attMonth.filter(x=>x.status==='Hadir').length, attMonth.filter(x=>x.status==='Izin').length, attMonth.filter(x=>x.status==='Sakit').length, attMonth.filter(x=>x.status==='Alpa').length]; });
                        docPdf.autoTable({ theme: 'grid', head, body, startY, styles: { ...commonStyles, fontSize: 7, cellPadding: 1 }, headStyles, columnStyles: { 0: { cellWidth: 10, halign: 'center' }, 1: { cellWidth: 50, fontStyle: 'bold' } }, didParseCell: function(data) { if (data.section === 'head' && data.column.index >= 2) { const dayIndex = data.column.index - 2; const dStr = `${targetMonth}-${String(dayIndex+1).padStart(2, '0')}`; if (window.isHoliday(dStr)) { data.cell.styles.textColor = [255, 200, 200]; } } } });
                    } else {
                        const body = window.appState.students.filter(s => String(s.kelas) === String(window.appState.selectedKelas)).sort((a,b)=>a.nama_siswa.localeCompare(b.nama_siswa)).map((s, i) => { const att = window.appState.attendance.filter(a => a.studentId === s.id && a.semester === curSem && a.date.startsWith(targetMonth)); return [i+1, s.nama_siswa, att.filter(x=>x.status==='Hadir').length, att.filter(x=>x.status==='Izin').length, att.filter(x=>x.status==='Sakit').length, att.filter(x=>x.status==='Alpa').length]; });
                        docPdf.autoTable({ theme: 'grid', head: [['No', 'Nama Siswa', 'Hadir', 'Izin', 'Sakit', 'Alpa']], body, startY, styles: { ...commonStyles, fontSize: 10, cellPadding: 3 }, headStyles, columnStyles: { 0: { cellWidth: 15, halign: 'center' }, 1: { cellWidth: 'auto' }, 2: { cellWidth: 20, halign: 'center' }, 3: { cellWidth: 20, halign: 'center' }, 4: { cellWidth: 20, halign: 'center' }, 5: { cellWidth: 20, halign: 'center' } } });
                    }
                }
                
                const finalY = docPdf.lastAutoTable.finalY + 20; let sigY = finalY;
                if (sigY + 40 > pageHeight) { docPdf.addPage(); sigY = 20; }
                const dateSig = `${sets.lokasi || "Tempat"}, ${new Date().toLocaleDateString('id-ID', {day:'numeric', month:'long', year:'numeric'})}`;
                docPdf.setFont("helvetica", "normal"); docPdf.setFontSize(10);
                docPdf.text("Mengetahui,", 20, sigY); docPdf.text("Kepala Sekolah", 20, sigY + 5);
                docPdf.setFont("helvetica", "bold"); docPdf.text(sets.nama_kepsek || "(.......................)", 20, sigY + 30);
                docPdf.setFont("helvetica", "normal"); docPdf.text(`NIP. ${sets.nip_kepsek || "-" }`, 20, sigY + 35);
                const rightX = pageWidth - 60; 
                docPdf.text(dateSig, rightX, sigY); docPdf.text("Guru Kelas", rightX, sigY + 5);
                docPdf.setFont("helvetica", "bold"); docPdf.text(sets.nama_guru || "(.......................)", rightX, sigY + 30);
                docPdf.setFont("helvetica", "normal"); docPdf.text(`NIP. ${sets.nip_guru || "-" }`, rightX, sigY + 35);
                docPdf.save(`Laporan_${targetMonth}_${type}_${viewType}.pdf`);
            }
        };

        // --- 11. ROUTING ---
        window.setView = async (v) => { 
            await window.stopScanner(); window.appState.currentView = v; window.appState.mobileMenuOpen = false; window.renderApp(); lucide.createIcons();
            if (v === 'scanner') setTimeout(() => { if (document.getElementById('reader')) window.startScanner(); const mode = window.appState.settings.voiceMode || 'mute'; if (mode === 'tts') setTimeout(() => window.speakText("Sistem presensi sudah siap"), 800); }, 500);
            if (v === 'dashboard') setTimeout(() => window.initChart(), 500);
        };

        window.initChart = () => {
            const canvas = document.getElementById('attendanceChart'); if (!canvas) return;
            const dates = [...new Set(window.appState.attendance.filter(a=>a.semester===window.appState.settings.semester).map(a => a.date))].sort().slice(-7);
            const dataHadir = dates.map(d => window.appState.attendance.filter(a => a.date === d && a.status === 'Hadir').length);
            if (window.myChart) window.myChart.destroy();
            window.myChart = new Chart(canvas.getContext('2d'), { type: 'bar', data: { labels: dates, datasets: [{ label: 'Jumlah Hadir', data: dataHadir, backgroundColor: '#2563eb', borderRadius: 8 }] }, options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } } } });
        };

        window.renderNavItem = (view, icon, label) => {
            const active = window.appState.currentView === view; const collapsed = window.appState.sidebarCollapsed;
            return `<button onclick="window.setView('${view}')" class="flex items-center gap-4 px-4 py-4 rounded-2xl transition-all ${active ? 'bg-blue-600 text-white shadow-lg' : 'text-slate-500 hover:bg-slate-50'} w-full text-left outline-none border-none group relative overflow-hidden" title="${label}"><div class="w-6 text-center text-lg shrink-0 flex justify-center"><i class="fa-solid ${icon}"></i></div><span class="text-[11px] font-black uppercase tracking-tight whitespace-nowrap overflow-hidden transition-all duration-300 ${collapsed ? 'w-0 opacity-0' : 'w-full opacity-100 delay-100'} text-left">${label}</span></button>`;
        };

        window.handleSearchInput = (el, stateKey) => { window.appState[stateKey] = el.value; window.appState.lastFocusedId = el.id; window.appState.lastCaretPos = el.selectionStart; window.renderApp(); };

        window.renderOverlays = () => {
            const mount = document.getElementById('overlay-mount'); if (!mount) return;
            let content = '';
            if (window.appState.modal.show) content += `<div class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-[99999] flex items-center justify-center p-6 pointer-events-auto"><div class="bg-white rounded-[2.5rem] p-8 max-w-sm w-full shadow-2xl animate-popIn text-center"><h3 class="text-xl font-black uppercase text-rose-600 mb-2 text-center">${window.appState.modal.title}</h3><p class="text-sm text-slate-500 font-medium mb-8 text-center whitespace-pre-line">${window.appState.modal.message}</p><div class="flex gap-3 text-center"><button onclick="window.appState.modal.show = false; window.renderOverlays();" class="flex-1 bg-slate-100 py-3 rounded-xl font-black uppercase text-[10px] tracking-widest text-center">Batal</button><button onclick="window.appState.modal.onConfirm()" class="flex-1 bg-rose-600 text-white py-3 rounded-xl font-black uppercase text-[10px] tracking-widest text-center">Ya, Lanjutkan</button></div></div></div>`;
            if (window.appState.editModal.show) content += `<div class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-[99999] flex items-center justify-center p-6 pointer-events-auto"><div class="bg-white rounded-[2.5rem] p-8 max-w-sm w-full shadow-2xl animate-popIn text-center"><h3 class="text-xl font-black uppercase text-blue-600 mb-2 text-center">Edit Siswa</h3><input type="text" id="edit-student-input" value="${window.appState.editModal.name}" class="w-full bg-slate-50 rounded-xl p-4 font-black text-center mb-6 border-none outline-none text-slate-800" onkeydown="if(event.key === 'Enter') window.saveStudentName()"><div class="flex gap-3 text-center"><button onclick="window.appState.editModal.show = false; window.renderOverlays();" class="flex-1 bg-slate-100 py-3 rounded-xl font-black uppercase text-[10px] tracking-widest text-center">Batal</button><button onclick="window.saveStudentName()" class="flex-1 bg-blue-600 text-white py-3 rounded-xl font-black uppercase text-[10px] tracking-widest text-center">Simpan</button></div></div></div>`;
            if (window.appState.qrModal.show) { content += `<div class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-[99999] flex items-center justify-center p-6 pointer-events-auto"><div class="bg-white rounded-[3rem] p-8 md:p-10 max-w-[320px] w-full shadow-2xl text-center animate-popIn"><h3 class="text-lg font-black uppercase mb-6 text-center text-slate-800">${window.appState.qrModal.student.nama_siswa}</h3><div id="qr-canvas-render" class="bg-white p-4 rounded-3xl border-4 border-slate-50 flex justify-center items-center mb-8 mx-auto w-[200px] h-[200px] md:w-[256px] md:h-[256px] text-center overflow-hidden"></div><div class="flex flex-col gap-2 text-center"><button onclick="window.downloadQR('${window.appState.qrModal.student.nama_siswa}')" class="bg-blue-600 text-white py-4 rounded-2xl font-black uppercase text-[10px] tracking-widest flex items-center justify-center gap-2 text-center transition-all hover:bg-blue-700 shadow-lg"><i class="fa-solid fa-download mr-2"></i> Simpan PNG</button><button onclick="window.appState.qrModal.show = false; window.renderOverlays();" class="bg-slate-100 text-slate-500 py-4 rounded-2xl font-black uppercase text-[10px] tracking-widest text-center hover:bg-slate-200 transition-all">Tutup</button></div></div></div>`; setTimeout(() => { const container = document.getElementById('qr-canvas-render'); if (container && container.innerHTML === "") new QRCode(container, { text: window.appState.qrModal.student.nama_siswa, width: 256, height: 256, correctLevel : QRCode.CorrectLevel.H }); }, 10); }
            if (window.appState.finishStep === 1) content += `<div class="fixed inset-0 bg-black/90 backdrop-blur-sm z-[99999] flex items-center justify-center p-6 pointer-events-auto"><div class="bg-white rounded-[2.5rem] p-8 max-w-sm w-full shadow-2xl text-center animate-popIn"><div class="w-20 h-20 bg-amber-100 text-amber-600 rounded-3xl flex items-center justify-center text-3xl mx-auto mb-6 shadow-inner"><i class="fa-solid fa-users-viewfinder"></i></div><h3 class="text-xl font-black text-slate-800 uppercase mb-2">Ringkasan Kehadiran</h3><p class="text-xs text-slate-500 font-medium mb-6">Terdapat <span class="font-black text-amber-600 text-lg">${window.appState.missingStudentsCache.length}</span> siswa yang belum melakukan presensi hari ini.</p><div class="flex flex-col gap-3"><button onclick="window.goToFinishList()" class="bg-blue-600 text-white py-4 rounded-xl font-black uppercase text-[10px] tracking-widest shadow-lg hover:bg-blue-700 transition-all">Cek Daftar Siswa</button><button onclick="window.closeFinishAttendance()" class="bg-slate-100 text-slate-500 py-4 rounded-xl font-black uppercase text-[10px] tracking-widest hover:bg-slate-200 transition-all">Batal</button></div></div></div>`;
            if (window.appState.finishStep === 2) content += `<div class="fixed inset-0 bg-black/90 backdrop-blur-sm z-[99999] flex items-center justify-center p-6 pointer-events-auto"><div class="bg-white rounded-[2.5rem] p-6 max-w-md w-full shadow-2xl flex flex-col max-h-[80vh] animate-popIn"><div class="flex justify-between items-center mb-6 shrink-0"><h3 class="text-lg font-black text-slate-800 uppercase">Konfirmasi Manual</h3><span id="manual-remaining-count" class="bg-amber-100 text-amber-600 px-3 py-1 rounded-lg text-[10px] font-black">${window.appState.missingStudentsCache.length} Sisa</span></div><div id="manual-confirm-list" class="flex-grow overflow-y-auto custom-scroll pr-2 space-y-3 mb-6">${window.appState.missingStudentsCache.length > 0 ? window.appState.missingStudentsCache.sort((a,b)=>a.nama_siswa.localeCompare(b.nama_siswa)).map(s => `<div id="manual-row-${s.id}" class="bg-slate-50 p-4 rounded-2xl flex flex-col gap-3 border border-slate-100"><span class="font-black text-xs text-slate-700 uppercase">${s.nama_siswa}</span><div class="flex gap-2"><button onclick="window.markManualQuick('${s.id}', 'Hadir')" class="flex-1 bg-white border border-slate-200 py-2 rounded-lg text-[9px] font-black text-slate-400 hover:bg-blue-50 hover:text-blue-600 hover:border-blue-200 transition-all">H</button><button onclick="window.markManualQuick('${s.id}', 'Izin')" class="flex-1 bg-white border border-slate-200 py-2 rounded-lg text-[9px] font-black text-slate-400 hover:bg-sky-50 hover:text-sky-500 hover:border-sky-200 transition-all">I</button><button onclick="window.markManualQuick('${s.id}', 'Sakit')" class="flex-1 bg-white border border-slate-200 py-2 rounded-lg text-[9px] font-black text-slate-400 hover:bg-amber-50 hover:text-amber-500 hover:border-amber-200 transition-all">S</button><button onclick="window.markManualQuick('${s.id}', 'Alpa')" class="flex-1 bg-white border border-slate-200 py-2 rounded-lg text-[9px] font-black text-slate-400 hover:bg-rose-50 hover:text-rose-500 hover:border-rose-200 transition-all">A</button></div></div>`).join('') : '<p class="text-center text-xs text-slate-400 font-bold py-10 animate-fadeIn">Semua siswa sudah diabsen!</p>'}</div><button onclick="window.finishAttendanceProcess()" class="w-full bg-emerald-600 text-white py-4 rounded-xl font-black uppercase text-[10px] tracking-widest shadow-lg hover:bg-emerald-700 transition-all shrink-0">Selesai & Lanjut <i class="fa-solid fa-arrow-right ml-2"></i></button></div></div>`;
            if (window.appState.finishStep === 3) content += `<div class="fixed inset-0 bg-black/90 backdrop-blur-sm z-[99999] flex items-center justify-center p-6 pointer-events-auto"><div class="bg-white rounded-[2.5rem] p-8 max-w-sm w-full shadow-2xl text-center animate-popIn"><div class="w-20 h-20 bg-blue-100 text-blue-600 rounded-3xl flex items-center justify-center text-3xl mx-auto mb-6 shadow-inner"><i class="fa-solid fa-pen-to-square"></i></div><h3 class="text-xl font-black text-slate-800 uppercase mb-2">Isi Jurnal Kelas?</h3><p class="text-xs text-slate-500 font-medium mb-6">Presensi telah dicatat. Apakah Anda ingin langsung mengisi jurnal harian untuk sesi ini?</p><div class="flex gap-3"><button onclick="window.confirmJournal(false)" class="flex-1 bg-slate-100 text-slate-500 py-4 rounded-xl font-black uppercase text-[10px] tracking-widest hover:bg-slate-200 transition-all">Tidak</button><button onclick="window.confirmJournal(true)" class="flex-1 bg-blue-600 text-white py-4 rounded-xl font-black uppercase text-[10px] tracking-widest shadow-lg hover:bg-blue-700 transition-all">Ya, Isi Jurnal</button></div></div></div>`;
            if (window.appState.finishStep === 4) content += `<div class="fixed inset-0 bg-black/90 backdrop-blur-sm z-[99999] flex items-center justify-center p-6 pointer-events-auto"><div class="bg-white rounded-[2.5rem] p-8 max-w-sm w-full shadow-2xl text-center animate-popIn"><div class="w-20 h-20 bg-emerald-100 text-emerald-600 rounded-3xl flex items-center justify-center text-3xl mx-auto mb-6 shadow-inner animate-bounce"><i class="fa-solid fa-check"></i></div><h3 class="text-xl font-black text-slate-800 uppercase mb-2">Selesai!</h3><p class="text-xs text-slate-500 font-medium mb-6">Presensi hari ini telah berhasil diselesaikan. Data telah tersimpan dengan aman.</p><button onclick="window.closeFinishAttendance()" class="w-full bg-emerald-600 text-white py-4 rounded-xl font-black uppercase text-[10px] tracking-widest shadow-lg hover:bg-emerald-700 transition-all">Kembali ke Beranda</button></div></div>`;
            if (mount.innerHTML !== content) mount.innerHTML = content;
        }

        window.renderApp = () => {
            let savedScrollTop = 0; const container = document.getElementById('view-container'); if (container) savedScrollTop = container.scrollTop;
            const root = document.getElementById('root');
            if (window.appState.loading) { root.innerHTML = `<div class="h-screen flex items-center justify-center bg-slate-50 text-[10px] font-black uppercase tracking-widest text-slate-400 animate-pulse text-center">Menghubungkan...</div>`; return; }
            if (!window.appState.isAuthenticated) { root.innerHTML = `<div class="min-h-screen flex flex-col items-center justify-center p-4 bg-slate-50"><div class="bg-white p-8 md:p-12 rounded-[2.5rem] md:rounded-[3rem] shadow-2xl max-w-sm w-full text-center border animate-fadeIn relative overflow-hidden mb-6"><div class="absolute top-0 left-0 w-full h-2 bg-blue-600"></div><div class="w-20 h-20 bg-blue-50 text-blue-600 rounded-3xl flex items-center justify-center text-3xl mx-auto mb-8 shadow-inner text-center"><i data-lucide="key"></i></div><h2 class="text-2xl font-black mb-1 uppercase tracking-tighter leading-none text-center">Login <span class="text-blue-600">SIJURU</span></h2><p class="text-[9px] text-slate-400 font-bold uppercase tracking-widest mb-10 text-center">MASUKKAN KODE AKSES ANDA!</p><form onsubmit="window.handlePinLogin(event)" class="space-y-6"><input type="password" name="pin" maxlength="6" inputmode="numeric" placeholder="" autocomplete="new-password" value="" autofocus class="w-full bg-slate-50 rounded-xl py-6 text-center text-4xl font-black tracking-[0.5em] indent-[0.5em] border-2 border-transparent focus:border-blue-100 outline-none transition-all placeholder:tracking-[0.5em] placeholder:indent-[0.5em]"><button type="submit" class="w-full bg-blue-600 text-white py-5 rounded-2xl font-black uppercase text-[11px] tracking-widest shadow-xl text-center"><i class="fa-solid fa-arrow-right-to-bracket mr-2"></i> Buka Sistem</button></form></div><div class="text-center opacity-60"><p class="text-[10px] font-bold text-slate-400 mb-1">Powered by ReezApps</p><p class="text-[10px] font-bold text-slate-400">Mohamad Rizki, S.Pd., Gr.</p></div></div>`; lucide.createIcons(); return; }

            const v = window.appState.currentView; const collapsed = window.appState.sidebarCollapsed;
            root.innerHTML = `
                <div class="h-screen h-[100dvh] bg-slate-50 flex flex-col md:flex-row overflow-hidden text-left relative z-0">
                    <header class="md:hidden bg-white px-6 py-4 flex justify-between items-center border-b shrink-0 z-[40] text-left"><h1 class="text-sm font-black uppercase tracking-tighter text-left">SIJURU<span class="text-blue-600">Guru</span></h1><button onclick="window.appState.mobileMenuOpen = !window.appState.mobileMenuOpen; window.renderApp();" class="text-slate-600 outline-none text-center"><i class="fa-solid fa-bars text-center"></i></button></header>
                    <aside class="${window.appState.mobileMenuOpen ? 'flex' : 'hidden'} md:flex flex-col bg-white border-r transition-all duration-300 w-full ${collapsed ? 'md:w-24' : 'md:w-64'} md:relative absolute inset-y-0 left-0 z-[50] h-full shadow-2xl md:shadow-none">
                        <button onclick="window.appState.sidebarCollapsed = !window.appState.sidebarCollapsed; window.renderApp();" class="hidden md:flex absolute -right-3 top-10 bg-white border border-slate-200 text-slate-400 w-6 h-6 rounded-full items-center justify-center text-[10px] shadow-sm hover:text-blue-600 hover:border-blue-600 transition-all z-20"><i class="fa-solid ${collapsed ? 'fa-chevron-right' : 'fa-chevron-left'}"></i></button>
                        <div class="flex items-center gap-4 px-6 py-8 relative shrink-0 text-left overflow-hidden"><div class="w-10 h-10 bg-blue-600 rounded-xl flex items-center justify-center text-white shadow-lg shrink-0 text-center"><i class="fa-solid fa-book text-center"></i></div><h1 class="font-black uppercase tracking-tighter leading-none transition-all duration-300 ${collapsed ? 'opacity-0 w-0 translate-x-10 absolute' : 'opacity-100 w-auto relative'} text-left">SIJURU<br><span class="text-blue-600 text-sm">Jurnal Guru</span></h1></div>
                        <nav class="flex-grow px-4 space-y-1 overflow-y-auto custom-scroll pb-10 text-left">
                            ${Object.keys(viewTitles).map(k => window.renderNavItem(k, {dashboard:'fa-house',scanner:'fa-qrcode',input:'fa-pen-to-square',mapel:'fa-book-open',history:'fa-clock-rotate-left',reports:'fa-file-invoice',students:'fa-users-gear',holidays:'fa-calendar-day',settings:'fa-gear',info:'fa-circle-info'}[k], {dashboard:'Beranda',scanner:'Scan QR',input:'Isi Jurnal',mapel:'Mata Pelajaran',history:'Riwayat',reports:'Laporan',students:'Siswa',holidays:'Izin & Libur',settings:'Pengaturan',info:'Tentang'}[k])).join('')}
                        </nav>
                        ${window.appState.mobileMenuOpen ? `<button onclick="window.appState.mobileMenuOpen = false; window.renderApp();" class="md:hidden absolute top-6 right-6 w-10 h-10 bg-slate-100 rounded-xl flex items-center justify-center text-slate-400 text-center"><i class="fa-solid fa-xmark text-center"></i></button>` : ''}
                    </aside>
                    <main class="flex-grow h-full relative bg-slate-50 flex flex-col overflow-hidden text-left">
                        <div class="max-w-7xl mx-auto w-full p-4 md:p-6 lg:p-8 flex flex-col h-full overflow-hidden text-left animate-fadeIn">
                            <header class="mb-4 md:mb-6 flex justify-between items-center bg-white p-4 md:p-5 rounded-[2rem] border shadow-sm shrink-0 text-left">
                                <div><h2 class="text-base md:text-xl font-black uppercase tracking-tight text-slate-800 leading-none text-left">${viewTitles[v]||v}</h2><p class="text-slate-400 text-[8px] font-black uppercase tracking-widest truncate max-w-[150px] md:max-w-none mt-1 text-left">${window.appState.settings.nama_sekolah || 'Digitalisasi ADM'}</p></div>
                                <div class="flex items-center gap-2 text-center">
                                    <button onclick="window.toggleSemester()" class="bg-blue-50 text-blue-600 px-3 py-2 rounded-xl font-black uppercase text-[9px] tracking-widest shadow-sm flex items-center justify-center gap-2 text-center text-center text-center"><i class="fa-solid fa-repeat text-center"></i> <span class="hidden md:inline text-center">Smt</span> ${window.appState.settings.semester}</button>
                                    <button onclick="window.handleLogout()" class="bg-rose-50 text-rose-500 w-9 h-9 md:w-auto md:px-4 md:py-2 rounded-xl flex items-center justify-center gap-2 font-black uppercase text-[9px] tracking-widest shadow-sm text-center text-center text-center text-center"><i class="fa-solid fa-right-from-bracket text-center"></i> <span class="hidden md:inline text-center">Keluar</span></button>
                                </div>
                            </header>
                            <div id="view-container" class="flex-grow overflow-y-auto custom-scroll pb-10 text-left">
                                ${window.renderCurrentView()}
                            </div>
                        </div>
                    </main>
                </div>`;
            
            if (savedScrollTop > 0) { const newContainer = document.getElementById('view-container'); if (newContainer) newContainer.scrollTop = savedScrollTop; }
            window.renderOverlays(); lucide.createIcons(); if (v === 'dashboard') window.initChart();
            if (window.appState.lastFocusedId) { const el = document.getElementById(window.appState.lastFocusedId); if (el) { el.focus(); el.setSelectionRange(window.appState.lastCaretPos, window.appState.lastCaretPos); } }
        };

        window.renderCurrentView = () => {
            const v = window.appState.currentView; const curSem = window.appState.settings.semester; const diampu = window.appState.settings.kelas_diampu || [];

            // --- RESTORED: REPORT VIEW ---
            if (v === 'reports') {
                const targetMonth = window.appState.reportMonth;
                const viewType = window.appState.reportViewType;
                let previewHTML = '';
                
                // Formal Header for Preview
                const formalHeader = `
                    <div class="text-center mb-6 border-b pb-4">
                        <h3 class="font-black text-xl uppercase text-slate-800">${window.appState.settings.nama_sekolah || 'NAMA SEKOLAH'}</h3>
                        <h4 class="font-bold text-sm uppercase text-slate-600">LAPORAN KEHADIRAN SISWA</h4>
                        <p class="text-[10px] text-slate-500 font-medium mt-2">
                            Bulan: <span class="font-bold text-slate-700">${targetMonth}</span> | 
                            Kelas: <span class="font-bold text-slate-700">${window.appState.selectedKelas}</span> | 
                            Semester: <span class="font-bold text-slate-700">${curSem}</span> | 
                            Tahun Ajaran: <span class="font-bold text-slate-700">${window.appState.settings.tahun_ajaran || '-'}</span>
                        </p>
                    </div>
                `;

                if (viewType === 'rekap') {
                    const studentData = window.appState.students
                        .filter(s => String(s.kelas) === String(window.appState.selectedKelas))
                        .sort((a,b)=>a.nama_siswa.localeCompare(b.nama_siswa))
                        .map((s, i) => {
                            const att = window.appState.attendance.filter(a => a.studentId === s.id && a.semester === curSem && a.date.startsWith(targetMonth));
                            return `<tr class="border-b hover:bg-slate-50">
                                <td class="p-3 text-center">${i + 1}</td>
                                <td class="p-3 font-bold text-slate-700">${s.nama_siswa}</td>
                                <td class="p-3 text-center font-bold text-blue-600">${att.filter(x => x.status === 'Hadir').length}</td>
                                <td class="p-3 text-center font-bold text-sky-500">${att.filter(x => x.status === 'Izin').length}</td>
                                <td class="p-3 text-center font-bold text-amber-500">${att.filter(x => x.status === 'Sakit').length}</td>
                                <td class="p-3 text-center font-bold text-rose-500">${att.filter(x => x.status === 'Alpa').length}</td>
                            </tr>`;
                        }).join('');
                    
                    previewHTML = `
                        ${formalHeader}
                        <div class="overflow-hidden rounded-xl border border-slate-200">
                            <table class="w-full text-[10px]">
                                <thead class="bg-slate-100 text-slate-500 uppercase font-black">
                                    <tr>
                                        <th class="p-3 text-center w-10">No</th>
                                        <th class="p-3 text-left">Nama Siswa</th>
                                        <th class="p-3 text-center w-10">H</th>
                                        <th class="p-3 text-center w-10">I</th>
                                        <th class="p-3 text-center w-10">S</th>
                                        <th class="p-3 text-center w-10">A</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-slate-100 bg-white">
                                    ${studentData || '<tr><td colspan="6" class="p-4 text-center text-slate-400">Data tidak ditemukan</td></tr>'}
                                </tbody>
                            </table>
                        </div>
                    `;
                } else {
                    const year = parseInt(targetMonth.split('-')[0]); 
                    const month = parseInt(targetMonth.split('-')[1]); 
                    const daysInMonth = new Date(year, month, 0).getDate();
                    
                    let headerRow = '';
                    for(let i=1; i<=daysInMonth; i++) {
                        const dStr = `${targetMonth}-${String(i).padStart(2, '0')}`;
                        const isHol = window.isHoliday(dStr);
                        headerRow += `<th class="p-2 text-center min-w-[30px] border-l border-slate-200 ${isHol ? 'bg-rose-50 text-rose-500' : ''}">${i}</th>`;
                    }

                    const studentData = window.appState.students
                        .filter(s => String(s.kelas) === String(window.appState.selectedKelas))
                        .sort((a,b)=>a.nama_siswa.localeCompare(b.nama_siswa))
                        .map((s, i) => {
                            const attMonth = window.appState.attendance.filter(a => a.studentId === s.id && a.date.startsWith(targetMonth));
                            let daysCells = '';
                            for(let d=1; d<=daysInMonth; d++) {
                                const dayStr = `${targetMonth}-${String(d).padStart(2, '0')}`;
                                const attDay = attMonth.find(a => a.date === dayStr);
                                const isHol = window.isHoliday(dayStr);
                                let content = '';
                                let bgClass = isHol ? 'bg-rose-50/50' : '';
                                
                                if(attDay?.status === 'Hadir') { content = '<span class="text-blue-600 font-bold">H</span>'; }
                                else if(attDay?.status === 'Izin') { content = '<span class="text-sky-500 font-bold">I</span>'; bgClass = 'bg-sky-50'; }
                                else if(attDay?.status === 'Sakit') { content = '<span class="text-amber-500 font-bold">S</span>'; bgClass = 'bg-amber-50'; }
                                else if(attDay?.status === 'Alpa') { content = '<span class="text-rose-500 font-bold">A</span>'; bgClass = 'bg-rose-50'; }
                                
                                daysCells += `<td class="p-2 text-center border-l border-slate-100 ${bgClass}">${content}</td>`;
                            }
                            return `<tr class="border-b hover:bg-slate-50"><td class="p-3 text-center sticky left-0 bg-white z-10 border-r border-slate-200">${i+1}</td><td class="p-3 font-bold text-slate-700 sticky left-10 bg-white z-10 border-r border-slate-200 whitespace-nowrap">${s.nama_siswa}</td>${daysCells}</tr>`;
                        }).join('');

                    previewHTML = `
                        ${formalHeader}
                        <div class="overflow-x-auto rounded-xl border border-slate-200 pb-2">
                            <table class="w-full text-[10px] border-collapse">
                                <thead class="bg-slate-100 text-slate-500 uppercase font-black sticky top-0 z-20">
                                    <tr>
                                        <th class="p-3 text-center w-10 sticky left-0 bg-slate-100 z-30 border-r border-slate-200">No</th>
                                        <th class="p-3 text-left min-w-[150px] sticky left-10 bg-slate-100 z-30 border-r border-slate-200">Nama Siswa</th>
                                        ${headerRow}
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-slate-100 bg-white">
                                    ${studentData || '<tr><td colspan="35" class="p-4 text-center text-slate-400">Data tidak ditemukan</td></tr>'}
                                </tbody>
                            </table>
                        </div>
                    `;
                }

                return `<div class="max-w-5xl mx-auto animate-fadeIn text-left">
                    <div class="bg-white rounded-[2.5rem] md:rounded-[3rem] p-8 border shadow-sm space-y-8 mb-8">
                        <div class="text-center">
                            <div class="w-16 h-16 bg-blue-100 text-blue-600 rounded-3xl flex items-center justify-center text-2xl mx-auto mb-4"><i class="fa-solid fa-print"></i></div>
                            <h4 class="font-black text-xl uppercase text-slate-800">Cetak Laporan</h4>
                            <p class="text-xs text-slate-400 font-medium">Pilih periode dan format laporan yang diinginkan.</p>
                        </div>
                        <div class="space-y-4">
                            <div><label class="text-[9px] font-black text-slate-400 ml-2 uppercase block text-left">Bulan Laporan</label><input type="month" value="${window.appState.reportMonth}" onchange="window.appState.reportMonth = this.value; window.renderApp();" class="w-full bg-slate-50 rounded-xl p-4 font-black outline-none border-none text-xs text-left"></div>
                            <div><label class="text-[9px] font-black text-slate-400 ml-2 uppercase block text-left">Jenis Tampilan</label><div class="flex bg-slate-50 p-1 rounded-xl"><button onclick="window.appState.reportViewType='rekap';window.renderApp();" class="flex-1 py-3 rounded-lg text-[10px] font-black uppercase transition-all ${window.appState.reportViewType==='rekap'?'bg-white shadow-sm text-blue-600':'text-slate-400 hover:text-slate-600'}">Rekapitulasi</button><button onclick="window.appState.reportViewType='rinci';window.renderApp();" class="flex-1 py-3 rounded-lg text-[10px] font-black uppercase transition-all ${window.appState.reportViewType==='rinci'?'bg-white shadow-sm text-blue-600':'text-slate-400 hover:text-slate-600'}">Rinci Harian</button></div></div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <button onclick="window.exportFormal('reports', 'pdf')" class="bg-blue-600 text-white py-4 rounded-xl font-black uppercase text-[10px] tracking-widest shadow-lg hover:bg-blue-700 transition-all flex items-center justify-center gap-2"><i class="fa-solid fa-file-pdf"></i> Laporan PDF</button>
                            <button onclick="window.exportFormal('reports', 'csv')" class="bg-emerald-50 text-emerald-600 py-4 rounded-xl font-black uppercase text-[10px] tracking-widest shadow-sm hover:bg-emerald-100 transition-all flex items-center justify-center gap-2"><i class="fa-solid fa-file-csv"></i> Ekspor CSV</button>
                        </div>
                    </div>
                    
                    <!-- PREVIEW SECTION -->
                    <div class="bg-white rounded-[2.5rem] md:rounded-[3rem] p-6 md:p-8 border shadow-sm">
                        <div class="flex items-center gap-3 mb-6">
                            <div class="w-8 h-8 bg-indigo-100 text-indigo-600 rounded-lg flex items-center justify-center"><i class="fa-solid fa-table"></i></div>
                            <h4 class="font-black text-lg uppercase text-slate-800">Pratinjau Data</h4>
                        </div>
                        ${previewHTML}
                    </div>
                </div>`;
            }

            // --- RESTORED & ENHANCED: HOLIDAYS VIEW ---
            if (v === 'holidays') {
                return `<div class="max-w-4xl mx-auto animate-fadeIn space-y-8 pb-10 text-left">
                    <!-- NEW: Section Izin/Sakit Berjangka -->
                    <div class="bg-white rounded-[2.5rem] md:rounded-[3rem] p-8 border shadow-sm">
                        <div class="flex items-center gap-4 mb-6">
                            <div class="w-10 h-10 bg-blue-100 text-blue-600 rounded-xl flex items-center justify-center"><i class="fa-solid fa-bed-pulse"></i></div>
                            <h4 class="font-black text-xl uppercase text-slate-800">Izin/Sakit Jangka Panjang</h4>
                        </div>
                        <p class="text-xs text-slate-500 mb-6 font-medium">Fitur ini akan otomatis mengisi status kehadiran siswa untuk rentang tanggal tertentu, sehingga tidak perlu di-scan setiap pagi.</p>
                        <form onsubmit="window.handleSaveLongTerm(event)" class="space-y-4">
                            <select name="studentId" required class="w-full bg-slate-50 rounded-xl p-4 font-black border-none outline-none text-xs text-left">
                                <option value="">Pilih Siswa...</option>
                                ${window.appState.students.filter(s => String(s.kelas) === String(window.appState.selectedKelas)).sort((a,b)=>a.nama_siswa.localeCompare(b.nama_siswa)).map(s => `<option value="${s.id}">${s.nama_siswa} (Kelas ${s.kelas})</option>`).join('')}
                            </select>
                            <div class="grid grid-cols-2 gap-4">
                                <div><label class="text-[9px] font-black text-slate-400 ml-2 uppercase block text-left">Mulai Tanggal</label><input type="date" name="startDate" required class="w-full bg-slate-50 rounded-xl p-4 font-black outline-none border-none text-xs text-left"></div>
                                <div><label class="text-[9px] font-black text-slate-400 ml-2 uppercase block text-left">Sampai Tanggal</label><input type="date" name="endDate" required class="w-full bg-slate-50 rounded-xl p-4 font-black outline-none border-none text-xs text-left"></div>
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <label class="cursor-pointer">
                                    <input type="radio" name="status" value="Sakit" required class="peer sr-only">
                                    <div class="bg-slate-50 border-2 border-transparent peer-checked:border-amber-500 peer-checked:bg-amber-50 rounded-xl p-4 text-center transition-all"><i class="fa-solid fa-thermometer text-lg mb-1 text-slate-400 peer-checked:text-amber-600"></i><p class="text-[9px] font-black uppercase text-slate-600 peer-checked:text-amber-600">Sakit</p></div>
                                </label>
                                <label class="cursor-pointer">
                                    <input type="radio" name="status" value="Izin" required class="peer sr-only">
                                    <div class="bg-slate-50 border-2 border-transparent peer-checked:border-sky-500 peer-checked:bg-sky-50 rounded-xl p-4 text-center transition-all"><i class="fa-solid fa-envelope-open-text text-lg mb-1 text-slate-400 peer-checked:text-sky-600"></i><p class="text-[9px] font-black uppercase text-slate-600 peer-checked:text-sky-600">Izin</p></div>
                                </label>
                            </div>
                            <textarea name="note" placeholder="Keterangan (Opsional)..." class="w-full bg-slate-50 rounded-xl p-4 font-black outline-none min-h-[80px] border-none text-xs text-left"></textarea>
                            <button type="submit" class="w-full bg-blue-600 text-white py-4 rounded-xl font-black uppercase text-[10px] tracking-widest shadow-lg hover:bg-blue-700 transition-all">Simpan Data</button>
                        </form>
                    </div>

                    <!-- NEW: Display & Manage Long Term Permissions -->
                    <div class="bg-white rounded-[2.5rem] md:rounded-[3rem] p-8 border shadow-sm mt-8">
                        <div class="flex items-center gap-4 mb-6">
                            <div class="w-10 h-10 bg-indigo-100 text-indigo-600 rounded-xl flex items-center justify-center"><i class="fa-solid fa-list-check"></i></div>
                            <h4 class="font-black text-xl uppercase text-slate-800">Daftar Izin Aktif</h4>
                        </div>
                        <div class="space-y-3">
                            ${(() => {
                                const today = new Date().toISOString().split('T')[0];
                                // Filter attendance records that are 'Sakit' or 'Izin' and date >= today
                                const activePermissions = window.appState.attendance
                                    .filter(a => (a.status === 'Sakit' || a.status === 'Izin') && a.date >= today)
                                    .sort((a,b) => a.date.localeCompare(b.date));

                                if (activePermissions.length === 0) return '<p class="text-center py-4 text-slate-300 font-black text-[10px] uppercase">Tidak ada siswa izin/sakit aktif</p>';

                                return activePermissions.map(p => `
                                    <div class="flex justify-between items-center p-4 bg-slate-50 rounded-xl border border-slate-100">
                                        <div class="flex flex-col">
                                            <span class="font-black text-xs text-slate-800">${p.studentName} (${p.studentClass})</span>
                                            <span class="text-[10px] text-slate-500 font-bold uppercase tracking-widest mt-1">
                                                <span class="${p.status === 'Sakit' ? 'text-amber-500' : 'text-sky-500'}">${p.status}</span>  ${window.getDayName(p.date)}, ${p.date}
                                            </span>
                                            ${p.note ? `<span class="text-[9px] text-slate-400 italic mt-1">"${p.note}"</span>` : ''}
                                        </div>
                                        <button onclick="window.deleteAttendanceDay('${p.id}')" class="text-rose-300 hover:text-rose-500 p-2 transition-colors" title="Hapus Izin Tanggal Ini">
                                            <i class="fa-solid fa-trash-can"></i>
                                        </button>
                                    </div>
                                `).join('');
                            })()}
                        </div>
                    </div>

                    <!-- Existing: Hari Libur -->
                    <div class="bg-white rounded-[2.5rem] md:rounded-[3rem] p-8 border shadow-sm">
                        <div class="flex items-center gap-4 mb-6">
                            <div class="w-10 h-10 bg-rose-100 text-rose-600 rounded-xl flex items-center justify-center"><i class="fa-solid fa-calendar-xmark"></i></div>
                            <h4 class="font-black text-xl uppercase text-slate-800">Kalender Libur</h4>
                        </div>
                        <form onsubmit="window.handleSaveHoliday(event)" class="mb-8 space-y-4">
                            <div class="flex gap-4">
                                <input type="date" name="tanggal" required class="w-1/3 bg-slate-50 rounded-xl p-4 font-black border-none outline-none text-xs text-left">
                                <input type="text" name="keterangan" placeholder="Keterangan Libur..." required class="flex-grow bg-slate-50 rounded-xl p-4 font-black border-none outline-none text-xs text-left">
                            </div>
                            <button type="submit" class="w-full bg-rose-50 text-rose-600 py-3 rounded-xl font-black uppercase text-[10px] tracking-widest hover:bg-rose-100 transition-all border border-rose-100">Tambah Hari Libur</button>
                        </form>
                        <div class="space-y-2">
                            ${window.appState.holidays.sort((a,b)=>b.tanggal.localeCompare(a.tanggal)).map(h => `<div class="flex justify-between items-center p-4 bg-slate-50 rounded-xl border border-slate-100"><div class="flex flex-col"><span class="font-black text-xs text-slate-800">${h.keterangan}</span><span class="text-[10px] text-slate-400 font-bold uppercase tracking-widest">${window.getDayName(h.tanggal)}, ${h.tanggal}</span></div><button onclick="window.deleteDocData('holidays', '${h.id}')" class="text-rose-300 hover:text-rose-500"><i class="fa-solid fa-trash-can"></i></button></div>`).join('') || '<p class="text-center py-4 text-slate-300 font-black text-[10px] uppercase">Belum ada data libur</p>'}
                        </div>
                    </div>
                </div>`;
            }

            if (v === 'dashboard') {
                const today = new Date().toISOString().split('T')[0];
                const journalToday = window.appState.journals.filter(j => j.tanggal === today).length;
                const hadirToday = window.appState.attendance.filter(a => a.date === today && a.status === 'Hadir').length;
                const todayDate = new Date();
                const todayDayName = todayDate.toLocaleDateString('id-ID', { weekday: 'long' });
                const todayDateStr = todayDate.toLocaleDateString('id-ID', { day: 'numeric', month: 'long', year: 'numeric' });
                const studentCount = window.appState.students.length;
                const currentMonth = new Date();
                const daysInMonth = new Date(currentMonth.getFullYear(), currentMonth.getMonth() + 1, 0).getDate();
                const firstDay = new Date(currentMonth.getFullYear(), currentMonth.getMonth(), 1).getDay();
                let calendarHTML = '';
                for (let i = 0; i < firstDay; i++) calendarHTML += `<div></div>`;
                for (let i = 1; i <= daysInMonth; i++) {
                    const isToday = i === todayDate.getDate();
                    const dStrLoc = `${currentMonth.getFullYear()}-${String(currentMonth.getMonth()+1).padStart(2,'0')}-${String(i).padStart(2,'0')}`;
                    const isHol = window.isHoliday(dStrLoc);
                    const textColor = isHol ? 'text-rose-500 font-black' : 'text-slate-600';
                    calendarHTML += `<div class="text-center text-[10px] font-bold py-1 ${isToday ? 'bg-blue-600 text-white rounded-lg shadow-md' : textColor}">${i}</div>`;
                }
                const todayHolDesc = window.getHolidayDescription(today);
                const counts = {}; window.appState.students.forEach(s => { counts[s.kelas] = (counts[s.kelas] || 0) + 1; });
                const detailHTML = Object.keys(counts).sort((a,b)=>a-b).map(k => `<div class="flex justify-between text-xs text-white/90 border-b border-white/10 py-1 last:border-0"><span>Kelas ${k}</span><span class="font-bold">${counts[k]}</span></div>`).join('');

                // --- NEW: TOP 5 STUDENTS LOGIC ---
                const semester = window.appState.settings.semester;
                // Change 'Hadir' to 'Alpa'
                const allAttendance = window.appState.attendance.filter(a => a.semester === semester && a.status === 'Alpa');
                const studentAttendanceCounts = window.appState.students.map(s => {
                    const count = allAttendance.filter(a => a.studentId === s.id).length;
                    return { name: s.nama_siswa, class: s.kelas, count };
                });
                // Sort desc (highest alpa first)
                const top5 = studentAttendanceCounts.sort((a, b) => b.count - a.count).slice(0, 5);
                // ---------------------------------

                // --- NEW: ACTIVE PERMISSIONS SUMMARY FOR DASHBOARD ---
                const activePermissionsSummary = window.appState.attendance
                    .filter(a => (a.status === 'Sakit' || a.status === 'Izin') && a.date === today)
                    .map(p => ({ 
                        name: p.studentName, 
                        class: p.studentClass, 
                        status: p.status,
                        note: p.note
                    }));
                // -----------------------------------------------------

                return `
                <div class="space-y-6 animate-fadeIn text-left">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-5 text-left">
                        <div class="md:col-span-2 bg-gradient-to-br from-blue-700 via-blue-600 to-indigo-800 p-8 md:p-10 rounded-[2.5rem] text-white shadow-xl flex flex-col justify-center relative overflow-hidden group">
                            <div class="absolute -right-10 -bottom-10 w-64 h-64 bg-white/10 rounded-full blur-3xl group-hover:scale-125 transition-all duration-700"></div>
                            <div class="relative z-10">
                                <span class="bg-white/20 px-3 py-1 rounded-full text-[9px] font-black uppercase tracking-widest backdrop-blur-md mb-4 inline-block">APLIKASI JURNAL GURU</span>
                                <h1 class="text-2xl md:text-4xl font-black mb-2 tracking-tighter leading-tight">Selamat datang,<br><span class="text-blue-200">${window.appState.settings.nama_guru || 'Rekan Guru'}</span></h1>
                                <p class="opacity-80 text-[10px] font-bold uppercase tracking-widest mb-8">Semester ${curSem}  ${window.appState.settings.nama_sekolah || 'Digitalisasi Sekolah'}</p>
                                <div class="flex flex-wrap gap-3">
                                    <button onclick="window.setView('scanner')" class="bg-white text-blue-600 px-6 py-3.5 rounded-xl text-[10px] font-black uppercase shadow-lg hover:scale-105 transition-all flex items-center justify-center gap-2"><i class="fa-solid fa-qrcode"></i> Scan Presensi</button>
                                    <button onclick="window.setView('input')" class="bg-blue-500/30 border border-white/30 text-white px-6 py-3.5 rounded-xl text-[10px] font-black uppercase backdrop-blur-md hover:bg-white/20 transition-all flex items-center justify-center gap-2"><i class="fa-solid fa-pen"></i> Tulis Jurnal</button>
                                </div>
                            </div>
                        </div>
                        <div class="bg-white p-6 rounded-[2.5rem] border border-slate-100 shadow-xl shadow-slate-200/50 flex flex-col relative overflow-hidden">
                            <div class="absolute top-0 left-0 w-full h-1 bg-blue-600"></div>
                            <div class="mb-4"><h3 class="text-xl font-black text-slate-800 tracking-tight">${todayDayName}</h3><p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">${todayDateStr}</p></div>
                            <div class="grid grid-cols-7 gap-1 mb-4">${['M','S','S','R','K','J','S'].map(d => `<div class="text-center text-[8px] font-black text-slate-300 uppercase">${d}</div>`).join('')}${calendarHTML}</div>
                            ${todayHolDesc ? `<div class="mt-1 mb-3 text-center bg-rose-50 p-2 rounded-xl border border-rose-100"><p class="text-[9px] font-black text-rose-500 uppercase tracking-widest animate-pulse">${todayHolDesc}</p></div>` : '<div class="w-full h-px bg-slate-100 my-2"></div>'}
                            <div class="flex justify-around w-full mt-2"><div class="text-center"><p class="text-xs font-black text-blue-600">${journalToday}</p><p class="text-[7px] font-black text-slate-400 uppercase">Jurnal</p></div><div class="text-center"><p class="text-xs font-black text-emerald-600">${hadirToday}</p><p class="text-[7px] font-black text-slate-400 uppercase">Hadir</p></div><div class="text-center"><p class="text-xs font-black text-indigo-600">${studentCount}</p><p class="text-[7px] font-black text-slate-400 uppercase">Siswa</p></div></div>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-5">
                        <div class="lg:col-span-2 space-y-5">
                            <!-- ATTENDANCE CHART -->
                            <div class="bg-white p-6 md:p-8 rounded-[2.5rem] border border-slate-100 shadow-xl shadow-slate-200/50"><div class="flex justify-between items-center mb-8"><div><h4 class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Aktivitas Kehadiran</h4><p class="text-base font-black text-slate-800 uppercase tracking-tighter">Statistik 7 Hari Terakhir</p></div><i class="fa-solid fa-chart-line text-blue-200 text-xl"></i></div><div class="h-56 relative w-full"><canvas id="attendanceChart"></canvas></div></div>
                            
                            <!-- NEW: SISWA IZIN/SAKIT HARI INI CARD -->
                            <div class="bg-white p-6 md:p-8 rounded-[2.5rem] border border-slate-100 shadow-xl shadow-slate-200/50">
                                <div class="flex items-center gap-3 mb-6">
                                    <div class="w-10 h-10 bg-sky-100 text-sky-600 rounded-xl flex items-center justify-center"><i class="fa-solid fa-notes-medical"></i></div>
                                    <div>
                                        <h4 class="font-black text-xl uppercase text-slate-800">Izin & Sakit Hari Ini</h4>
                                        <p class="text-xs text-slate-400 font-medium">Daftar siswa yang tidak hadir dengan keterangan</p>
                                    </div>
                                </div>
                                <div class="space-y-3">
                                    ${activePermissionsSummary.map((p, idx) => `
                                        <div class="flex items-center justify-between p-3 bg-slate-50 rounded-xl border border-slate-100">
                                            <div class="flex items-center gap-4">
                                                <div class="w-8 h-8 bg-slate-200 text-slate-600 rounded-lg flex items-center justify-center font-black text-xs">${idx+1}</div>
                                                <div>
                                                    <span class="block text-xs font-black text-slate-700 uppercase">${p.name}</span>
                                                    <span class="block text-[9px] font-bold text-slate-400">Kelas ${p.class} ${p.note ? ` ${p.note}` : ''}</span>
                                                </div>
                                            </div>
                                            <span class="${p.status === 'Sakit' ? 'bg-amber-100 text-amber-600' : 'bg-sky-100 text-sky-600'} px-3 py-1 rounded-lg text-[10px] font-black">${p.status}</span>
                                        </div>
                                    `).join('') || '<p class="text-center text-slate-400 text-xs py-4">Semua siswa hadir atau belum ada data</p>'}
                                </div>
                            </div>
                        </div>

                        <div class="space-y-3">
                            <div class="bg-gradient-to-r from-indigo-500 to-purple-600 rounded-2xl shadow-lg transition-all overflow-hidden group">
                                <button onclick="window.appState.populationExpanded = !window.appState.populationExpanded; window.renderApp();" class="w-full p-4 flex items-center justify-between text-left outline-none cursor-pointer">
                                    <div class="flex items-center gap-4"><div class="w-10 h-10 bg-white/20 text-white rounded-xl flex items-center justify-center text-base backdrop-blur-sm"><i class="fa-solid fa-users"></i></div><div><span class="block text-white text-[10px] font-black uppercase tracking-widest opacity-80">Populasi Total</span><span class="block text-white text-xl font-black">${studentCount} Siswa</span></div></div><i class="fa-solid fa-chevron-${window.appState.populationExpanded ? 'up' : 'down'} text-white/50 text-xs transition-transform duration-300"></i>
                                </button>
                                ${window.appState.populationExpanded ? `<div class="bg-black/10 p-4 pt-0 space-y-1 animate-fadeIn">${detailHTML || '<p class="text-[10px] text-white/60 italic">Belum ada data siswa</p>'}</div>` : ''}
                            </div>
                            
                            <!-- TOP 5 ALPA -->
                            <div class="bg-white p-5 rounded-2xl border border-slate-100 shadow-lg">
                                <div class="flex items-center gap-3 mb-4">
                                    <div class="w-8 h-8 bg-rose-100 text-rose-600 rounded-lg flex items-center justify-center"><i class="fa-solid fa-triangle-exclamation"></i></div>
                                    <h4 class="font-black text-sm uppercase text-slate-800">Perlu Perhatian (Alpa)</h4>
                                </div>
                                <div class="space-y-2">
                                    ${top5.map((s, idx) => `
                                        <div class="flex items-center justify-between p-2 bg-slate-50 rounded-lg border border-slate-100">
                                            <span class="text-[10px] font-bold text-slate-600 truncate w-2/3">${s.name}</span>
                                            <span class="bg-rose-100 text-rose-600 px-2 py-0.5 rounded text-[9px] font-black">${s.count}</span>
                                        </div>
                                    `).join('') || '<p class="text-center text-slate-400 text-[10px] py-2">Belum ada data</p>'}
                                </div>
                            </div>

                            <h4 class="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-4 mt-2">Aksi Cepat</h4>
                            <div class="grid grid-cols-1 gap-2">${[{ icon: 'fa-file-invoice', label: 'Cetak Laporan', view: 'reports', color: 'blue' },{ icon: 'fa-book-open', label: 'Data Mapel', view: 'mapel', color: 'indigo' },{ icon: 'fa-user-plus', label: 'Tambah Siswa', view: 'students', color: 'emerald' }].map(btn => `<button onclick="window.setView('${btn.view}')" class="bg-white border border-slate-100 p-4 rounded-2xl flex items-center gap-4 hover:bg-slate-50 hover:shadow-md transition-all group text-left"><div class="w-10 h-10 bg-${btn.color}-50 text-${btn.color}-600 rounded-xl flex items-center justify-center text-base group-hover:scale-110 transition-transform"><i class="fa-solid ${btn.icon}"></i></div><span class="font-black text-[10px] uppercase tracking-widest text-slate-700">${btn.label}</span><i class="fa-solid fa-chevron-right ml-auto text-slate-300 group-hover:translate-x-1 transition-transform text-[10px]"></i></button>`).join('')}</div>
                        </div>
                    </div>
                </div>`;
            }
            
            if (v === 'input') return `<div class="grid grid-cols-1 lg:grid-cols-2 gap-6 md:gap-8 animate-fadeIn text-left"><form onsubmit="window.handleSaveJournal(event)" class="bg-white rounded-[2.5rem] md:rounded-[3rem] p-6 md:p-8 border shadow-sm space-y-6 text-left"><div class="grid grid-cols-2 gap-4 text-left"><div class="text-left"><label class="text-[9px] font-black ${window.isHoliday(window.appState.selectedDate) ? 'text-rose-500' : 'text-slate-400'} uppercase mb-1 block text-left">Tanggal (${window.getDayName(window.appState.selectedDate)})</label><input type="date" name="tanggal" required value="${window.appState.selectedDate}" onchange="window.appState.selectedDate = this.value; window.renderApp();" class="w-full bg-slate-50 rounded-xl p-4 font-black border-none outline-none text-xs text-left"></div><div class="text-left"><label class="text-[9px] font-black text-slate-400 uppercase mb-1 block text-left">Kelas</label><select name="kelas_mengajar" onchange="window.appState.selectedKelas = this.value; window.renderApp();" class="w-full bg-slate-50 rounded-xl p-4 font-black border-none outline-none text-xs text-left">${(diampu.length > 0 ? diampu : [1,2,3,4,5,6]).map(k => `<option value="${k}" ${k==window.appState.selectedKelas?'selected':''}>Kelas ${k}</option>`).join('')}</select></div></div><div class="grid grid-cols-2 gap-4 text-left"><div class="text-left"><label class="text-[9px] font-black text-slate-400 uppercase mb-1 block text-left">Jam Ke-</label><select name="jam_ke" required class="w-full bg-slate-50 rounded-xl p-4 font-black border-none outline-none text-xs text-left">${[1,2,3,4,5,6,7,8].map(j => `<option value="${j}">Jam Ke-${j}</option>`).join('')}</select></div><div class="flex items-end pb-3 text-left"><label class="flex items-center gap-2 cursor-pointer text-left"><input type="checkbox" name="is_kerja_khusus" class="w-4 h-4"><span class="text-[9px] font-black uppercase text-left">Hari Kerja Khusus</span></label></div></div><select name="mata_pelajaran" onchange="window.appState.selectedMapel = this.value; window.renderApp();" required class="w-full bg-slate-50 rounded-xl p-4 font-black border-none outline-none text-xs text-left"><option value="">Pilih Mapel...</option>${window.appState.mapels.filter(m => String(m.kelas) === String(window.appState.selectedKelas)).map(m => `<option value="${m.nama}" ${window.appState.selectedMapel===m.nama?'selected':''}>${m.nama}</option>`).join('')}</select><select onchange="document.getElementsByName('tujuan_pembelajaran')[0].value = this.value" class="w-full bg-slate-50 rounded-xl p-4 font-black border-none outline-none text-xs text-left"><option value="">Pilih TP Database...</option>${(window.appState.mapels.filter(m => String(m.kelas) === String(window.appState.selectedKelas)).find(m => m.nama === window.appState.selectedMapel)?.tp || []).map(t => `<option value="${t}">${t}</option>`).join('')}</select><textarea name="tujuan_pembelajaran" placeholder="TP Manual..." required class="w-full bg-slate-50 rounded-xl p-4 font-black outline-none min-h-[100px] border-none text-xs text-left"></textarea><textarea name="catatan" placeholder="Catatan..." class="w-full bg-slate-50 rounded-xl p-4 font-black outline-none min-h-[60px] border-none text-xs text-left"></textarea><button type="submit" class="w-full bg-blue-600 text-white py-5 rounded-2xl font-black uppercase text-[11px] tracking-widest shadow-xl text-center"><i class="fa-solid fa-floppy-disk mr-2"></i> Simpan Jurnal</button></form><div class="bg-white rounded-[2.5rem] md:rounded-[3rem] p-6 md:p-8 border shadow-sm flex flex-col h-full min-h-[400px] text-left"><div class="flex items-center justify-between mb-4 shrink-0 text-left"><h4 class="font-black text-xl uppercase leading-none text-slate-800 text-left">Presensi</h4><div class="flex gap-2 text-center text-center"><button onclick="window.markAllPresent('${window.appState.selectedKelas}')" class="bg-blue-50 text-blue-600 px-3 py-2 rounded-xl text-[9px] font-black uppercase tracking-tight shadow-sm text-center text-center text-center"><i class="fa-solid fa-check-double mr-1"></i> Hadir Semua</button><button onclick="window.setView('scanner')" class="bg-slate-100 text-slate-800 w-9 h-9 rounded-xl flex items-center justify-center shadow-sm text-center text-center text-center text-center"><i class="fa-solid fa-qrcode text-center text-center"></i></button></div></div><div class="mb-4 relative text-left"><input id="att-search-input" type="text" placeholder="Cari nama siswa..." value="${window.appState.attendanceSearch}" oninput="window.handleSearchInput(this, 'attendanceSearch')" class="w-full bg-slate-50 rounded-xl p-4 pr-10 font-black border-none outline-none text-xs text-left"><i class="fa-solid fa-magnifying-glass absolute right-4 top-1/2 -translate-y-1/2 text-slate-300 text-sm text-center"></i></div><div class="space-y-2 overflow-y-auto custom-scroll pr-1 flex-grow text-left">${window.appState.students.filter(s => String(s.kelas) === String(window.appState.selectedKelas)).sort((a,b)=>a.nama_siswa.localeCompare(b.nama_siswa)).filter(s => s.nama_siswa.toLowerCase().includes(window.appState.attendanceSearch.toLowerCase())).map(s => { const log = window.appState.attendance.find(a => a.studentId === s.id && a.date === window.appState.selectedDate); return `<div class="flex items-center justify-between p-4 bg-slate-50 rounded-2xl border text-left text-left"><span class="text-[10px] font-black uppercase text-slate-700 truncate w-1/3 text-left">${s.nama_siswa}</span><div class="flex gap-1 text-center text-center"><button onclick="window.markAttendance('${s.id}', 'Hadir')" class="w-8 h-8 md:w-9 md:h-8 rounded-lg font-black text-[8px] flex items-center justify-center text-center ${log?.status === 'Hadir' ? 'bg-blue-600 text-white shadow-md' : 'bg-white text-slate-300 border'}">H</button><button onclick="window.markAttendance('${s.id}', 'Izin')" class="w-8 h-8 md:w-9 md:h-8 rounded-lg font-black text-[8px] flex items-center justify-center text-center ${log?.status === 'Izin' ? 'bg-sky-400 text-white shadow-md' : 'bg-white text-slate-300 border'}">I</button><button onclick="window.markAttendance('${s.id}', 'Sakit')" class="w-8 h-8 md:w-9 md:h-8 rounded-lg font-black text-[8px] flex items-center justify-center text-center ${log?.status === 'Sakit' ? 'bg-amber-500 text-white shadow-md' : 'bg-white text-slate-300 border'}">S</button><button onclick="window.markAttendance('${s.id}', 'Alpa')" class="w-8 h-8 md:w-9 md:h-8 rounded-lg font-black text-[8px] flex items-center justify-center text-center ${log?.status === 'Alpa' ? 'bg-rose-500 text-white shadow-md' : 'bg-white text-slate-300 border'}">A</button></div></div>`}).join('') || '<p class="text-center py-20 text-slate-300 font-black text-[10px] uppercase text-center">Data Tidak Ditemukan</p>'}</div></div></div>`;

            if (v === 'students') return `<div class="grid grid-cols-1 lg:grid-cols-2 gap-8 animate-fadeIn text-left text-left"><div class="bg-white rounded-[2.5rem] md:rounded-[3rem] p-8 border shadow-sm h-fit text-left"><h4 class="font-black text-xl uppercase mb-6 text-slate-800 text-left">Pendaftaran</h4><form onsubmit="window.handleBulkStudents(event)" class="space-y-4 text-left"><select name="grade" required class="w-full bg-slate-50 rounded-xl p-4 font-black border-none outline-none text-xs text-left">${(diampu.length > 0 ? diampu : [1,2,3,4,5,6]).map(v => `<option value="${v}">Kelas ${v}</option>`).join('')}</select><textarea name="names" rows="10" required placeholder="Daftar nama..." class="w-full bg-slate-50 rounded-xl p-4 font-black border-none outline-none resize-none text-xs shadow-inner text-left text-left"></textarea><button type="submit" class="w-full bg-blue-600 text-white py-5 rounded-2xl font-black uppercase text-[11px] tracking-widest shadow-xl text-center"><i class="fa-solid fa-rotate mr-2"></i> Sinkron Database</button></form></div><div class="bg-white rounded-[2.5rem] md:rounded-[3rem] p-8 border shadow-sm flex flex-col h-full min-h-[400px] text-left"><div class="flex justify-between items-center mb-6 shrink-0 text-left text-left"><h4 class="font-black text-xl uppercase leading-none text-slate-800 text-left">Database</h4><button onclick="window.downloadBulkQR()" class="bg-blue-50 text-blue-600 px-5 py-2.5 rounded-xl text-[9px] font-black uppercase tracking-widest shadow-sm text-center"><i class="fa-solid fa-file-zipper mr-2"></i> ZIP QR</button></div><div class="space-y-2 overflow-y-auto custom-scroll pr-1 flex-grow text-left">${window.appState.students.sort((a,b)=>a.kelas-b.kelas || a.nama_siswa.localeCompare(b.nama_siswa)).map(s => `<div class="flex items-center justify-between p-4 bg-slate-50 border rounded-2xl text-left"><div class="flex items-center gap-4 text-left text-left"><div class="w-8 h-8 bg-blue-100 rounded-lg flex items-center justify-center font-black text-[10px] text-blue-600 border text-center text-center">${s.kelas}</div><span class="font-black text-[10px] uppercase text-slate-800 text-left">${s.nama_siswa}</span></div><div class="flex gap-1 text-center"><button onclick="window.handleEditStudent('${s.id}')" class="text-slate-400 hover:text-blue-500 p-2 rounded-lg transition-colors"><i class="fa-solid fa-pen-to-square"></i></button><button onclick='window.viewQR(${JSON.stringify(s)})' class="text-blue-500 p-2 hover:bg-blue-100 rounded-lg text-center"><i class="fa-solid fa-qrcode text-center"></i></button><button onclick="window.deleteDocData('students', '${s.id}')" class="text-rose-400 p-2 hover:bg-rose-100 rounded-lg text-center text-center"><i class="fa-solid fa-trash-can text-center"></i></button></div></div>`).join('')}</div></div></div>`;
            
            if (v === 'mapel') return `<div class="max-w-2xl mx-auto animate-fadeIn text-left text-left"><div class="bg-white rounded-[2.5rem] md:rounded-[3rem] p-8 border shadow-sm mb-8 text-left text-left text-left"><h4 class="font-black text-xl uppercase mb-6 leading-none text-slate-800 text-left">Kelola Mapel Baru</h4><form onsubmit="window.handleSaveMapel(event)" class="space-y-4 text-left"><select name="kelas" required class="w-full bg-slate-50 rounded-xl p-4 font-black border-none outline-none text-xs text-left">${(diampu.length > 0 ? diampu : [1,2,3,4,5,6]).map(v => `<option value="${v}">Kelas ${v}</option>`).join('')}</select><input type="text" name="nama_mapel" placeholder="Nama Mapel..." required class="w-full bg-slate-50 rounded-xl p-4 font-black border-none outline-none text-xs text-left"><textarea name="tujuan_pembelajaran" placeholder="TP (Gunakan Enter untuk list baru)..." required class="w-full bg-slate-50 rounded-xl p-4 font-black outline-none min-h-[120px] border-none text-xs shadow-inner text-left text-left"></textarea><button type="submit" class="w-full bg-blue-600 text-white py-4 rounded-2xl font-black uppercase text-[10px] tracking-widest shadow-xl text-center"><i class="fa-solid fa-floppy-disk mr-2"></i> Simpan Mapel & TP</button></form></div><div class="space-y-4 pb-10 text-left text-left"><h4 class="font-black text-lg uppercase mb-4 text-slate-600 text-left">Daftar Mata Pelajaran & TP Terdaftar</h4>${window.appState.mapels.sort((a,b)=>a.kelas-b.kelas).map(m => `<div class="bg-white p-6 rounded-3xl border text-left text-left"><div class="flex justify-between items-start mb-4 text-left text-left"><div class="flex items-center gap-2 text-left"><span class="bg-blue-50 text-blue-600 px-2 py-1 rounded-lg text-[9px] font-black text-center text-center">KLS ${m.kelas}</span><h5 class="font-black uppercase text-slate-800 text-left">${m.nama}</h5></div><button onclick="window.deleteDocData('mapels', '${m.id}')" class="text-rose-400 p-2 hover:bg-rose-100 rounded-lg transition-all text-center text-center"><i class="fa-solid fa-trash-can text-center"></i></button></div><ul class="space-y-2 mb-6 text-left">${(m.tp || []).map((t, idx) => `<li class="flex items-center justify-between gap-4 bg-slate-50 p-3 rounded-xl border-l-4 border-blue-200 text-left text-left"><span class="text-[10px] text-slate-600 font-bold leading-tight text-left">${t}</span><button onclick="window.deleteTP('${m.id}', ${idx})" class="text-rose-300 hover:text-rose-500 transition-colors shrink-0 text-center text-center"><i class="fa-solid fa-xmark text-center"></i></button></li>`).join('')}</ul><div class="flex gap-2 text-left"><input type="text" id="new-tp-${m.id}" placeholder="Tambah TP baru..." class="flex-grow bg-slate-50 border-none outline-none rounded-xl px-4 py-3 text-[10px] font-bold text-left"><button onclick="window.addTPToExisting('${m.id}')" class="bg-blue-600 text-white px-4 rounded-xl text-xs flex items-center justify-center text-center text-center"><i class="fa-solid fa-plus text-center"></i></button></div></div>`).join('')}</div></div>`;
            
            if (v === 'history') {
                const groupedJournals = window.appState.journals.filter(j => j.semester === curSem && j.tanggal.startsWith(window.appState.historyMonth)).reduce((groups, journal) => { const date = journal.tanggal; if (!groups[date]) { groups[date] = []; } groups[date].push(journal); return groups; }, {}); const sortedDates = Object.keys(groupedJournals).sort((a, b) => b.localeCompare(a));
                return `<div class="space-y-6 animate-fadeIn text-left"><div class="bg-white rounded-[2.5rem] md:rounded-[3rem] p-6 md:p-8 border shadow-sm flex flex-col md:flex-row justify-between items-center gap-6 text-left"><h4 class="font-black text-xl uppercase leading-none text-slate-800 text-left">Data Riwayat Smt ${curSem}</h4><div class="flex flex-wrap items-center gap-4 text-left"><input type="month" value="${window.appState.historyMonth}" onchange="window.appState.historyMonth = this.value; window.renderApp();" class="bg-slate-50 rounded-xl px-4 py-3 font-black outline-none border-none text-xs text-left"><div class="flex gap-2 text-center text-center"><button onclick="window.exportFormal('journals', 'csv')" class="bg-emerald-50 text-emerald-600 px-6 py-3 rounded-xl font-black text-[10px] uppercase text-center transition-all hover:shadow-md"><i class="fa-solid fa-file-csv mr-2"></i> Ekspor CSV</button><button onclick="window.exportFormal('journals', 'pdf')" class="bg-rose-50 text-rose-600 px-6 py-3 rounded-xl font-black text-[10px] uppercase text-center transition-all hover:shadow-md"><i class="fa-solid fa-file-pdf mr-2"></i> Cetak PDF</button></div></div></div><div class="space-y-6">${sortedDates.map(date => { const entries = groupedJournals[date].sort((a, b) => a.jam_ke - b.jam_ke); const firstEntry = entries[0]; const isHolidayDate = window.isHoliday(date); const shouldBeRed = isHolidayDate && !entries.some(e => e.is_kerja_khusus); return `<div class="bg-white rounded-[2.5rem] p-6 md:p-8 border shadow-sm group hover:shadow-xl transition-all relative overflow-hidden"><div class="absolute top-0 left-0 w-2 h-full ${shouldBeRed ? 'bg-rose-500' : 'bg-blue-600'}"></div><div class="flex flex-col gap-6"><div class="flex justify-between items-center border-b pb-4 border-slate-100"><div class="flex items-center gap-3"><span class="${shouldBeRed ? 'bg-rose-50 text-rose-600' : 'bg-blue-50 text-blue-600'} px-4 py-2 rounded-xl text-xs font-black uppercase tracking-widest">${window.getDayName(date)}, ${date}</span>${entries.some(e => e.is_kerja_khusus) ? '<span class="bg-emerald-50 text-emerald-600 px-3 py-1 rounded-lg text-[9px] font-black uppercase tracking-widest">Kerja Khusus</span>' : ''}</div></div><div class="grid grid-cols-4 gap-2 md:gap-4"><div class="bg-blue-50/50 p-3 rounded-xl border border-blue-100 text-center"><p class="text-sm font-black text-blue-600">${firstEntry.hadir}</p><p class="text-[8px] font-black text-slate-400 uppercase">Hadir</p></div><div class="bg-sky-50/50 p-3 rounded-xl border border-sky-100 text-center"><p class="text-sm font-black text-sky-600">${firstEntry.izin||0}</p><p class="text-[8px] font-black text-slate-400 uppercase">Izin</p></div><div class="bg-amber-50/50 p-3 rounded-xl border border-amber-100 text-center"><p class="text-sm font-black text-amber-600">${firstEntry.sakit||0}</p><p class="text-[8px] font-black text-slate-400 uppercase">Sakit</p></div><div class="bg-rose-50/50 p-3 rounded-xl border border-rose-100 text-center"><p class="text-sm font-black text-rose-600">${firstEntry.alpa}</p><p class="text-[8px] font-black text-slate-400 uppercase">Alpa</p></div></div><div class="space-y-4">${entries.map(j => `<div class="bg-slate-50 p-5 rounded-2xl border border-slate-100 relative"><div class="flex justify-between items-start mb-2"><div class="flex items-center gap-2"><span class="bg-white text-slate-600 border px-2 py-1 rounded-lg text-[9px] font-black uppercase tracking-widest">Jam ${j.jam_ke}</span><span class="bg-indigo-50 text-indigo-600 px-2 py-1 rounded-lg text-[9px] font-black uppercase tracking-widest">Kelas ${j.kelas_mengajar}</span></div><button onclick="window.deleteDocData('journals', '${j.id}')" class="text-rose-300 hover:text-rose-600 transition-colors p-1"><i class="fa-solid fa-trash-can"></i></button></div><h5 class="text-sm font-black uppercase tracking-tight text-slate-800 leading-tight mb-2">${j.mata_pelajaran}</h5><p class="text-[10px] text-slate-500 font-medium leading-relaxed mb-1"><span class="font-bold text-slate-400 uppercase text-[9px] mr-1">TP:</span> ${j.tujuan_pembelajaran || '-'}</p>${j.catatan ? `<p class="text-[10px] text-slate-500 italic leading-relaxed"><span class="font-bold text-slate-400 uppercase text-[9px] not-italic mr-1">Catatan:</span> "${j.catatan}"</p>` : ''}</div>`).join('')}</div></div></div>`; }).join('')} ${sortedDates.length === 0 ? '<p class="text-center py-20 text-slate-300 font-black text-[10px] uppercase text-center">Data Jurnal Tidak Ditemukan</p>' : ''}</div></div>`;
            }

            if (v === 'settings') return `<div class="max-w-xl mx-auto animate-fadeIn space-y-8 pb-10 text-left"><form onsubmit="window.handleSaveSettings(event)" class="bg-white rounded-[2.5rem] md:rounded-[3rem] p-8 md:p-10 border shadow-sm space-y-6 text-left"><h4 class="font-black text-xl uppercase mb-4 leading-none text-slate-800 text-left">Profil Guru</h4><div class="space-y-4 text-left"><div class="grid grid-cols-2 gap-4 text-left"><div><label class="text-[9px] font-black text-slate-400 ml-2 uppercase text-left">Sekolah</label><input type="text" name="nama_sekolah" value="${window.appState.settings.nama_sekolah || ''}" placeholder="Sekolah" class="w-full bg-slate-50 rounded-xl p-4 font-black outline-none text-xs text-left"></div><div><label class="text-[9px] font-black text-slate-400 ml-2 uppercase text-left">Lokasi/Kota</label><input type="text" name="lokasi" value="${window.appState.settings.lokasi || ''}" placeholder="Jakarta" class="w-full bg-slate-50 rounded-xl p-4 font-black outline-none text-xs text-left"></div></div><div class="grid grid-cols-2 gap-4 text-left"><div><label class="text-[9px] font-black text-slate-400 ml-2 uppercase text-left">Wali Kelas</label><input type="text" name="nama_guru" value="${window.appState.settings.nama_guru || ''}" placeholder="Wali Kelas" class="w-full bg-slate-50 rounded-xl p-4 font-black outline-none text-xs text-left"></div><div><label class="text-[9px] font-black text-slate-400 ml-2 uppercase text-left">NIP</label><input type="text" name="nip_guru" value="${window.appState.settings.nip_guru || ''}" placeholder="NIP" class="w-full bg-slate-50 rounded-xl p-4 font-black outline-none text-xs text-left"></div></div><div class="grid grid-cols-2 gap-4 text-left"><div><label class="text-[9px] font-black text-slate-400 ml-2 uppercase text-left text-left">Tahun Pelajaran</label><input type="text" name="tahun_ajaran" value="${window.appState.settings.tahun_ajaran || ''}" placeholder="2024/2025" class="w-full bg-slate-50 rounded-xl p-4 font-black outline-none text-xs text-left"></div><div><label class="text-[9px] font-black text-slate-400 ml-2 uppercase text-left text-left">Kepala Sekolah</label><input type="text" name="nama_kepsek" value="${window.appState.settings.nama_kepsek || ''}" placeholder="Kepsek" class="w-full bg-slate-50 rounded-xl p-4 font-black outline-none text-xs text-left"></div></div><div class="text-left"><label class="text-[9px] font-black text-slate-400 ml-2 uppercase text-left text-left">NIP Kepsek</label><input type="text" name="nip_kepsek" value="${window.appState.settings.nip_kepsek || ''}" placeholder="NIP Kepsek" class="w-full bg-slate-50 rounded-xl p-4 font-black outline-none text-xs text-left"></div><div class="space-y-2 border-t pt-4 text-left"><label class="text-[9px] font-black text-slate-400 ml-2 uppercase block text-left">Kelas yang Diampu</label><div class="flex flex-wrap gap-3 text-left">${[1,2,3,4,5,6].map(k => `<label class="flex items-center gap-2 bg-slate-50 px-3 py-2 rounded-xl cursor-pointer border hover:border-blue-200 transition-all text-left"><input type="checkbox" name="kelas_diampu" value="${k}" ${diampu.includes(String(k)) ? 'checked' : ''} class="w-4 h-4"><span class="text-[10px] font-black text-left text-left">KLS ${k}</span></label>`).join('')}</div></div></div><div class="space-y-4 pt-4 border-t text-left"><label class="text-[9px] font-black text-slate-400 ml-2 uppercase block text-left">Pengaturan Suara</label><div class="grid grid-cols-3 gap-3"><label class="cursor-pointer"><input type="radio" name="voiceMode" value="mute" ${window.appState.settings.voiceMode === 'mute' ? 'checked' : ''} class="peer sr-only"><div class="bg-slate-50 border-2 border-transparent peer-checked:border-blue-500 peer-checked:bg-blue-50 rounded-xl p-4 text-center transition-all"><i class="fa-solid fa-volume-xmark text-lg mb-1 text-slate-400 peer-checked:text-blue-600"></i><p class="text-[9px] font-black uppercase text-slate-600 peer-checked:text-blue-600">Mati</p></div></label><label class="cursor-pointer"><input type="radio" name="voiceMode" value="beep" ${window.appState.settings.voiceMode === 'beep' ? 'checked' : ''} class="peer sr-only"><div class="bg-slate-50 border-2 border-transparent peer-checked:border-blue-500 peer-checked:bg-blue-50 rounded-xl p-4 text-center transition-all"><i class="fa-solid fa-volume-low text-lg mb-1 text-slate-400 peer-checked:text-blue-600"></i><p class="text-[9px] font-black uppercase text-slate-600 peer-checked:text-blue-600">Nada</p></div></label><label class="cursor-pointer"><input type="radio" name="voiceMode" value="tts" ${window.appState.settings.voiceMode === 'tts' ? 'checked' : ''} class="peer sr-only"><div class="bg-slate-50 border-2 border-transparent peer-checked:border-blue-500 peer-checked:bg-blue-50 rounded-xl p-4 text-center transition-all"><i class="fa-solid fa-volume-high text-lg mb-1 text-slate-400 peer-checked:text-blue-600"></i><p class="text-[9px] font-black uppercase text-slate-600 peer-checked:text-blue-600">Suara</p></div></label></div></div><button type="submit" class="w-full bg-blue-600 text-white py-5 rounded-2xl font-black uppercase text-[11px] tracking-widest shadow-xl text-center"><i class="fa-solid fa-floppy-disk mr-2"></i> Simpan Profil</button></form><div class="bg-amber-50 p-8 md:p-10 rounded-[2.5rem] md:rounded-[3rem] border border-amber-100 space-y-6 text-left"><h4 class="font-black text-xl uppercase text-amber-700 leading-none text-left">Pemeliharaan Data</h4><div class="space-y-4 text-left"><label class="text-[9px] font-black text-slate-400 ml-2 uppercase block text-left">Reset Presensi per Bulan</label><div class="flex gap-3 text-left"><input type="month" id="reset-month-picker" class="flex-grow bg-white rounded-xl p-4 font-black border-none outline-none text-xs text-left"><button onclick="window.handleResetAttendance()" class="bg-amber-600 text-white px-6 py-4 rounded-xl font-black uppercase text-[10px] tracking-widest text-center transition-all hover:bg-amber-700"><i class="fa-solid fa-rotate-right mr-2"></i> Reset Bulan</button></div></div></div><div class="bg-rose-50 p-8 md:p-10 rounded-[2.5rem] md:rounded-[3rem] border border-rose-100 space-y-6 text-left"><h4 class="font-black text-xl uppercase text-rose-600 leading-none text-left">Area Berbahaya</h4><div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-left"><button onclick="window.handlePromotion()" class="bg-white text-rose-600 border border-rose-200 py-4 rounded-2xl font-black uppercase text-[10px] tracking-widest hover:bg-rose-600 hover:text-white transition-all text-center"><i class="fa-solid fa-stairs mr-2"></i> Naik Kelas</button><button onclick="window.handleClearData()" class="bg-rose-600 text-white py-4 rounded-2xl font-black uppercase text-[10px] tracking-widest shadow-xl text-center transition-all hover:bg-rose-700"><i class="fa-solid fa-triangle-exclamation mr-2"></i> Bersihkan Database</button></div></div></div>`;

            if (v === 'scanner') {
                const isMobile = /Android|iPhone|iPad|iPod/i.test(navigator.userAgent); const useMirror = window.appState.cameraFacingMode === 'user' || !isMobile;
                return `<div class="max-w-md mx-auto animate-fadeIn relative min-h-full flex flex-col items-center justify-center p-6 py-12"><div class="bg-white rounded-[2.5rem] p-6 md:p-10 border shadow-sm text-center flex flex-col items-center w-full relative overflow-hidden animate-fadeIn"><div class="w-full flex justify-end mb-4"><button onclick="window.switchCamera()" class="bg-slate-100 text-slate-600 w-10 h-10 rounded-full flex items-center justify-center shadow-sm hover:bg-slate-200 transition-all z-20" title="Ganti Kamera"><i class="fa-solid fa-camera-rotate"></i></button></div><div class="relative w-full aspect-square mb-8 rounded-[2rem] overflow-hidden border-8 border-slate-50 shadow-2xl shrink-0 bg-slate-900"><div id="reader" class="w-full h-full bg-slate-900 ${useMirror ? 'mirror-mode' : ''}"></div><div class="absolute inset-0 pointer-events-none z-10 flex items-center justify-center"><div class="w-48 h-48 md:w-56 md:h-56 relative opacity-50"><div class="absolute top-0 left-0 w-8 h-8 border-l-4 border-t-4 border-white rounded-tl-xl"></div><div class="absolute top-0 right-0 w-8 h-8 border-r-4 border-t-4 border-white rounded-tr-xl"></div><div class="absolute bottom-0 left-0 w-8 h-8 border-l-4 border-b-4 border-white rounded-bl-xl"></div><div class="absolute bottom-0 right-0 w-8 h-8 border-r-4 border-b-4 border-white rounded-br-xl"></div></div></div>${window.appState.scanSuccessPopup.show ? `<div class="absolute inset-0 bg-emerald-500/90 backdrop-blur-sm flex flex-col items-center justify-center z-50 animate-fadeIn rounded-[1.5rem]"><div class="bg-white p-4 rounded-full mb-4 shadow-xl animate-bounce"><i class="fa-solid fa-check text-4xl text-emerald-500"></i></div><h2 class="text-2xl font-black text-white uppercase tracking-tighter mb-1 text-center px-4">${window.appState.scanSuccessPopup.studentName}</h2><p class="text-white/90 font-bold uppercase tracking-widest text-xs">BERHASIL HADIR</p></div>` : ''}</div><p class="text-[9px] font-black uppercase text-slate-400 mb-6 tracking-widest leading-none text-center">Arahkan kamera ke QR Siswa</p><div class="flex flex-col gap-3 w-full">${!window.appState.scannerActive ? `<button onclick="window.startScanner()" class="w-full bg-blue-600 text-white py-5 rounded-2xl font-black uppercase text-[11px] tracking-widest shadow-xl text-center hover:bg-blue-700 transition-all flex items-center justify-center gap-2"><i class="fa-solid fa-camera"></i> Mulai Scan</button>` : `<button onclick="window.restartScanner()" class="w-full bg-rose-50 text-rose-500 py-5 rounded-2xl font-black uppercase text-[11px] tracking-widest hover:bg-rose-100 transition-all flex items-center justify-center gap-2"><i class="fa-solid fa-rotate-right"></i> Restart Kamera</button>`}<button onclick="window.initFinishAttendance()" class="w-full bg-slate-100 text-slate-600 py-5 rounded-2xl font-black uppercase text-[11px] tracking-widest hover:bg-slate-200 transition-all flex items-center justify-center gap-2"><i class="fa-solid fa-check-to-slot"></i> Selesaikan Presensi</button></div></div></div>`;
            }
            
            if (v === 'info') return `<div class="max-w-3xl mx-auto animate-fadeIn h-full overflow-y-auto custom-scroll pr-1 pb-16 text-left"><div class="bg-white rounded-[2.5rem] md:rounded-[3.5rem] p-8 md:p-10 border shadow-sm space-y-12 text-left"><div class="text-center text-center text-center"><div class="w-20 h-20 bg-blue-600 text-white rounded-[2.5rem] flex items-center justify-center text-3xl mx-auto mb-6 shadow-xl animate-bounce text-center"><i class="fa-solid fa-book text-center"></i></div><h4 class="font-bold text-2xl md:text-3xl tracking-tight mb-2 text-slate-800 leading-none text-center">SIJURU <span class="text-blue-600 text-4xl text-center">App</span></h4><p class="text-[11px] text-slate-400 font-bold uppercase tracking-[0.3em] text-center text-center">Otomasi & Digitalisasi Administrasi Kelas</p></div><div class="grid grid-cols-1 md:grid-cols-2 gap-6 md:gap-8 text-left text-left"><div class="bg-slate-50 p-8 md:p-10 rounded-[2.5rem] md:rounded-[3rem] border border-slate-100 relative overflow-hidden group text-left text-left"><div class="absolute top-0 right-0 w-24 h-24 bg-blue-100/50 rounded-bl-[5rem] -mr-10 -mt-10 transition-all group-hover:scale-110"></div><h5 class="font-bold text-blue-600 text-xs mb-4 tracking-widest flex items-center gap-2 text-left text-left text-left text-left"><i class="fa-solid fa-wand-magic-sparkles text-left text-left"></i> Efisiensi Tanpa Batas</h5><p class="text-sm text-slate-600 font-medium leading-relaxed text-left text-left">Dirancang untuk memangkas waktu administratif yang melelahkan. Jurnal Guru PRO memberikan ruang lebih bagi Anda untuk membangun koneksi bermakna dengan setiap murid di kelas.</p></div><div class="bg-gradient-to-br from-blue-600 to-indigo-700 p-8 md:p-10 rounded-[2.5rem] md:rounded-[3rem] text-white shadow-xl text-left text-left text-left"><h5 class="font-bold text-blue-100 text-xs mb-4 tracking-widest text-left text-left">Infrastruktur Sistem</h5><div class="flex items-center gap-4 mb-4 text-left text-left"><span class="text-3xl md:text-4xl font-bold">1.0</span><div class="bg-white/20 px-3 py-1 rounded-full text-[8px] font-bold uppercase tracking-tighter text-center">Stable Release</div></div><p class="text-white/80 text-[10px] font-bold uppercase tracking-widest flex items-center gap-2 text-left text-left text-left"><i class="fa-solid fa-shield-halved text-left"></i> Google Cloud Secure Storage</p></div></div><div class="space-y-8 text-center text-center"><h5 class="font-bold text-slate-800 text-center text-xs tracking-[0.4em] text-center text-center">Core Technology Modules</h5><div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 md:gap-6 text-center text-center">${[{icon: 'fa-database', t: 'Data Core', d: 'Manajemen basis data siswa dan kurikulum dengan presisi tinggi.'},{icon: 'fa-qrcode', t: 'Rapid Scan', d: 'Teknologi presensi QR instan dengan alur otomatis tanpa henti.'},{icon: 'fa-microchip', t: 'Auto Sync', d: 'Integrasi otomatis data presensi ke dalam administrasi harian.'},{icon: 'fa-file-pdf', t: 'Smart Export', d: 'Hasilkan laporan administratif formal dalam hitungan detik.'}].map(item => `<div class="text-center p-6 md:p-8 bg-white border border-slate-50 rounded-[2.5rem] hover:shadow-xl hover:border-blue-100 transition-all duration-300 text-center"><div class="text-blue-600 text-2xl mb-4 text-center text-center"><i class="fa-solid ${item.icon} text-center"></i></div><h6 class="font-bold text-[11px] uppercase mb-2 text-slate-800 text-center">${item.t}</h6><p class="text-[9px] text-slate-400 font-bold leading-relaxed text-center">${item.d}</p></div>`).join('')}</div></div><div class="pt-12 border-t border-slate-100 flex flex-col items-center text-center text-center text-center text-center text-center"><p class="text-[10px] font-bold uppercase text-slate-400 mb-8 tracking-[0.3em] text-center text-center text-center">Developer Partnership</p><div class="flex justify-center gap-4 md:gap-5 mb-12 text-center text-center"><a href="https://instagram.com/mohdrizkkyy" target="_blank" class="w-14 h-14 md:w-16 md:h-16 bg-rose-50 text-rose-500 rounded-[1.5rem] flex items-center justify-center text-2xl md:text-3xl hover:bg-rose-500 hover:text-white transition-all shadow-md text-center text-center"><i class="fa-brands fa-instagram text-center"></i></a><a href="https://tiktok.com/@mohdrizkkyy" target="_blank" class="w-14 h-14 md:w-16 md:h-16 bg-slate-100 text-slate-800 rounded-[1.5rem] flex items-center justify-center text-2xl md:text-3xl hover:bg-slate-800 hover:text-white transition-all shadow-md text-center text-center"><i class="fa-brands fa-tiktok text-center"></i></a><a href="https://youtube.com/@mohdrizkkyy" target="_blank" class="w-14 h-14 md:w-16 md:h-16 bg-rose-100 text-rose-600 rounded-[1.5rem] flex items-center justify-center text-2xl md:text-3xl hover:bg-rose-600 hover:text-white transition-all shadow-md text-center text-center"><i class="fa-brands fa-youtube text-center"></i></a></div><div class="text-center bg-slate-50 py-6 px-10 md:px-12 rounded-[2rem] border text-center text-center"><h5 class="text-sm md:text-base font-bold text-slate-800 font-bold text-center">Mohamad Rizki, S.Pd., Gr.</h5><p class="text-[9px] font-bold text-blue-600 uppercase mt-2 tracking-widest text-center">Innovative Educator & Fullstack System Architect</p></div></div></div></div>`;
            return ``;
        };

        const startApp = async () => { try { await signInAnonymously(auth); onAuthStateChanged(auth, (u) => { window.appState.user = u; window.appState.loading = false; window.renderApp(); }); } catch (e) { window.appState.loading = false; window.renderApp(); } };
        if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', startApp); else startApp();
    </script>
    <style>
        :root { font-size: 13px; }
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: #f8fafc; -webkit-font-smoothing: antialiased; touch-action: manipulation; direction: ltr; margin: 0; padding: 0; }
        .custom-scroll::-webkit-scrollbar { width: 4px; height: 4px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #e2e8f0; border-radius: 10px; }
        .animate-fadeIn { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-slideDown { animation: slideDown 0.4s cubic-bezier(0.34, 1.56, 0.64, 1); }
        @keyframes slideDown { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }
        /* New Popup Animation */
        .animate-popIn { animation: popIn 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); }
        @keyframes popIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        button { text-align: center !important; justify-content: center !important; }
        input, textarea, select { text-align: left !important; }
        #qr-canvas-render canvas, #qr-canvas-render img { margin: 0 auto; display: block; border-radius: 1.25rem; border: 8px solid #f8fafc; max-width: 100%; height: auto; }
        aside { transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1); }
        
        /* Scanner Specific Styles - PERBAIKAN KAMERA TERBALIK & TAMPILAN */
        #reader { width: 100%; height: 100%; position: relative; overflow: hidden; background: #000; }
        
        /* Reset transform agar kamera belakang normal (tidak terbalik atas-bawah/kiri-kanan) */
        #reader video { 
            object-fit: cover !important; 
            width: 100% !important; 
            height: 100% !important; 
            border-radius: 0 !important; 
            transform: none !important; 
        }
        
        /* Khusus kamera depan (selfie), kita mirror secara horizontal saja */
        /* GUNAKAN ID AGAR SPECIFICITY LEBIH TINGGI DARI RULE DI ATAS */
        #reader.mirror-mode video { 
            transform: scaleX(-1) !important; 
        }

        input[type="date"], input[type="month"] { appearance: none; -webkit-appearance: none; }
        @media (min-width: 1024px) { main { transform-origin: top center; } .max-w-7xl { max-width: 1400px; } }
        html, body { height: 100%; width: 100%; overflow: hidden; }
        #root { height: 100%; display: flex; flex-direction: column; }
        th.sticky, td.sticky { background-clip: padding-box; z-index: 20; }
    </style>
</head>
<body class="bg-slate-50 overflow-hidden h-screen h-[100dvh]">
    <div id="root" class="h-full relative z-0"></div>
    <!-- FIXED OVERLAY CONTAINER (Z-Index High, outside root) -->
    <div id="overlay-mount" class="fixed inset-0 z-[99999] pointer-events-none empty:hidden"></div>
    <div id="notif-anchor" class="fixed top-8 left-1/2 -translate-x-1/2 z-[99999] pointer-events-none flex flex-col items-center gap-2 w-full max-w-xs px-6"></div>
</body>
</html>


