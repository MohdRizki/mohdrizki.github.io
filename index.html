<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jurnal Guru & EduScan QR</title>
    
    <!-- CSS & Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
    
    <!-- PDF, QR, and ZIP Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, getDoc, getDocs, addDoc, updateDoc, deleteDoc, query, onSnapshot, where, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- 1. FIREBASE INITIALIZATION ---
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : { apiKey: "" };
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'jurnal-guru-pro';
        
        if (!firebaseConfig.apiKey) firebaseConfig.apiKey = "";

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- 2. GLOBAL STATE ---
        window.appState = {
            currentView: 'dashboard',
            user: null,
            settings: { 
                nama_guru: '', nama_sekolah: '', semester: 'Ganjil', tahun_ajaran: '2024/2025', nip: '', nama_kepsek: '', nip_kepsek: '' 
            },
            students: [],
            mapels: [],
            tps: [],
            journals: [],
            attendance: [], 
            holidays: [], 
            nationalHolidays: [], 
            holidayExceptions: [], 
            selectedKelas: '1',
            selectedJam: '1',
            selectedMapel: '',
            selectedDate: new Date().toISOString().split('T')[0],
            presenceSearch: '',
            reportMonth: new Date().toISOString().slice(0, 7), 
            sidebarCollapsed: false,
            scannerActive: false,
            html5QrCode: null,
            lastScannedText: '',
            lastScannedTime: 0,
            confirmModal: { show: false, title: '', message: '', action: null }
        };

        // --- 3. HELPERS ---
        window.getNamaHari = (dateStr) => {
            if (!dateStr) return '';
            const date = new Date(dateStr);
            const days = ['Minggu', 'Senin', 'Selasa', 'Rabu', 'Kamis', 'Jumat', 'Sabtu'];
            return days[date.getDay()];
        };

        window.formatTanggalLengkap = (dateStr) => {
            if (!dateStr) return '-';
            const hari = window.getNamaHari(dateStr);
            const dateObj = new Date(dateStr);
            const opsi = { year: 'numeric', month: 'long', day: 'numeric' };
            return `${hari}, ${dateObj.toLocaleDateString('id-ID', opsi)}`;
        };

        window.showNotif = (msg, tipe = 'success') => {
            const wadah = document.getElementById('notif-anchor');
            if (!wadah) return;
            const warna = tipe === 'error' ? 'border-rose-500' : (tipe === 'warning' ? 'border-amber-500' : 'border-blue-600');
            const kotakNotif = document.createElement('div');
            kotakNotif.className = `bg-white border-t-4 ${warna} shadow-2xl rounded-2xl p-5 animate-slideDown flex items-center gap-5 font-black min-w-[320px] pointer-events-auto mb-3`;
            kotakNotif.innerHTML = `
                <div class="w-10 h-10 rounded-xl bg-slate-50 flex items-center justify-center text-blue-600 shadow-sm"><i class="fa-solid fa-bell"></i></div>
                <span class="text-[11px] text-slate-800 uppercase tracking-tight leading-none">${msg}</span>
            `;
            wadah.appendChild(kotakNotif);
            setTimeout(() => { 
                if (kotakNotif && kotakNotif.parentNode) {
                    kotakNotif.style.opacity = '0';
                    kotakNotif.style.transform = 'translateY(-20px)';
                    kotakNotif.style.transition = 'all 0.5s ease';
                    setTimeout(() => kotakNotif.remove(), 500);
                }
            }, 3500);
        };

        window.getStatusColor = (st) => {
            switch(st) {
                case 'Hadir': case 'H': return 'bg-blue-600 text-white';
                case 'Sakit': case 'S': return 'bg-amber-500 text-white';
                case 'Izin': case 'I': return 'bg-sky-400 text-white';
                case 'Alpa': case 'A': return 'bg-rose-500 text-white';
                default: return 'bg-slate-100 text-slate-300';
            }
        };

        // --- 4. DATA LOGIC (FIRESTORE) ---
        window.handleSaveSettings = async (e) => {
            e.preventDefault();
            if (!window.appState.user) return;
            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData.entries());
            await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'profile'), data);
            window.showNotif("Profil Berhasil Diperbarui");
        };

        window.handleResetSettings = () => {
            window.openConfirmModal(
                "Reset Profil?",
                "Tindakan ini akan mengosongkan identitas guru, sekolah, dan kepala sekolah secara permanen dari database.",
                async () => {
                    if (!window.appState.user) return;
                    try {
                        const defaultSettings = { 
                            nama_guru: '', nama_sekolah: '', semester: 'Ganjil', tahun_ajaran: '2024/2025', nip: '', nama_kepsek: '', nip_kepsek: '' 
                        };
                        await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'profile'), defaultSettings);
                        window.appState.settings = defaultSettings;
                        window.showNotif("Identitas Berhasil Direset");
                        window.renderApp();
                    } catch (err) {
                        window.showNotif("Gagal mereset pengaturan", "error");
                    }
                }
            );
        };

        window.handleResetAllData = () => {
            window.openConfirmModal(
                "Hapus Seluruh Data?",
                "Tindakan ini akan menghapus SEMUA data presensi, siswa, jurnal, bank materi, dan kalender libur. Profil identitas Anda akan tetap disimpan.",
                async () => {
                    if (!window.appState.user) return;
                    try {
                        const collectionsToClear = ['attendance', 'students', 'journals', 'mapels', 'tps', 'holidays', 'exceptions'];
                        for (const col of collectionsToClear) {
                            const currentData = (col === 'exceptions') ? window.appState.holidayExceptions : window.appState[col];
                            for (const item of currentData) {
                                await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', col, item.id));
                            }
                        }
                        window.showNotif("Seluruh Data Berhasil Dihapus");
                    } catch (err) {
                        window.showNotif("Gagal menghapus seluruh data", "error");
                    }
                }
            );
        };

        window.handlePromoteStudents = () => {
            window.openConfirmModal(
                "Proses Naik Kelas?",
                "Tingkatkan semua kelas siswa (1->2, 2->3, dst). Siswa Kelas 6 akan dihapus karena dianggap lulus. Lanjutkan?",
                async () => {
                    if (!window.appState.user) return;
                    try {
                        const batch = writeBatch(db);
                        for (const student of window.appState.students) {
                            const currentClass = parseInt(student.kelas);
                            const studentRef = doc(db, 'artifacts', appId, 'public', 'data', 'students', student.id);
                            
                            if (currentClass >= 6) {
                                batch.delete(studentRef);
                            } else {
                                batch.update(studentRef, { 
                                    kelas: String(currentClass + 1),
                                    class: String(currentClass + 1)
                                });
                            }
                        }
                        await batch.commit();
                        window.showNotif("Seluruh Siswa Berhasil Naik Kelas");
                    } catch (err) {
                        window.showNotif("Gagal memproses naik kelas", "error");
                        console.error(err);
                    }
                }
            );
        };

        window.handleSaveMapel = async (e) => {
            e.preventDefault();
            if (!window.appState.user) return;
            const nama = e.target.nama_mapel.value;
            await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'mapels'), { nama_mapel: nama, createdAt: new Date().toISOString() });
            e.target.reset();
            window.showNotif("Mata Pelajaran Ditambahkan");
        };

        window.handleSaveTPBulk = async (e) => {
            e.preventDefault();
            if (!window.appState.user) return;
            const formData = new FormData(e.target);
            const mapelId = formData.get('mapel_id');
            const kelas = formData.get('kelas');
            const tps = formData.get('tp_bulk').split('\n').filter(t => t.trim());
            const batch = writeBatch(db);
            tps.forEach(tp => {
                const newRef = doc(collection(db, 'artifacts', appId, 'public', 'data', 'tps'));
                batch.set(newRef, { mapel_id: mapelId, kelas: kelas, tujuan_pembelajaran: tp.trim(), createdAt: new Date().toISOString() });
            });
            await batch.commit();
            e.target.reset();
            window.showNotif("Bank Tujuan Pembelajaran Diperbarui");
        };

        window.handleBulkStudents = async (e) => {
            e.preventDefault();
            if (!window.appState.user) return;
            const formData = new FormData(e.target);
            const kelas = formData.get('grade');
            const names = formData.get('names').split('\n').filter(n => n.trim());
            const batch = writeBatch(db);
            names.forEach(n => {
                const newRef = doc(collection(db, 'artifacts', appId, 'public', 'data', 'students'));
                const nis = String(Date.now() + Math.floor(Math.random()*1000));
                batch.set(newRef, { nama_siswa: n.trim(), name: n.trim(), kelas: kelas, class: kelas, nis: nis });
            });
            await batch.commit();
            e.target.reset();
            window.showNotif(`${names.length} Siswa Berhasil Masuk Database`);
        };

        window.handleSaveJournal = async (e) => {
            e.preventDefault();
            if (!window.appState.user) return;
            const formData = new FormData(e.target);
            const journalData = Object.fromEntries(formData.entries());
            
            const holiday = window.isRedDate(journalData.tanggal);
            if (holiday.isRed) {
                return window.showNotif(`Gagal: Hari libur (${holiday.reason})`, "error");
            }

            const classStudents = window.appState.students.filter(s => String(s.kelas) === String(journalData.kelas_mengajar));
            const classAttendance = window.appState.attendance.filter(a => a.date === journalData.tanggal && String(a.studentClass) === String(journalData.kelas_mengajar));
            
            let h=0, s=0, i=0, a=0;
            const attendanceSummary = {};
            
            classStudents.forEach(stu => {
                const log = classAttendance.find(at => at.studentId === stu.id);
                const status = log ? log.status : 'Alpa';
                attendanceSummary[stu.id] = status;
                if (status === 'Hadir') h++;
                else if (status === 'Sakit') s++;
                else if (status === 'Izin') i++;
                else a++;
            });

            journalData.hadir = h; journalData.sakit = s; journalData.izin = i; journalData.alpa = a;
            journalData.presensiData = attendanceSummary;
            journalData.createdAt = new Date().toISOString();

            await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'journals'), journalData);
            window.showNotif("Jurnal Berhasil Disimpan");
            window.setView('history');
        };

        window.handleSaveHoliday = async (e) => {
            e.preventDefault();
            if (!window.appState.user) return;
            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData.entries());
            await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'holidays'), data);
            e.target.reset();
            window.showNotif("Hari libur ditambahkan");
        };

        window.handleSaveException = async (e) => {
            e.preventDefault();
            if (!window.appState.user) return;
            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData.entries());
            await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'exceptions'), data);
            e.target.reset();
            window.showNotif("Pengecualian hari libur disimpan");
        };

        window.openConfirmModal = (title, msg, action) => {
            window.appState.confirmModal = { show: true, title, message: msg, action };
            window.renderApp();
        };

        window.closeConfirmModal = () => {
            window.appState.confirmModal.show = false;
            window.renderApp();
        };

        window.executeDeletion = async () => {
            if (window.appState.confirmModal.action) {
                await window.appState.confirmModal.action();
            }
            window.closeConfirmModal();
        };

        window.deleteData = async (col, id) => {
            window.openConfirmModal(
                "Konfirmasi Hapus", 
                "Apakah Anda yakin ingin menghapus data ini secara permanen?", 
                async () => {
                    if (!window.appState.user) return;
                    try {
                        await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', col, id));
                        window.showNotif("Data Berhasil Dihapus");
                    } catch (err) {
                        window.showNotif("Gagal menghapus data", "error");
                    }
                }
            );
        };

        // --- 5. ATTENDANCE & HOLIDAY LOGIC ---
        window.isRedDate = (dateStr) => {
            const d = new Date(dateStr);
            const exempted = window.appState.holidayExceptions.find(x => x.date === dateStr);
            if (exempted) return { isRed: false };
            if (d.getDay() === 0) return { isRed: true, reason: "Minggu" };
            const national = window.appState.nationalHolidays.find(x => x.date === dateStr);
            if (national) return { isRed: true, reason: national.name };
            const manual = window.appState.holidays.find(x => x.date === dateStr);
            if (manual) return { isRed: true, reason: manual.reason };
            return { isRed: false };
        };

        window.fetchNationalHolidays = async () => {
            try {
                const year = new Date().getFullYear();
                const res = await fetch(`https://api-harilibur.vercel.app/api?year=${year}`);
                const data = await res.json();
                if (Array.isArray(data)) {
                    window.appState.nationalHolidays = data.map(h => ({
                        date: h.holiday_date,
                        name: h.holiday_name
                    }));
                }
            } catch (e) {
                console.warn("Failed to load automatic holidays.");
            }
        };

        window.markAttendance = async (id, status = 'Hadir') => {
            const today = window.appState.selectedDate;
            const student = window.appState.students.find(s => s.id === id || s.nis === id || s.nama_siswa === id);
            if (!student) return { success: false, msg: "Siswa tidak terdaftar", studentName: "Sistem" };
            const red = window.isRedDate(today);
            if (red.isRed) return { success: false, msg: `Gagal: ${red.reason}`, studentName: student.nama_siswa };
            const existing = window.appState.attendance.find(a => a.studentId === student.id && a.date === today);
            if (existing) {
                if (existing.status === status) return { success: false, msg: "Sudah tercatat", studentName: student.nama_siswa, duplicate: true };
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'attendance', existing.id), { status, timestamp: new Date().toISOString() });
            } else {
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'attendance'), {
                    studentId: student.id, studentName: student.nama_siswa, studentClass: student.kelas,
                    date: today, time: new Date().toLocaleTimeString('id-ID'), status, timestamp: new Date().toISOString()
                });
            }
            return { success: true, msg: `Status ${status} tercatat`, studentName: student.nama_siswa };
        };

        window.startScanner = async () => {
            const reader = document.getElementById('reader');
            if (!reader) return;
            
            if (window.appState.html5QrCode) {
                await window.stopScanner();
            }
            
            window.appState.html5QrCode = new window.Html5Qrcode("reader");
            try {
                await window.appState.html5QrCode.start(
                    { facingMode: "user" }, 
                    { fps: 20, qrbox: { width: 250, height: 250 }, aspectRatio: 1.0 }, 
                    async (text) => {
                        const now = Date.now();
                        if (text === window.appState.lastScannedText && now - window.appState.lastScannedTime < 1500) return;
                        window.appState.lastScannedText = text;
                        window.appState.lastScannedTime = now;
                        const res = await window.markAttendance(text, 'Hadir');
                        if (!res.duplicate) {
                            window.showNotif(`${res.studentName}: ${res.msg}`, res.success ? 'success' : 'warning');
                            if (navigator.vibrate) navigator.vibrate(100);
                        }
                    }
                ).catch(err => {
                    if(err.name !== "AbortError") console.error("Scanner start error:", err);
                });
                window.appState.scannerActive = true;
            } catch (e) { 
                console.warn("Could not start scanner:", e);
            }
        };

        window.stopScanner = async () => {
            if (window.appState.html5QrCode) {
                try {
                    if (window.appState.html5QrCode.isScanning) {
                        await window.appState.html5QrCode.stop();
                    }
                    await window.appState.html5QrCode.clear();
                } catch(e){
                } finally {
                    window.appState.scannerActive = false;
                    window.appState.html5QrCode = null;
                }
            }
        };

        window.showQR = (nis, nama) => {
            const m = document.getElementById('qr-modal');
            const c = document.getElementById('modal-qr-container');
            document.getElementById('modal-student-name').textContent = nama;
            c.innerHTML = "";
            new QRCode(c, { text: nis, width: 200, height: 200 });
            m.classList.remove('hidden');
        };

        window.closeQRModal = () => document.getElementById('qr-modal').classList.add('hidden');

        window.downloadIndividualQR = (nis, nama) => {
            const proc = document.getElementById('bulk-processor');
            proc.innerHTML = "";
            new QRCode(proc, { text: nis, width: 500, height: 500 });
            setTimeout(() => {
                const canvas = proc.querySelector('canvas');
                if (canvas) {
                    const link = document.createElement('a');
                    link.download = `QR_${nama}_${nis}.png`;
                    link.href = canvas.toDataURL("image/png");
                    link.click();
                    window.showNotif("QR Berhasil Diunduh");
                }
            }, 200);
        };

        window.handleBulkZip = async () => {
            if (window.appState.students.length === 0) return window.showNotif("Database siswa kosong", "error");
            const btn = document.getElementById('btn-bulk-zip');
            btn.disabled = true;
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin mr-2"></i> Memproses...';
            try {
                const zip = new JSZip();
                const proc = document.getElementById('bulk-processor');
                for (const s of window.appState.students) {
                    proc.innerHTML = "";
                    new QRCode(proc, { text: s.nis, width: 300, height: 300 });
                    await new Promise(r => setTimeout(r, 400));
                    const canvas = proc.querySelector('canvas');
                    if (canvas) zip.file(`Kelas_${s.kelas}/${s.nama_siswa}_${s.nis}.png`, canvas.toDataURL("image/png").split(',')[1], { base64: true });
                }
                const content = await zip.generateAsync({ type: "blob" });
                const link = document.createElement("a"); link.href = URL.createObjectURL(content); link.download = "Koleksi_QR_Siswa.zip"; link.click();
                window.showNotif("Unduh berkas ZIP Berhasil");
            } catch (e) { window.showNotif("Gagal mengekspor", "error"); }
            finally { btn.disabled = false; btn.innerHTML = '<i class="fa-solid fa-file-zipper mr-2"></i> Ekspor berkas ZIP Kode QR'; }
        };

        // --- 6. EXPORT REPORTS (Dinas Format - Wali Kelas) ---
        window.downloadCSV = () => {
            const [y, m] = window.appState.reportMonth.split('-').map(Number);
            const dim = new Date(y, m, 0).getDate();
            let csv = "Nama,Kelas," + Array.from({length: dim}, (_, i) => i+1).join(",") + ",H,S,I,A\n";
            window.appState.students.sort((a,b)=>a.kelas-b.kelas || a.nama_siswa.localeCompare(b.nama_siswa)).forEach(s => {
                let row = `"${s.nama_siswa}","${s.kelas}"`, h=0, st=0, i=0, a=0;
                for(let k=1; k<=dim; k++){
                    const dStr = `${window.appState.reportMonth}-${String(k).padStart(2,'0')}`;
                    const log = window.appState.attendance.find(at => at.studentId === s.id && at.date === dStr);
                    row += `,${log ? log.status.charAt(0) : ''}`;
                    if(log) { if(log.status==='Hadir') h++; else if(log.status==='Sakit') st++; else if(log.status==='Izin') i++; else a++; }
                }
                csv += `${row},${h},${st},${i},${a}\n`;
            });
            const blob = new Blob([csv], { type: 'text/csv' });
            const link = document.createElement('a'); link.href = URL.createObjectURL(blob); link.download = `Laporan_Bulanan_${window.appState.reportMonth}.csv`; link.click();
        };

        window.downloadPDF = () => {
            const { jsPDF } = window.jspdf;
            const docPdf = new jsPDF('l', 'mm', 'a4');
            const [y, m] = window.appState.reportMonth.split('-').map(Number);
            const dim = new Date(y, m, 0).getDate();
            
            // Header
            docPdf.setFontSize(16);
            docPdf.text(window.appState.settings.nama_sekolah.toUpperCase(), 148, 15, { align: 'center' });
            docPdf.setFontSize(12);
            docPdf.text(`REKAPITULASI PRESENSI SISWA - BULAN ${window.appState.reportMonth}`, 148, 22, { align: 'center' });
            
            // Meta Info
            docPdf.setFontSize(10);
            docPdf.text(`Wali Kelas: ${window.appState.settings.nama_guru}`, 14, 32);
            docPdf.text(`NIP: ${window.appState.settings.nip || '-'}`, 14, 37);
            docPdf.text(`Semester/Tahun: ${window.appState.settings.semester} / ${window.appState.settings.tahun_ajaran}`, 283, 32, { align: 'right' });

            const head = [["Nama", "Kls", ...Array.from({length: dim}, (_, i) => i+1), "H", "S", "I", "A"]];
            const body = window.appState.students.sort((a,b)=>a.kelas-b.kelas || a.nama_siswa.localeCompare(b.nama_siswa)).map(s => {
                let row = [s.nama_siswa, s.kelas], h=0, st=0, i=0, a=0;
                for(let k=1; k<=dim; k++){
                    const dStr = `${window.appState.reportMonth}-${String(k).padStart(2,'0')}`;
                    const log = window.appState.attendance.find(at => at.studentId === s.id && at.date === dStr);
                    row.push(log ? log.status.charAt(0) : '');
                    if(log) { if(log.status==='Hadir') h++; else if(log.status==='Sakit') st++; else if(log.status==='Izin') i++; else a++; }
                }
                return [...row, h, st, i, a];
            });

            docPdf.autoTable({ 
                head: head, 
                body: body, 
                startY: 42, 
                theme: 'grid', 
                styles: { fontSize: 4.5, cellPadding: 0.8 }, 
                headStyles: { fillColor: [51, 51, 51] } 
            });

            // Signature Section
            const finalY = docPdf.lastAutoTable.finalY + 15;
            docPdf.setFontSize(10);
            const todayStr = new Date().toLocaleDateString('id-ID', { day: 'numeric', month: 'long', year: 'numeric' });
            docPdf.text(`Dicetak pada: ${todayStr}`, 14, finalY);
            
            docPdf.text(`Mengetahui,`, 220, finalY + 10);
            docPdf.text(`Kepala Sekolah`, 220, finalY + 15);
            docPdf.text(`Wali Kelas,`, 14, finalY + 15);
            
            docPdf.setFont("helvetica", "bold");
            docPdf.text(window.appState.settings.nama_kepsek, 220, finalY + 40);
            docPdf.text(window.appState.settings.nama_guru, 14, finalY + 40);
            
            docPdf.setFont("helvetica", "normal");
            docPdf.text(`NIP. ${window.appState.settings.nip_kepsek || '-'}`, 220, finalY + 45);
            docPdf.text(`NIP. ${window.appState.settings.nip || '-'}`, 14, finalY + 45);

            docPdf.save(`Rekap_Presensi_${window.appState.reportMonth}.pdf`);
        };

        // --- 6B. EXPORT JOURNAL REPORTS (Dinas Format - Wali Kelas) ---
        window.downloadJournalCSV = () => {
            let csv = "No,Tanggal,Jam,Kelas,Mapel,Tujuan Pembelajaran,H,S,I,A,Catatan\n";
            window.appState.journals.sort((a,b)=>a.tanggal.localeCompare(b.tanggal)).forEach((j, idx) => {
                csv += `${idx+1},"${j.tanggal}","${j.jam_ke}","${j.kelas_mengajar}","${j.mata_pelajaran}","${j.tujuan_pembelajaran}",${j.hadir},${j.sakit},${j.izin},${j.alpa},"${j.catatan || ''}"\n`;
            });
            const blob = new Blob([csv], { type: 'text/csv' });
            const link = document.createElement('a'); link.href = URL.createObjectURL(blob); link.download = `Laporan_Jurnal_Harian.csv`; link.click();
        };

        window.downloadJournalPDF = () => {
            const { jsPDF } = window.jspdf;
            const docPdf = new jsPDF('p', 'mm', 'a4');
            
            // Formal Header
            docPdf.setFontSize(14);
            docPdf.setFont("helvetica", "bold");
            docPdf.text(window.appState.settings.nama_sekolah.toUpperCase(), 105, 15, { align: 'center' });
            docPdf.setFontSize(11);
            docPdf.text(`LAPORAN JURNAL MENGAJAR HARIAN GURU`, 105, 22, { align: 'center' });
            
            // Identitas Guru
            docPdf.setFontSize(10);
            docPdf.setFont("helvetica", "normal");
            docPdf.text(`Wali Kelas`, 14, 35); docPdf.text(`: ${window.appState.settings.nama_guru}`, 45, 35);
            docPdf.text(`NIP`, 14, 40); docPdf.text(`: ${window.appState.settings.nip || '-'}`, 45, 40);
            docPdf.text(`Semester`, 14, 45); docPdf.text(`: ${window.appState.settings.semester}`, 45, 45);
            docPdf.text(`Tahun Ajaran`, 14, 50); docPdf.text(`: ${window.appState.settings.tahun_ajaran}`, 45, 50);

            const head = [["No", "Tanggal", "Jam", "Kls", "Mapel", "Tujuan Pembelajaran", "Presensi"]];
            const body = window.appState.journals.sort((a,b)=>a.tanggal.localeCompare(b.tanggal)).map((j, idx) => [
                idx+1, j.tanggal, j.jam_ke, j.kelas_mengajar, j.mata_pelajaran, j.tujuan_pembelajaran, `${j.hadir}H/${j.sakit}S/${j.izin}I/${j.alpa}A`
            ]);

            docPdf.autoTable({ 
                head: head, 
                body: body, 
                startY: 58, 
                theme: 'grid', 
                styles: { fontSize: 8 }, 
                headStyles: { fillColor: [51, 51, 51] },
                columnStyles: {
                    0: { cellWidth: 10 },
                    1: { cellWidth: 25 },
                    2: { cellWidth: 12 },
                    3: { cellWidth: 12 },
                    4: { cellWidth: 30 },
                    5: { cellWidth: 'auto' },
                    6: { cellWidth: 25 }
                }
            });

            // Signatures
            let finalY = docPdf.lastAutoTable.finalY + 20;
            if (finalY > 250) { docPdf.addPage(); finalY = 20; }
            
            docPdf.text(`Mengetahui,`, 140, finalY);
            docPdf.text(`Kepala Sekolah`, 140, finalY + 5);
            docPdf.text(`Wali Kelas,`, 14, finalY + 5);
            
            docPdf.setFont("helvetica", "bold");
            docPdf.text(window.appState.settings.nama_kepsek, 140, finalY + 30);
            docPdf.text(window.appState.settings.nama_guru, 14, finalY + 30);
            
            docPdf.setFont("helvetica", "normal");
            docPdf.text(`NIP. ${window.appState.settings.nip_kepsek || '-'}`, 140, finalY + 35);
            docPdf.text(`NIP. ${window.appState.settings.nip || '-'}`, 14, finalY + 35);

            docPdf.save(`Jurnal_Mengajar_${window.appState.settings.nama_guru}.pdf`);
        };

        // --- 7. RENDERING VIEWS ---
        window.setView = async (v) => { 
            await window.stopScanner();
            window.appState.currentView = v; 
            window.renderApp(); 
            if (v === 'scanner') {
                const red = window.isRedDate(window.appState.selectedDate);
                if (!red.isRed) setTimeout(() => window.startScanner(), 350);
            }
            lucide.createIcons();
        };

        window.renderNavItem = (view, icon, label, category = false) => {
            const active = window.appState.currentView === view;
            const collapsed = window.appState.sidebarCollapsed;
            if (category) return `<div class="text-[9px] font-black text-slate-400 uppercase tracking-[0.3em] mb-2 px-2 mt-6 transition-opacity ${collapsed ? 'opacity-0' : 'opacity-100'}">${label}</div>`;
            return `<button type="button" onclick="window.setView('${view}')" class="flex items-center gap-4 px-4 py-4 rounded-2xl transition-all duration-300 group ${active ? 'bg-blue-600 text-white shadow-xl shadow-blue-200' : 'text-slate-500 hover:bg-white/40'} border-none text-left w-full outline-none font-bold">
                <div class="min-w-[24px] flex justify-center text-lg transition-transform ${active ? 'scale-110' : 'group-hover:scale-110'}"><i class="fa-solid ${icon}"></i></div>
                <span class="text-[11px] font-extrabold transition-all duration-500 overflow-hidden ${collapsed ? 'max-w-0 opacity-0' : 'max-w-[200px] opacity-100'}">${label}</span>
            </button>`;
        };

        window.renderApp = () => {
            const root = document.getElementById('root');
            if (!root || !window.appState.user) return;
            
            const activeElId = document.activeElement ? document.activeElement.id : null;
            const selectionStart = document.activeElement ? document.activeElement.selectionStart : null;
            const selectionEnd = document.activeElement ? document.activeElement.selectionEnd : null;

            const collapsed = window.appState.sidebarCollapsed;
            const view = window.appState.currentView;

            root.innerHTML = `
                <div class="min-h-screen bg-slate-50 font-['Plus_Jakarta_Sans'] text-slate-900 flex flex-col md:flex-row overflow-x-hidden">
                    <aside id="sidebar" class="hidden md:flex flex-col glass-nav sticky top-0 h-screen transition-all duration-500 z-50 shadow-sm ${collapsed ? 'w-[88px]' : 'w-[280px]'}">
                        <button onclick="window.toggleSidebar()" class="absolute top-10 -right-4 w-8 h-8 bg-white border shadow-xl flex items-center justify-center rounded-full text-slate-400 hover:text-blue-600 transition-all z-[100]">
                            <i class="fa-solid ${collapsed ? 'fa-chevron-right' : 'fa-chevron-left'} text-[10px]"></i>
                        </button>
                        <div class="flex items-center gap-4 px-6 py-10 shrink-0"> 
                            <div class="w-12 h-12 bg-blue-600 rounded-[1.25rem] flex items-center justify-center text-2xl text-white shadow-xl shadow-blue-200 shrink-0"><i class="fa-solid fa-graduation-cap"></i></div> 
                            <div class="transition-all ${collapsed ? 'opacity-0' : 'opacity-100'}">
                                <h1 class="text-xl font-black uppercase tracking-tighter leading-none">Jurnal<span class="text-blue-600">Guru</span></h1>
                                <p class="text-[8px] font-black text-slate-400 tracking-[0.4em] mt-1 uppercase">Sistem Terintegrasi</p>
                            </div>
                        </div>
                        <nav class="flex flex-col gap-2 px-4 flex-grow overflow-y-auto custom-scroll pb-10">
                            ${window.renderNavItem('', '', 'MENU UTAMA', true)}
                            ${window.renderNavItem('dashboard', 'fa-house', 'Panel Beranda')}
                            ${window.renderNavItem('scanner', 'fa-qrcode', 'Pemindai Presensi')}
                            ${window.renderNavItem('input', 'fa-pen-to-square', 'Tulis Jurnal')}
                            ${window.renderNavItem('history', 'fa-clock-rotate-left', 'Arsip Jurnal')}
                            ${window.renderNavItem('', '', 'REKAPITULASI & DATA', true)}
                            ${window.renderNavItem('reports', 'fa-file-invoice', 'Rekap Bulanan')}
                            ${window.renderNavItem('holidays', 'fa-calendar-day', 'Atur Libur')}
                            ${window.renderNavItem('students', 'fa-users', 'Manajemen Siswa')}
                            ${window.renderNavItem('material', 'fa-book-open', 'Bank Materi')}
                            ${window.renderNavItem('settings', 'fa-gear', 'Pengaturan Profil')}
                            ${window.renderNavItem('info', 'fa-circle-info', 'Informasi Kredit')}
                        </nav>
                    </aside>

                    <main class="flex-grow p-6 md:p-12 max-w-[1600px] mx-auto w-full overflow-y-auto h-screen relative custom-scroll">
                        <header class="flex justify-between items-center mb-12">
                            <div class="space-y-1 text-left">
                                <h2 class="text-3xl font-black text-slate-900 tracking-tighter uppercase">${view}</h2>
                                <p class="text-slate-400 text-[10px] font-black uppercase tracking-[0.4em] flex items-center gap-2"><span class="w-4 h-[2px] bg-blue-500"></span> ${window.appState.settings.nama_sekolah || 'Digitalisasi ADM'}</p>
                            </div>
                            <div class="flex items-center gap-4">
                                <a href="https://sites.google.com/guru.sd.belajar.id/reezapps/home" target="_blank" class="bg-blue-600 text-white px-6 py-3 rounded-2xl font-black text-[10px] uppercase tracking-widest flex items-center gap-3 shadow-xl shadow-blue-100 hover:bg-blue-700 transition-all active:scale-95">
                                    <i class="fa-solid fa-house-user"></i> HUB
                                </a>
                            </div>
                        </header>
                        <div id="view-container">
                            ${window.renderCurrentView()}
                        </div>
                    </main>
                </div>
                
                ${window.appState.confirmModal.show ? `
                <div class="fixed inset-0 bg-slate-900/60 flex items-center justify-center z-[2000] p-4 backdrop-blur-md animate-fadeIn">
                    <div class="bg-white p-10 rounded-[2.5rem] text-center max-w-sm w-full shadow-2xl">
                        <div class="w-16 h-16 bg-rose-50 text-rose-500 rounded-2xl flex items-center justify-center text-2xl mx-auto mb-6 shadow-inner"><i class="fa-solid fa-triangle-exclamation"></i></div>
                        <h3 class="font-black text-xl text-slate-800 mb-4 uppercase tracking-tight">${window.appState.confirmModal.title}</h3>
                        <p class="text-slate-500 text-[11px] mb-10 font-bold uppercase tracking-widest leading-relaxed">${window.appState.confirmModal.message}</p>
                        <div class="flex gap-4">
                            <button onclick="window.closeConfirmModal()" class="flex-1 py-4 bg-slate-100 rounded-xl font-black text-slate-500 uppercase text-[10px] tracking-widest">Batal</button>
                            <button onclick="window.executeDeletion()" class="flex-1 py-4 bg-rose-600 rounded-xl font-black text-white uppercase text-[10px] tracking-widest shadow-lg shadow-rose-100">Hapus</button>
                        </div>
                    </div>
                </div>` : ''}

                <div id="qr-modal" class="fixed inset-0 bg-slate-900/60 flex items-center justify-center z-[1000] p-4 backdrop-blur-md hidden">
                    <div class="bg-white p-10 rounded-[3rem] text-center max-w-sm w-full shadow-2xl animate-fadeIn">
                        <h3 id="modal-student-name" class="font-black text-xl text-slate-800 mb-6 uppercase tracking-tight">ID Siswa</h3>
                        <div id="modal-qr-container" class="flex justify-center mb-10 p-6 bg-slate-50 rounded-[2rem] border border-slate-100"></div>
                        <button onclick="window.closeQRModal()" class="w-full py-4 bg-slate-100 rounded-2xl font-black text-slate-600 hover:bg-slate-200 transition-all uppercase text-[11px] tracking-widest">Tutup</button>
                    </div>
                </div>
                
                <div id="bulk-processor" class="hidden"></div>`;

            if (activeElId) {
                const el = document.getElementById(activeElId);
                if (el) {
                    el.focus();
                    if (typeof selectionStart === 'number') {
                        el.setSelectionRange(selectionStart, selectionEnd);
                    }
                }
            }
        };

        window.renderCurrentView = () => {
            const view = window.appState.currentView;
            if (view === 'dashboard') {
                const today = new Date().toISOString().split('T')[0];
                const recentJournals = window.appState.journals.slice(0, 3);
                const attTodayCount = window.appState.attendance.filter(a => a.date === today).length;
                
                return `
                <div class="space-y-10 animate-fadeIn text-left">
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                        <div class="lg:col-span-2 bg-gradient-to-br from-blue-600 to-indigo-900 rounded-[2.5rem] p-10 text-white shadow-2xl relative overflow-hidden flex flex-col justify-center min-h-[240px]">
                            <div class="relative z-10 space-y-6">
                                <div>
                                    <h1 class="text-3xl font-black mb-2">Halo, ${window.appState.settings.nama_guru || 'Rekan Guru'}!</h1>
                                    <p class="text-blue-100 uppercase tracking-widest text-[10px] font-bold"><i class="fa-solid fa-school"></i> ${window.appState.settings.nama_sekolah || 'Digitalisasi ADM'}</p>
                                </div>
                                <div class="bg-white/10 backdrop-blur-md border border-white/20 p-4 rounded-2xl max-w-md">
                                    <p class="text-[10px] italic font-medium leading-relaxed">"Teknologi hanyalah alat. Dalam hal membuat anak-anak bekerja sama dan memotivasi mereka, guru adalah yang paling utama." — Bill Gates</p>
                                </div>
                            </div>
                            <div class="absolute -bottom-10 -right-10 w-64 h-64 bg-white/10 rounded-full blur-3xl"></div>
                        </div>

                        <div class="bg-white rounded-[2.5rem] p-10 border shadow-sm flex flex-col justify-center items-center text-center space-y-4">
                            <div class="w-16 h-16 bg-blue-50 text-blue-600 rounded-2xl flex items-center justify-center text-3xl shadow-inner"><i class="fa-solid fa-calendar-check"></i></div>
                            <div>
                                <h3 class="text-xl font-black text-slate-800">${window.getNamaHari(today)}</h3>
                                <p class="text-[11px] font-bold text-slate-400 uppercase tracking-widest mt-1">${today}</p>
                            </div>
                            <div class="w-full h-[1px] bg-slate-100"></div>
                            <p class="text-[10px] font-black text-blue-600 uppercase tracking-[0.2em]">${window.appState.settings.semester} • ${window.appState.settings.tahun_ajaran}</p>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                        <div class="bg-white p-6 rounded-3xl shadow-sm border flex items-center gap-5 hover:shadow-md transition-all">
                            <div class="w-14 h-14 bg-blue-50 text-blue-600 rounded-2xl flex items-center justify-center text-2xl shadow-inner"><i class="fa-solid fa-book-atlas"></i></div>
                            <div><p class="text-slate-400 text-[10px] font-black uppercase tracking-widest">Total Jurnal</p><h3 class="text-2xl font-black">${window.appState.journals.length}</h3></div>
                        </div>
                        <div class="bg-white p-6 rounded-3xl shadow-sm border flex items-center gap-5 hover:shadow-md transition-all">
                            <div class="w-14 h-14 bg-green-50 text-green-600 rounded-2xl flex items-center justify-center text-2xl shadow-inner"><i class="fa-solid fa-user-check"></i></div>
                            <div><p class="text-slate-400 text-[10px] font-black uppercase tracking-widest">Total Siswa</p><h3 class="text-2xl font-black">${window.appState.students.length}</h3></div>
                        </div>
                        <div class="bg-white p-6 rounded-3xl shadow-sm border flex items-center gap-5 hover:shadow-md transition-all">
                            <div class="w-14 h-14 bg-indigo-50 text-indigo-600 rounded-2xl flex items-center justify-center text-2xl shadow-inner"><i class="fa-solid fa-fingerprint"></i></div>
                            <div><p class="text-slate-400 text-[10px] font-black uppercase tracking-widest">Pindai Hari Ini</p><h3 class="text-2xl font-black">${attTodayCount}</h3></div>
                        </div>
                        <div class="bg-white p-6 rounded-3xl shadow-sm border flex items-center gap-5 hover:shadow-md transition-all">
                            <div class="w-14 h-14 bg-amber-50 text-amber-600 rounded-2xl flex items-center justify-center text-2xl shadow-inner"><i class="fa-solid fa-lightbulb"></i></div>
                            <div><p class="text-slate-400 text-[10px] font-black uppercase tracking-widest">Bank Materi</p><h3 class="text-2xl font-black">${window.appState.tps.length}</h3></div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                        <div class="lg:col-span-1 space-y-6">
                            <h4 class="text-[11px] font-black text-slate-400 uppercase tracking-[0.3em] ml-2">Aksi Cepat</h4>
                            <div class="grid grid-cols-2 gap-4">
                                <button onclick="window.setView('scanner')" class="bg-white p-6 rounded-[2rem] border shadow-sm hover:border-blue-500 hover:text-blue-600 transition-all flex flex-col items-center gap-3">
                                    <div class="w-12 h-12 bg-blue-50 rounded-2xl flex items-center justify-center text-xl"><i class="fa-solid fa-qrcode"></i></div>
                                    <span class="text-[10px] font-black uppercase tracking-widest">Absen QR</span>
                                </button>
                                <button onclick="window.setView('input')" class="bg-white p-6 rounded-[2rem] border shadow-sm hover:border-blue-500 hover:text-blue-600 transition-all flex flex-col items-center gap-3">
                                    <div class="w-12 h-12 bg-blue-50 rounded-2xl flex items-center justify-center text-xl"><i class="fa-solid fa-pen-nib"></i></div>
                                    <span class="text-[10px] font-black uppercase tracking-widest">Isi Jurnal</span>
                                </button>
                                <button onclick="window.setView('reports')" class="bg-white p-6 rounded-[2rem] border shadow-sm hover:border-blue-500 hover:text-blue-600 transition-all flex flex-col items-center gap-3">
                                    <div class="w-12 h-12 bg-blue-50 rounded-2xl flex items-center justify-center text-xl"><i class="fa-solid fa-chart-line"></i></div>
                                    <span class="text-[10px] font-black uppercase tracking-widest">Lihat Rekap</span>
                                </button>
                                <button onclick="window.setView('material')" class="bg-white p-6 rounded-[2rem] border shadow-sm hover:border-blue-500 hover:text-blue-600 transition-all flex flex-col items-center gap-3">
                                    <div class="w-12 h-12 bg-blue-50 rounded-2xl flex items-center justify-center text-xl"><i class="fa-solid fa-layer-group"></i></div>
                                    <span class="text-[10px] font-black uppercase tracking-widest">Bank TP</span>
                                </button>
                            </div>
                        </div>

                        <div class="lg:col-span-2 space-y-6">
                            <div class="flex justify-between items-center ml-2">
                                <h4 class="text-[11px] font-black text-slate-400 uppercase tracking-[0.3em]">Jurnal Terbaru</h4>
                                <button onclick="window.setView('history')" class="text-[9px] font-black text-blue-600 hover:underline uppercase tracking-widest">Lihat Semua</button>
                            </div>
                            <div class="bg-white rounded-[2.5rem] border shadow-sm overflow-hidden">
                                <div class="divide-y">
                                    ${recentJournals.length > 0 ? recentJournals.map(j => `
                                        <div class="p-6 hover:bg-slate-50 transition-all flex items-center gap-5">
                                            <div class="w-12 h-12 bg-slate-100 rounded-2xl flex items-center justify-center font-black text-[10px] text-slate-500">KLS ${j.kelas_mengajar}</div>
                                            <div class="flex-grow">
                                                <h5 class="text-[11px] font-black uppercase text-slate-800">${j.mata_pelajaran}</h5>
                                                <p class="text-[9px] text-slate-400 mt-1 uppercase tracking-tight truncate max-w-[300px]">${j.tujuan_pembelajaran}</p>
                                            </div>
                                            <div class="text-right">
                                                <span class="text-[8px] font-black text-blue-600 uppercase bg-blue-50 px-3 py-1 rounded-full">${j.tanggal.split('-').slice(1).reverse().join('/')}</span>
                                            </div>
                                        </div>
                                    `).join('') : `
                                        <div class="p-20 text-center space-y-4">
                                            <i class="fa-solid fa-ghost text-4xl text-slate-100"></i>
                                            <p class="text-[10px] font-black text-slate-300 uppercase tracking-widest">Belum ada jurnal pengajaran.</p>
                                        </div>
                                    `}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>`;
            }

            if (view === 'input') {
                const currentAtt = window.appState.attendance.filter(a => a.date === window.appState.selectedDate && String(a.studentClass) === String(window.appState.selectedKelas));
                const red = window.isRedDate(window.appState.selectedDate);
                
                const filteredTPs = window.appState.tps.filter(t => 
                    String(t.mapel_id) === String(window.appState.selectedMapel) && 
                    String(t.kelas) === String(window.appState.selectedKelas)
                );

                const searchQ = window.appState.presenceSearch.toLowerCase();
                const filteredStudents = window.appState.students.filter(s => 
                    String(s.kelas) === String(window.appState.selectedKelas) &&
                    s.nama_siswa.toLowerCase().includes(searchQ)
                );

                return `
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 animate-fadeIn text-left">
                    <form onsubmit="window.handleSaveJournal(event)" class="bg-white rounded-[2.5rem] p-8 border shadow-sm space-y-6">
                        <h4 class="font-black text-slate-800 text-xl tracking-tighter uppercase mb-2">Tulis Jurnal KBM</h4>
                        ${red.isRed ? `<div class="bg-rose-50 text-rose-600 p-4 rounded-2xl font-black text-[10px] uppercase tracking-widest border border-rose-100">HARI LIBUR: ${red.reason}</div>` : 
                        '<p class="text-[10px] font-black text-blue-600 uppercase tracking-widest italic mb-4">MENGACU DATA PRESENSI TANGGAL '+window.appState.selectedDate+'</p>'}
                        <div class="grid grid-cols-2 gap-4">
                            <div class="space-y-2"><label class="text-[10px] font-black text-slate-400 uppercase tracking-widest">TANGGAL</label><input type="date" name="tanggal" required value="${window.appState.selectedDate}" onchange="window.appState.selectedDate = this.value; window.renderApp();" class="w-full bg-slate-50 rounded-2xl px-5 py-4 text-[11px] font-black border-2 border-transparent focus:border-blue-100 outline-none transition-all"></div>
                            <div class="space-y-2"><label class="text-[10px] font-black text-slate-400 uppercase tracking-widest">JAM KE-</label><select name="jam_ke" onchange="window.appState.selectedJam = this.value; window.renderApp();" required class="w-full bg-slate-50 rounded-2xl px-5 py-4 text-[11px] font-black border-2 border-transparent focus:border-blue-100 outline-none transition-all"> ${[1,2,3,4,5,6,7,8,9,10].map(j => `<option value="${j}" ${window.appState.selectedJam == j ? 'selected' : ''}>${j}</option>`).join('')} </select></div>
                        </div>
                        <div class="space-y-2"><label class="text-[10px] font-black text-slate-400 uppercase tracking-widest">KELAS</label><select name="kelas_mengajar" onchange="window.appState.selectedKelas = this.value; window.renderApp();" class="w-full bg-slate-50 rounded-2xl px-5 py-4 text-[11px] font-black border-2 border-transparent focus:border-blue-100 outline-none transition-all"> ${[1,2,3,4,5,6].map(k => `<option value="${k}" ${String(k) === String(window.appState.selectedKelas) ? 'selected' : ''}>Kelas ${k}</option>`).join('')} </select></div>
                        <div class="space-y-2"><label class="text-[10px] font-black text-slate-400 uppercase tracking-widest">MATA PELAJARAN</label><select name="mata_pelajaran" required onchange="window.appState.selectedMapel = this.value; window.renderApp();" class="w-full bg-slate-50 rounded-2xl px-5 py-4 text-[11px] font-black border-2 border-transparent focus:border-blue-100 outline-none transition-all"> <option value="">Pilih Mapel</option> ${window.appState.mapels.map(m => `<option value="${m.nama_mapel}" ${window.appState.selectedMapel === m.nama_mapel ? 'selected' : ''}>${m.nama_mapel}</option>`).join('')} </select></div>
                        
                        <div class="space-y-2">
                            <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest">TUJUAN PEMBELAJARAN</label>
                            <input list="tp-bank" id="input-tp-search" name="tujuan_pembelajaran" required placeholder="Ketik atau pilih TP..." class="w-full bg-slate-50 rounded-2xl px-5 py-4 text-[11px] font-black border-2 border-transparent focus:border-blue-100 outline-none transition-all">
                            <datalist id="tp-bank">
                                ${filteredTPs.map(t => `<option value="${t.tujuan_pembelajaran}">`).join('')}
                            </datalist>
                        </div>

                        <div class="space-y-2"><label class="text-[10px] font-black text-slate-400 uppercase tracking-widest">CATATAN</label><textarea id="input-catatan" name="catatan" rows="3" class="w-full bg-slate-50 rounded-2xl p-5 text-[11px] font-black border-2 border-transparent focus:border-blue-100 outline-none transition-all"></textarea></div>
                        <button type="submit" ${red.isRed ? 'disabled' : ''} class="w-full bg-blue-600 text-white py-5 rounded-2xl font-black uppercase text-[11px] tracking-widest shadow-xl hover:bg-blue-700 transition-all disabled:opacity-50">Simpan Jurnal</button>
                    </form>
                    
                    <div class="bg-white rounded-[2.5rem] p-8 border shadow-sm flex flex-col min-h-[500px]">
                        <div class="flex justify-between items-center mb-6">
                            <h4 class="font-black text-slate-800 text-lg uppercase tracking-tight">Status Presensi <span class="text-blue-600 ml-2">Kelas ${window.appState.selectedKelas}</span></h4>
                            <button onclick="window.setView('scanner')" class="text-[9px] font-black text-blue-600 bg-blue-50 px-4 py-2 rounded-xl border border-blue-200">AKTIFKAN PEMINDAI</button>
                        </div>
                        
                        <div class="relative mb-6">
                            <span class="absolute left-4 top-1/2 -translate-y-1/2 text-slate-300 text-xs"><i class="fa-solid fa-magnifying-glass"></i></span>
                            <input type="text" id="student-presence-search" placeholder="Cari nama siswa..." value="${window.appState.presenceSearch}" oninput="window.appState.presenceSearch = this.value; window.renderApp();" class="w-full bg-slate-50 rounded-xl pl-10 pr-4 py-3 text-[10px] font-bold border border-transparent focus:border-blue-200 outline-none transition-all">
                        </div>

                        <div class="space-y-3 flex-grow overflow-y-auto custom-scroll pr-2">
                            ${filteredStudents.map(s => {
                                const log = currentAtt.find(a => a.studentId === s.id);
                                const status = log ? log.status : 'Alpa';
                                return `<div class="flex items-center justify-between p-4 bg-slate-50 rounded-2xl border hover:bg-white transition-all">
                                    <span class="text-[10px] font-black uppercase text-slate-700 truncate w-1/3">${s.nama_siswa}</span>
                                    <div class="flex gap-1.5"> ${['Hadir','Sakit','Izin','Alpa'].map(x => `<button type="button" onclick="window.markAttendance('${s.id}', '${x}')" class="w-10 h-8 rounded-lg font-black text-[8px] transition-all ${status === x ? window.getStatusColor(x) : 'bg-white text-slate-300 border'}">${x.charAt(0)}</button>`).join('')} </div>
                                </div>`;
                            }).join('') || '<p class="text-center py-20 text-[10px] italic text-slate-300 font-black uppercase tracking-widest">Siswa tidak ditemukan.</p>'}
                        </div>
                    </div>
                </div>`;
            }

            if (view === 'history') {
                return `
                <div class="space-y-6 animate-fadeIn text-left">
                    <div class="bg-white rounded-[2.5rem] p-8 border shadow-sm flex flex-col md:flex-row justify-between items-center gap-6">
                        <h4 class="font-black text-slate-800 text-xl tracking-tighter uppercase">Arsip Jurnal Harian</h4>
                        <div class="flex gap-4">
                            <button onclick="window.downloadJournalCSV()" class="bg-indigo-50 text-indigo-600 px-6 py-3 rounded-xl font-black text-[10px] uppercase tracking-widest border hover:bg-indigo-100 transition-all flex items-center"><i class="fa-solid fa-file-csv mr-2"></i> Ekspor CSV</button>
                            <button onclick="window.downloadJournalPDF()" class="bg-rose-50 text-rose-600 px-6 py-3 rounded-xl font-black text-[10px] uppercase tracking-widest border hover:bg-rose-100 transition-all flex items-center"><i class="fa-solid fa-file-pdf mr-2"></i> Ekspor PDF</button>
                        </div>
                    </div>
                    <div class="bg-white rounded-[2.5rem] p-8 border shadow-sm overflow-x-auto">
                        <table class="w-full text-left text-[10px]">
                            <thead class="text-slate-400 uppercase font-black tracking-widest border-b">
                                <tr><th class="py-5 px-3">Tanggal / Jam</th><th class="py-5 px-3">Kelas</th><th class="py-5 px-3">Materi & TP</th><th class="py-5 px-3">Ringkasan Presensi</th><th class="py-5 px-3 text-center">Aksi</th></tr>
                            </thead>
                            <tbody class="divide-y divide-slate-50">
                                ${window.appState.journals.sort((a,b)=>b.tanggal.localeCompare(a.tanggal)).map(j => `
                                    <tr>
                                        <td class="py-5 px-3 font-black text-slate-800">${window.formatTanggalLengkap(j.tanggal)}<br><small class="text-blue-500">Jam ${j.jam_ke}</small></td>
                                        <td class="py-5 px-3 font-black text-slate-800"><span class="bg-indigo-50 px-3 py-1.5 rounded-lg">KLS ${j.kelas_mengajar}</span></td>
                                        <td class="py-5 px-3"><div class="font-black uppercase">${j.mata_pelajaran}</div><div class="text-[9px] text-slate-400 mt-1">${j.tujuan_pembelajaran}</div></td>
                                        <td class="py-5 px-3 font-black"><span class="text-emerald-600">${j.hadir}H</span> / <span class="text-amber-500">${j.sakit}S</span> / <span class="text-sky-500">${j.izin}I</span> / <span class="text-rose-500">${j.alpa}A</span></td>
                                        <td class="py-5 px-3 text-center"><button onclick="window.deleteData('journals', '${j.id}')" class="text-rose-400 hover:text-rose-600"><i class="fa-solid fa-trash-can"></i></button></td>
                                    </tr>`).join('') || '<tr><td colspan="5" class="py-20 text-center text-slate-300 italic font-black uppercase text-[10px]">Belum ada data riwayat.</td></tr>'}
                            </tbody>
                        </table>
                    </div>
                </div>`;
            }

            if (view === 'scanner') return window.renderScanner();
            if (view === 'reports') return window.renderReports();
            
            if (view === 'holidays') {
                return `
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 animate-fadeIn text-left">
                    <div class="space-y-8">
                        <form onsubmit="window.handleSaveHoliday(event)" class="bg-white rounded-[2.5rem] p-10 border shadow-sm space-y-6">
                            <h4 class="font-black text-slate-800 text-xl tracking-tighter uppercase">Tambah Hari Libur Manual</h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <input type="date" name="date" required class="w-full bg-slate-50 rounded-2xl px-6 py-4 text-[11px] font-black border-2 border-transparent focus:border-blue-100 outline-none transition-all">
                                <input type="text" id="holiday-reason-input" name="reason" placeholder="Alasan Libur..." required class="w-full bg-slate-50 rounded-2xl px-6 py-4 text-[11px] font-black border-2 border-transparent focus:border-blue-100 outline-none transition-all">
                            </div>
                            <button type="submit" class="w-full bg-rose-600 text-white py-5 rounded-2xl font-black uppercase text-[11px] shadow-xl hover:bg-rose-700 transition-all">Simpan Hari Libur</button>
                        </form>
                        
                        <form onsubmit="window.handleSaveException(event)" class="bg-white rounded-[2.5rem] p-10 border shadow-sm space-y-6 border-t-8 border-t-emerald-500">
                            <h4 class="font-black text-slate-800 text-xl tracking-tighter uppercase">Tambah Hari Kerja Khusus</h4>
                            <p class="text-[10px] font-bold text-slate-400 leading-relaxed">Gunakan ini agar tanggal tetap bisa dipakai meskipun hari Minggu atau Libur Nasional.</p>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <input type="date" name="date" required class="w-full bg-slate-50 rounded-2xl px-6 py-4 text-[11px] font-black border-2 border-transparent focus:border-blue-100 outline-none transition-all">
                                <input type="text" id="exception-reason-input" name="reason" placeholder="Keterangan..." required class="w-full bg-slate-50 rounded-2xl px-6 py-4 text-[11px] font-black border-2 border-transparent focus:border-blue-100 outline-none transition-all">
                            </div>
                            <button type="submit" class="w-full bg-emerald-600 text-white py-5 rounded-2xl font-black uppercase text-[11px] shadow-xl hover:bg-emerald-700 transition-all">Simpan Pengecualian</button>
                        </form>
                    </div>

                    <div class="space-y-8 overflow-y-auto custom-scroll pr-2 max-h-[800px]">
                        <div class="bg-white rounded-[2.5rem] p-10 border shadow-sm">
                            <h4 class="font-black text-slate-800 text-base uppercase mb-6">Daftar Hari Libur Manual</h4>
                            <table class="w-full text-left text-[11px]">
                                <thead class="text-slate-400 uppercase font-black border-b"><tr><th class="py-4">Tanggal</th><th class="py-4">Alasan</th><th class="py-4 text-center">Opsi</th></tr></thead>
                                <tbody class="divide-y divide-slate-50">
                                    ${window.appState.holidays.map(h => `<tr><td class="py-4 font-black">${h.date}</td><td class="py-4">${h.reason}</td><td class="py-4 text-center"><button onclick="window.deleteData('holidays', '${h.id}')" class="text-rose-400 hover:text-rose-600 transition-all"><i class="fa-solid fa-trash-can"></i></button></td></tr>`).join('') || '<tr><td colspan="3" class="py-10 text-center italic text-slate-300">Kosong.</td></tr>'}
                                </tbody>
                            </table>
                        </div>

                        <div class="bg-white rounded-[2.5rem] p-10 border shadow-sm">
                            <h4 class="font-black text-slate-800 text-base uppercase mb-6">Daftar Hari Kerja Khusus</h4>
                            <table class="w-full text-left text-[11px]">
                                <thead class="text-slate-400 uppercase font-black border-b"><tr><th class="py-4">Tanggal</th><th class="py-4">Ket.</th><th class="py-4 text-center">Opsi</th></tr></thead>
                                <tbody class="divide-y divide-slate-50">
                                    ${window.appState.holidayExceptions.map(e => `<tr><td class="py-4 font-black text-emerald-600">${e.date}</td><td class="py-4">${e.reason}</td><td class="py-4 text-center"><button onclick="window.deleteData('exceptions', '${e.id}')" class="text-rose-400 hover:text-rose-600 transition-all"><i class="fa-solid fa-trash-can"></i></button></td></tr>`).join('') || '<tr><td colspan="3" class="py-10 text-center italic text-slate-300">Kosong.</td></tr>'}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>`;
            }
            
            if (view === 'students') {
                return `
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 animate-fadeIn text-left">
                    <div class="bg-white rounded-[2.5rem] p-8 border shadow-sm h-fit">
                        <h4 class="font-black text-slate-800 text-xl tracking-tighter uppercase mb-8">Pendaftaran Siswa Massal</h4>
                        <form onsubmit="window.handleBulkStudents(event)" class="space-y-6">
                            <select name="grade" required class="w-full bg-slate-50 rounded-2xl px-5 py-4 text-[11px] font-black border-2 border-transparent focus:border-blue-100 outline-none transition-all"> ${[1,2,3,4,5,6].map(v => `<option value="${v}">Kelas ${v}</option>`).join('')} </select>
                            <textarea id="bulk-names-input" name="names" rows="10" required placeholder="Ahmad Subarjo&#10;Budi Santoso" class="w-full bg-slate-50 rounded-2xl px-6 py-5 text-[11px] font-black outline-none border-2 border-transparent focus:border-blue-100 resize-none"></textarea>
                            <button type="submit" class="w-full bg-blue-600 text-white py-5 rounded-2xl font-black uppercase text-[11px] tracking-widest hover:bg-blue-700 shadow-xl transition-all">Sinkronisasi Database</button>
                        </form>
                    </div>
                    <div class="bg-white rounded-[2.5rem] p-8 border shadow-sm overflow-hidden flex flex-col">
                        <div class="flex justify-between items-center mb-8">
                            <h4 class="font-black text-slate-800 text-xl tracking-tighter uppercase">Database Siswa</h4>
                            <button id="btn-bulk-zip" onclick="window.handleBulkZip()" class="bg-emerald-50 text-emerald-600 px-5 py-2.5 rounded-xl font-black text-[10px] uppercase tracking-widest border border-emerald-100 hover:bg-emerald-100 transition-all flex items-center">
                                <i class="fa-solid fa-file-zipper mr-2"></i> Ekspor ZIP
                            </button>
                        </div>
                        <div class="space-y-4 overflow-y-auto custom-scroll pr-2">
                            ${window.appState.students.sort((a,b)=>a.kelas-b.kelas || a.nama_siswa.localeCompare(b.nama_siswa)).map(s => `
                                <div class="flex items-center justify-between p-4 bg-slate-50 border rounded-2xl group transition-all hover:bg-white hover:shadow-md">
                                    <div class="flex items-center gap-4">
                                        <div class="w-10 h-10 bg-white rounded-xl flex items-center justify-center font-black text-[10px] text-blue-600 border">${s.kelas}</div>
                                        <div>
                                            <div class="font-black text-[11px] uppercase tracking-tight text-slate-800">${s.nama_siswa}</div>
                                            <div class="text-[8px] font-black text-slate-400 mt-0.5 tracking-widest">NIS: ${s.nis}</div>
                                        </div>
                                    </div>
                                    <div class="flex gap-2">
                                        <button onclick="window.downloadIndividualQR('${s.nis}', '${s.nama_siswa}')" title="Unduh QR" class="w-9 h-9 flex items-center justify-center bg-white border rounded-xl text-emerald-500 hover:bg-emerald-500 hover:text-white transition-all"><i class="fa-solid fa-download"></i></button>
                                        <button onclick="window.showQR('${s.nis}', '${s.nama_siswa}')" title="Lihat QR" class="w-9 h-9 flex items-center justify-center bg-white border rounded-xl text-blue-500 hover:bg-blue-500 hover:text-white transition-all"><i class="fa-solid fa-qrcode"></i></button>
                                        <button onclick="window.deleteData('students', '${s.id}')" title="Hapus" class="w-9 h-9 flex items-center justify-center bg-white border rounded-xl text-rose-400 hover:bg-rose-500 hover:text-white transition-all"><i class="fa-solid fa-trash-can"></i></button>
                                    </div>
                                </div>`).join('') || '<p class="text-center py-20 text-slate-300 font-black uppercase text-[10px]">Kosong.</p>'}
                        </div>
                    </div>
                </div>`;
            }

            if (view === 'material') {
                return `
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 animate-fadeIn text-left">
                    <div class="bg-white rounded-[2.5rem] p-8 border shadow-sm space-y-8">
                        <h4 class="font-black text-slate-800 text-xl tracking-tighter uppercase">Tambah Mapel</h4>
                        <form onsubmit="window.handleSaveMapel(event)" class="flex gap-3">
                            <input type="text" id="nama-mapel-input" name="nama_mapel" required placeholder="Contoh: Matematika" class="flex-grow bg-slate-50 rounded-2xl px-6 py-4 text-[11px] font-black outline-none border-2 border-transparent focus:border-blue-100 transition-all">
                            <button type="submit" class="bg-blue-600 text-white px-8 rounded-2xl font-black text-[10px] tracking-widest shadow-lg">TAMBAH</button>
                        </form>
                        <form onsubmit="window.handleSaveTPBulk(event)" class="pt-8 border-t space-y-6">
                            <h4 class="font-black text-slate-800 text-lg tracking-tighter uppercase">Tujuan Pembelajaran Massal</h4>
                            <div class="grid grid-cols-2 gap-4">
                                <select name="mapel_id" required class="bg-slate-50 rounded-2xl px-5 py-4 text-[11px] font-black outline-none border-2 border-transparent focus:border-blue-100"> <option value="">Pilih Mapel</option> ${window.appState.mapels.map(m => `<option value="${m.nama_mapel}">${m.nama_mapel}</option>`).join('')} </select>
                                <select name="kelas" required class="bg-slate-50 rounded-2xl px-5 py-4 text-[11px] font-black outline-none border-2 border-transparent focus:border-blue-100"> ${[1,2,3,4,5,6].map(k => `<option value="${k}">Kelas ${k}</option>`).join('')} </select>
                            </div>
                            <textarea id="tp-bulk-input" name="tp_bulk" required rows="8" placeholder="Ketik rincian TP per baris..." class="w-full bg-slate-50 rounded-2xl p-6 text-[11px] font-black outline-none border-2 border-transparent focus:border-blue-100 resize-none"></textarea>
                            <button type="submit" class="w-full bg-slate-900 text-white py-5 rounded-2xl font-black uppercase text-[11px] tracking-widest shadow-xl">Simpan Bank TP</button>
                        </form>
                    </div>
                    <div class="bg-white rounded-[2.5rem] p-8 border shadow-sm flex flex-col max-h-[750px] overflow-hidden">
                        <h4 class="font-black text-slate-800 text-xl tracking-tighter uppercase mb-8">Daftar Bank TP</h4>
                        <div class="space-y-6 overflow-y-auto custom-scroll pr-2">
                            ${window.appState.mapels.map(m => `
                                <div class="space-y-3">
                                    <div class="flex justify-between items-center bg-blue-50 px-5 py-3 rounded-2xl text-[11px] font-black text-blue-700 uppercase"><span>${m.nama_mapel}</span><button onclick="window.deleteData('mapels', '${m.id}')" class="text-rose-400"><i class="fa-solid fa-trash-can"></i></button></div>
                                    <div class="pl-4 space-y-2"> ${window.appState.tps.filter(t => t.mapel_id === m.nama_mapel).map(t => `<div class="flex justify-between items-start gap-4 p-3 hover:bg-slate-50 rounded-2xl group transition-all"><p class="text-[10px] text-slate-500 font-bold uppercase leading-relaxed"><span class="bg-slate-200 text-slate-600 px-2 py-0.5 rounded text-[8px] mr-2 font-black">KLS ${t.kelas}</span> ${t.tujuan_pembelajaran}</p><button onclick="window.deleteData('tps', '${t.id}')" class="opacity-0 group-hover:opacity-100 text-rose-300 transition-all"><i class="fa-solid fa-trash-can"></i></button></div>`).join('') || '<p class="text-[9px] text-slate-300 italic px-4">Belum ada TP.</p>'} </div>
                                </div>`).join('') || '<p class="text-center py-20 text-slate-300 font-black uppercase text-[10px]">Kosong.</p>'}
                        </div>
                    </div>
                </div>`;
            }

            if (view === 'settings') {
                return `
                <div class="max-w-2xl mx-auto text-left animate-fadeIn space-y-8">
                    <!-- Identity Settings -->
                    <form onsubmit="window.handleSaveSettings(event)" class="bg-white rounded-[2.5rem] p-10 border shadow-sm space-y-8">
                        <div class="flex justify-between items-center mb-4">
                            <h4 class="font-black text-slate-800 text-xl tracking-tighter uppercase">Pengaturan Profil Identitas</h4>
                            <button type="button" onclick="window.handleResetSettings()" class="text-[9px] font-black text-amber-600 bg-amber-50 px-4 py-2 rounded-xl border border-amber-100 hover:bg-amber-100 transition-all">RESET PROFIL</button>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="space-y-2"><label class="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">NAMA WALI KELAS</label><input type="text" id="setting-nama-guru" name="nama_guru" value="${window.appState.settings.nama_guru}" required class="w-full bg-slate-50 rounded-2xl px-6 py-4 text-[11px] font-black outline-none border-2 border-transparent focus:border-blue-100 transition-all"></div>
                            <div class="space-y-2"><label class="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">NIP WALI KELAS</label><input type="text" id="setting-nip-guru" name="nip" value="${window.appState.settings.nip}" class="w-full bg-slate-50 rounded-2xl px-6 py-4 text-[11px] font-black outline-none border-2 border-transparent focus:border-blue-100 transition-all"></div>
                        </div>
                        <div class="space-y-2"><label class="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">NAMA SEKOLAH</label><input type="text" id="setting-nama-sekolah" name="nama_sekolah" value="${window.appState.settings.nama_sekolah}" required class="w-full bg-slate-50 rounded-2xl px-6 py-4 text-[11px] font-black outline-none border-2 border-transparent focus:border-blue-100 transition-all"></div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="space-y-2"><label class="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">NAMA KEPALA SEKOLAH</label><input type="text" id="setting-nama-kepsek" name="nama_kepsek" value="${window.appState.settings.nama_kepsek || ''}" class="w-full bg-slate-50 rounded-2xl px-6 py-4 text-[11px] font-black outline-none border-2 border-transparent focus:border-blue-100 transition-all"></div>
                            <div class="space-y-2"><label class="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">NIP KEPALA SEKOLAH</label><input type="text" id="setting-nip-kepsek" name="nip_kepsek" value="${window.appState.settings.nip_kepsek || ''}" class="w-full bg-slate-50 rounded-2xl px-6 py-4 text-[11px] font-black outline-none border-2 border-transparent focus:border-blue-100 transition-all"></div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="space-y-2"><label class="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">SEMESTER</label><select name="semester" class="w-full bg-slate-50 rounded-2xl px-6 py-4 text-[11px] font-black outline-none border-2 border-transparent focus:border-blue-100"> <option value="Ganjil" ${window.appState.settings.semester==='Ganjil'?'selected':''}>Ganjil</option><option value="Genap" ${window.appState.settings.semester==='Genap'?'selected':''}>Genap</option> </select></div>
                            <div class="space-y-2"><label class="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">TAHUN AJARAN</label><input type="text" id="setting-tahun-ajaran" name="tahun_ajaran" value="${window.appState.settings.tahun_ajaran}" class="w-full bg-slate-50 rounded-2xl px-6 py-4 text-[11px] font-black outline-none border-2 border-transparent focus:border-blue-100 transition-all"></div>
                        </div>
                        <button type="submit" class="w-full bg-blue-600 text-white py-5 rounded-2xl font-black uppercase text-[11px] tracking-widest shadow-xl hover:bg-blue-700 transition-all">Simpan Perubahan Profil</button>
                    </form>

                    <!-- Danger Zone / Data Management -->
                    <div class="bg-white rounded-[2.5rem] p-10 border shadow-sm space-y-6">
                        <h4 class="font-black text-slate-800 text-xl tracking-tighter uppercase mb-4">Pengelolaan Data Massal</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <button onclick="window.handlePromoteStudents()" class="p-6 bg-slate-50 border border-blue-100 rounded-3xl text-left hover:bg-blue-50 transition-all group">
                                <div class="w-12 h-12 bg-white rounded-2xl flex items-center justify-center text-blue-600 shadow-sm mb-4 group-hover:scale-110 transition-transform"><i class="fa-solid fa-angles-up"></i></div>
                                <h5 class="font-black text-[11px] text-slate-800 uppercase tracking-tight">Proses Naik Kelas</h5>
                                <p class="text-[9px] text-slate-400 mt-2 font-bold leading-relaxed">Tingkatkan level kelas semua siswa (1->2, 2->3, dll). Siswa Kelas 6 akan otomatis dihapus.</p>
                            </button>
                            <button onclick="window.handleResetAllData()" class="p-6 bg-slate-50 border border-rose-100 rounded-3xl text-left hover:bg-rose-50 transition-all group">
                                <div class="w-12 h-12 bg-white rounded-2xl flex items-center justify-center text-rose-600 shadow-sm mb-4 group-hover:scale-110 transition-transform"><i class="fa-solid fa-trash-can"></i></div>
                                <h5 class="font-black text-[11px] text-slate-800 uppercase tracking-tight">Hapus Seluruh Data</h5>
                                <p class="text-[9px] text-slate-400 mt-2 font-bold leading-relaxed">Menghapus semua data input (Siswa, Jurnal, Absensi, TP). Profil Identitas tetap aman.</p>
                            </button>
                        </div>
                    </div>
                </div>`;
            }

            if (view === 'info') {
                return `
                <div class="max-w-2xl mx-auto text-center animate-fadeIn space-y-8 text-left">
                    <div class="bg-white rounded-[2.5rem] p-12 border shadow-sm">
                        <div class="w-24 h-24 bg-blue-50 text-blue-600 rounded-[2rem] flex items-center justify-center text-4xl mx-auto mb-8 shadow-inner"><i class="fa-solid fa-code"></i></div>
                        <h4 class="font-black text-slate-800 text-2xl tracking-tighter uppercase mb-2 text-center">Informasi Kredit Sistem</h4>
                        <p class="text-slate-400 text-[10px] font-black uppercase tracking-[0.3em] mb-8 text-center">Versi Terintegrasi 2.0</p>
                        <div class="bg-slate-50 rounded-3xl p-8 border border-slate-100 text-left space-y-4">
                            <div class="flex justify-between items-center border-b pb-4 border-slate-200">
                                <span class="text-[10px] font-black text-slate-400 uppercase">Pengembang Utama</span>
                                <span class="text-sm font-black text-slate-800 text-right">Mohamad Rizki, S.Pd., Gr.</span>
                            </div>
                            <div class="flex justify-between items-center border-b pb-4 border-slate-200">
                                <span class="text-[10px] font-black text-slate-400 uppercase">Mesin Kecerdasan</span>
                                <span class="text-sm font-black text-slate-800">Gemini 2.5 Flash Preview</span>
                            </div>
                            <div class="flex justify-between items-center border-b pb-4 border-slate-200">
                                <span class="text-[10px] font-black text-slate-400 uppercase">Teknologi Web</span>
                                <span class="text-sm font-black text-slate-800">Tailwind CSS & Firebase</span>
                            </div>
                            <div class="pt-4">
                                <p class="text-[10px] text-slate-400 leading-relaxed font-medium">Sistem ini dirancang untuk mendigitalisasi administrasi guru melalui integrasi jurnal harian dan presensi QR Code otomatis.</p>
                            </div>
                        </div>
                    </div>
                </div>`;
            }

            return '<div class="p-20 text-center font-black">Sistem sedang menyiapkan modul...</div>';
        };

        window.renderScanner = () => {
            const red = window.isRedDate(window.appState.selectedDate);
            return `
            <div class="max-w-xl mx-auto animate-fadeIn text-center space-y-6">
                <div class="bg-white rounded-[2.5rem] p-10 border shadow-sm">
                    <h4 class="font-black text-slate-800 text-xl tracking-tighter uppercase mb-2">Pemindai Presensi</h4>
                    <p class="text-slate-400 text-[10px] font-black uppercase tracking-widest mb-8">Pilih Tanggal & Pindai Kode QR</p>
                    <input type="date" value="${window.appState.selectedDate}" onchange="window.appState.selectedDate = this.value; window.renderApp();" class="mb-6 w-full bg-slate-50 rounded-2xl px-6 py-4 text-[11px] font-black border-2 border-blue-100 outline-none">
                    ${red.isRed ? `<div class="bg-rose-50 text-rose-600 p-8 rounded-3xl font-black text-xs uppercase tracking-widest border border-rose-200">HARI LIBUR: ${red.reason}<br><small class="mt-2 block opacity-60">Sistem Pemindai Dimatikan Otomatis</small></div>` : `
                    <div id="reader" class="overflow-hidden rounded-[2rem] bg-slate-900 aspect-square w-full border-8 border-white shadow-2xl mirrored-video"></div>
                    <button onclick="window.startScanner()" class="mt-8 w-full bg-blue-600 text-white py-4 rounded-2xl font-black uppercase text-[11px] tracking-widest hover:bg-blue-700 transition-all">Aktifkan Kamera</button>`}
                </div>
            </div>`;
        };

        window.renderReports = () => {
            const [y, m] = window.appState.reportMonth.split('-').map(Number);
            const dim = new Date(y, m, 0).getDate();
            return `
            <div class="space-y-6 animate-fadeIn text-left">
                <div class="bg-white rounded-[2.5rem] p-8 border shadow-sm flex flex-col md:flex-row justify-between items-center gap-6">
                    <div>
                        <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">PILIH BULAN REKAPITULASI PRESENSI</label>
                        <input type="month" value="${window.appState.reportMonth}" onchange="window.appState.reportMonth = this.value; window.renderApp();" class="mt-2 block w-full bg-slate-50 rounded-xl px-4 py-3 text-sm font-black outline-none border-2 border-transparent focus:border-blue-100 transition-all">
                    </div>
                    <div class="flex gap-4">
                        <button onclick="window.downloadCSV()" class="bg-emerald-50 text-emerald-600 px-6 py-3 rounded-xl font-black text-[10px] uppercase tracking-widest border hover:bg-emerald-100 transition-all flex items-center"><i class="fa-solid fa-file-csv mr-2"></i> CSV</button>
                        <button onclick="window.downloadPDF()" class="bg-rose-50 text-rose-600 px-6 py-3 rounded-xl font-black text-[10px] uppercase tracking-widest border hover:bg-rose-100 transition-all flex items-center"><i class="fa-solid fa-file-pdf mr-2"></i> PDF</button>
                    </div>
                </div>
                <div class="bg-white rounded-[2rem] border shadow-sm overflow-x-auto p-2">
                    <table class="w-full text-left text-[9px] border-collapse report-table">
                        <thead class="bg-slate-50 uppercase font-black text-slate-400 tracking-tighter">
                            <tr>
                                <th class="px-4 py-4 sticky-col bg-slate-50">Nama Siswa</th>
                                ${Array.from({length: dim}, (_, i) => `<th class="px-1 text-center">${i+1}</th>`).join('')}
                                <th class="px-2 text-emerald-600 text-center">H</th><th class="px-2 text-rose-600 text-center">A</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-slate-50">
                            ${window.appState.students.sort((a,b)=>a.kelas-b.kelas || a.nama_siswa.localeCompare(b.nama_siswa)).map(s => {
                                const sAtt = window.appState.attendance.filter(a => a.studentId === s.id && a.date.startsWith(window.appState.reportMonth));
                                let hCount=0, aCount=0;
                                return `<tr>
                                    <td class="px-4 py-3 font-black text-slate-800 sticky-col bg-white border-r">${s.nama_siswa}</td>
                                    ${Array.from({length: dim}, (_, i) => {
                                        const dStr = `${window.appState.reportMonth}-${String(i+1).padStart(2,'0')}`;
                                        const log = sAtt.find(a => a.date === dStr);
                                        const isRed = window.isRedDate(dStr).isRed;
                                        if (log) { if(log.status === 'Hadir') hCount++; else aCount++; }
                                        return `<td class="text-center p-1 ${isRed ? 'bg-rose-50/30' : ''}">${log ? (log.status === 'Hadir' ? 'H' : log.status.charAt(0)) : ''}</td>`;
                                    }).join('')}
                                    <td class="text-center font-black text-emerald-600 bg-emerald-50/30">${hCount}</td>
                                    <td class="text-center font-black text-rose-600 bg-rose-50/30">${aCount}</td>
                                </tr>`;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            </div>`;
        };

        // --- 8. STARTUP ---
        const startApp = async () => {
            const initAuth = async () => {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            };
            
            await initAuth();
            await window.fetchNationalHolidays();

            onAuthStateChanged(auth, (u) => { 
                window.appState.user = u; 
                if (u) {
                    const baseRef = (col) => collection(db, 'artifacts', appId, 'public', 'data', col);
                    
                    const handleError = (e) => console.error("Firestore error:", e);
                    
                    onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'profile'), (snap) => { 
                        if (snap.exists()) { window.appState.settings = snap.data(); window.renderApp(); } 
                    }, handleError);
                    
                    onSnapshot(baseRef('students'), (snap) => { window.appState.students = snap.docs.map(d => ({ id: d.id, ...d.data() })); window.renderApp(); }, handleError);
                    onSnapshot(baseRef('journals'), (snap) => { window.appState.journals = snap.docs.map(d => ({ id: d.id, ...d.data() })); window.renderApp(); }, handleError);
                    onSnapshot(baseRef('attendance'), (snap) => { window.appState.attendance = snap.docs.map(d => ({ id: d.id, ...d.data() })); window.renderApp(); }, handleError);
                    onSnapshot(baseRef('holidays'), (snap) => { window.appState.holidays = snap.docs.map(d => ({ id: d.id, ...d.data() })); window.renderApp(); }, handleError);
                    onSnapshot(baseRef('exceptions'), (snap) => { window.appState.holidayExceptions = snap.docs.map(d => ({ id: d.id, ...d.data() })); window.renderApp(); }, handleError);
                    onSnapshot(baseRef('mapels'), (snap) => { window.appState.mapels = snap.docs.map(d => ({ id: d.id, ...d.data() })); window.renderApp(); }, handleError);
                    onSnapshot(baseRef('tps'), (snap) => { window.appState.tps = snap.docs.map(d => ({ id: d.id, ...d.data() })); window.renderApp(); }, handleError);
                }
                window.renderApp();
            });
        };

        window.toggleSidebar = () => { window.appState.sidebarCollapsed = !window.appState.sidebarCollapsed; window.renderApp(); };

        if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', startApp); else startApp();
    </script>
    <style>
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: #f8fafc; overflow: hidden; }
        .glass-nav { background: rgba(255, 255, 255, 0.6) !important; backdrop-filter: blur(20px); border-right: 1px solid rgba(255, 255, 255, 0.2); }
        .report-table th, .report-table td { min-width: 35px; text-align: center; border: 1px solid #f1f5f9; padding: 0.5rem 0.2rem; }
        .report-table .sticky-col { position: sticky; left: 0; background: white; z-index: 20; min-width: 140px; text-align: left; padding-left: 0.75rem; box-shadow: 2px 0 5px -2px rgba(0,0,0,0.05); }
        .animate-fadeIn { animation: fadeIn 0.5s ease-out; }
        .animate-slideDown { animation: slideDown 0.4s cubic-bezier(0.34, 1.56, 0.64, 1); }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes slideDown { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }
        .custom-scroll::-webkit-scrollbar { width: 4px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .mirrored-video video { transform: scaleX(-1); object-fit: cover !important; }
    </style>
</head>
<body class="bg-slate-50">
    <div id="root"></div>
    <div id="notif-anchor" class="fixed top-8 left-1/2 -translate-x-1/2 z-[9999] pointer-events-none flex flex-col items-center gap-3"></div>
</body>
</html>